import{G as k,p as y}from"./pdfjs-BnRl7pXp.js";import{P as A}from"./pdf-document-manager-Db1U5Tm6.js";async function P(o){try{const e=await fetch(`/api/pdf/page/${o}/context`,{headers:{Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}});if(!e.ok)return console.warn("‚ö†Ô∏è Failed to load context data:",e.statusText),null;const n=await e.json();return n.success?(console.log("‚úÖ Loaded context data:",n.context.rooms.length,"rooms,",n.context.room_locations.length,"locations,",n.context.cabinet_runs.length,"runs,",n.context.cabinets.length,"cabinets"),n.context):(console.warn("‚ö†Ô∏è Context API returned error:",n.error),null)}catch(e){return console.error("Failed to load annotation context:",e),null}}async function _(o){try{const e=await fetch(`/api/pdf/page/${o}/annotations`,{headers:{Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}});if(!e.ok)return console.warn("‚ö†Ô∏è No existing annotations found"),{annotations:[],lastModified:null};const n=await e.json();return console.log("‚úÖ Loaded existing annotations:",n.annotations.length),{annotations:n.annotations||[],lastModified:n.last_modified||null}}catch(e){return console.error("Failed to load existing annotations:",e),{annotations:[],lastModified:null}}}async function T(o){var e;try{const n=await fetch(`/api/pdf/annotations/page/${o}/cabinet-runs`,{headers:{Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}});if(!n.ok)return console.warn("‚ö†Ô∏è Failed to load cabinet runs"),[];const a=await n.json();return console.log("‚úÖ Loaded cabinet runs:",((e=a.cabinet_runs)==null?void 0:e.length)||0),a.cabinet_runs||[]}catch(n){return console.error("Failed to load cabinet runs:",n),[]}}async function x(o){try{const e=await fetch(`/api/pdf/page/${o}/project-number`,{headers:{Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}});if(!e.ok)return console.warn("‚ö†Ô∏è Failed to load project number, using default"),"TFW-0001";const n=await e.json();return console.log("‚úÖ Loaded project number:",n.project_number),n.project_number||"TFW-0001"}catch(e){return console.error("Failed to load project number:",e),"TFW-0001"}}async function D(o){try{const e=await fetch(`/api/pdf/page/${o}/project-context`,{headers:{Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}});if(!e.ok)return console.warn("‚ö†Ô∏è Failed to load project context"),null;const n=await e.json();return n.success?(console.log("‚úÖ Loaded project context for cover page auto-population"),n.project_context):(console.warn("‚ö†Ô∏è Project context API returned error:",n.error),null)}catch(e){return console.error("Failed to load project context:",e),null}}async function L(o){try{const[e,n,a,r,i]=await Promise.all([P(o),_(o),T(o),x(o),D(o)]);return{rooms:(e==null?void 0:e.rooms)||[],roomLocations:(e==null?void 0:e.room_locations)||[],cabinets:(e==null?void 0:e.cabinets)||[],cabinetRuns:a,projectId:(e==null?void 0:e.project_id)||null,projectName:(e==null?void 0:e.project_name)||"",projectNumber:r,annotations:n.annotations||[],annotationsLastModified:n.lastModified,projectContext:i}}catch(e){return console.error("Failed to load all metadata:",e),{rooms:[],roomLocations:[],cabinets:[],cabinetRuns:[],projectId:null,projectName:"",projectNumber:"TFW-0001",annotations:[],annotationsLastModified:null,projectContext:null}}}function R(){return{filterRoomLocations(o,e){return!o||!e?[]:e.filter(n=>n.room_id==o)},filterCabinetRuns(o,e){return!o||!e?[]:e.filter(n=>n.room_location_id==o)},filterCabinets(o,e){return!o||!e?[]:e.filter(n=>n.cabinet_run_id==o)},resetChildSelections(){return{selectedRoomLocationId:null,selectedCabinetRunId:null,selectedCabinetId:null,filteredRoomLocations:[],filteredCabinetRuns:[],filteredCabinets:[]}}}}async function M(o,e,n,a){try{const r=j(n,a),i=e.map(t=>({...t,annotation_type:n,context:r})),d=await fetch(`/api/pdf/page/${o}/annotations`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({annotations:i,create_entities:!0})});if(!d.ok){const t=await d.json();throw new Error(t.error||"Failed to save annotations")}const c=await d.json();if(!c.success)throw new Error(c.error||"Save operation failed");return console.log("‚úÖ Saved",c.count,"annotations"),console.log("‚úÖ Created",c.entities_created_count,"entities"),c.created_entities&&c.created_entities.length>0&&c.created_entities.forEach(t=>{console.log(`   - ${t.entity_type}: ${t.entity.name||t.entity.cabinet_number}`)}),c}catch(r){throw console.error("Failed to save annotations:",r),r}}function j(o,e){const n={};switch(o){case"room":break;case"room_location":e.selectedRoomId&&(n.room_id=e.selectedRoomId,n.location_type=e.locationType||"wall",n.sequence=e.sequence||0);break;case"cabinet_run":e.selectedRoomId&&e.selectedRoomLocationId&&(n.room_id=e.selectedRoomId,n.room_location_id=e.selectedRoomLocationId,n.run_type=e.selectedRunType||"base");break;case"cabinet":e.selectedCabinetRunId&&(n.cabinet_run_id=e.selectedCabinetRunId,n.position_in_run=e.positionInRun||0,n.length_inches=e.lengthInches||0,n.width_inches=e.widthInches||0,n.depth_inches=e.depthInches||0,n.height_inches=e.heightInches||0);break;case"dimension":e.selectedCabinetId&&(n.cabinet_id=e.selectedCabinetId,n.length_inches=e.lengthInches,n.width_inches=e.widthInches,n.depth_inches=e.depthInches,n.height_inches=e.heightInches);break}return n}function $(){return{async renderCanvas(o,e,n,a,r,i){if(!o)return;const d=a*r,c=o.getViewport({scale:d,rotation:i});e.width=c.width,e.height=c.height,n.width=c.width,n.height=c.height;const t={canvasContext:e.getContext("2d"),viewport:c};await o.render(t).promise},calculateFitToPage(o,e,n,a){if(!o)return 1;const r=o.getViewport({scale:1,rotation:a}),i=e.clientHeight-100,c=(e.clientWidth-100)/r.width,t=i/r.height;return Math.min(c,t)/n},calculateFitToWidth(o,e,n,a){if(!o)return 1;const r=o.getViewport({scale:1,rotation:a});return(e.clientWidth-100)/r.width/n},calculateFitToHeight(o,e,n,a){if(!o)return 1;const r=o.getViewport({scale:1,rotation:a});return(e.clientHeight-100)/r.height/n},zoomIn(o,e=.25,n=3){return Math.min(o+e,n)},zoomOut(o,e=.25,n=.5){return Math.max(o-e,n)},resetZoom(){return 1},rotateClockwise(o){return(o+90)%360},rotateCounterClockwise(o){return(o-90+360)%360},resetView(){return{zoomLevel:1,rotation:0}},saveView(o,e,n){return{zoomLevel:o,rotation:e,pageNum:n}},async loadPdfPage(o,e,n){var r;const a=((r=window.PDFDocumentManager)==null?void 0:r.getInstance())||window.pdfManager;if(a){const i=await a.getDocument(e),d=i.numPages,c=await i.getPage(n);return{pdfDocument:i,pdfPage:c,totalPages:d}}else{console.warn("‚ö†Ô∏è PDF manager not available, using fallback direct load");const d=await o.getDocument(e).promise,c=d.numPages,t=await d.getPage(n);return{pdfDocument:d,pdfPage:t,totalPages:c}}},calculateBaseScale(o,e=384,n=100){return(window.innerWidth-e-n)/o.width}}}function F(){return{startDrawing(o,e,n){if(n!=="rectangle")return null;const a=e.getBoundingClientRect();return{isDrawing:!0,startX:o.clientX-a.left,startY:o.clientY-a.top}},drawPreview(o,e,n,a,r){if(!n.isDrawing)return;const i=e.getBoundingClientRect(),d=o.clientX-i.left,c=o.clientY-i.top;r(a,e);const t=e.getContext("2d");t.strokeStyle="#3B82F6",t.lineWidth=3,t.strokeRect(n.startX,n.startY,d-n.startX,c-n.startY)},stopDrawing(o,e,n,a,r){if(!n.isDrawing)return null;const i=e.getBoundingClientRect(),d=o.clientX-i.left,c=o.clientY-i.top,t=d-n.startX,s=c-n.startY;if(Math.abs(t)<10||Math.abs(s)<10)return null;const l=this.getAnnotationColor(a.annotationType,a.roomType,a.roomColors),h=this.generateLabel(a.annotationType,a.roomType,a.projectNumber,a.roomCodes,r.length);return{id:Date.now(),x:Math.min(n.startX,d)/e.width,y:Math.min(n.startY,c)/e.height,width:Math.abs(t)/e.width,height:Math.abs(s)/e.height,text:h,room_type:a.roomType||"",cabinet_run_id:"",room_id:"",notes:"",color:l,annotation_type:a.annotationType||"room"}},getAnnotationColor(o,e,n){return o==="room"&&e&&n[e]?n[e]:{room:"#3B82F6",room_location:"#10B981",cabinet_run:"#F59E0B",cabinet:"#EF4444",dimension:"#8B5CF6"}[o]||"#3B82F6"},generateLabel(o,e,n,a,r){if(o==="room"&&e&&a[e]){const d=a[e];return n?`${n}-${d}`:d}const i=r+1;return n?`${n}-${i}`:`Label ${i}`},redrawAnnotations(o,e,n=null){if(!e)return;const a=e.getContext("2d");a.clearRect(0,0,e.width,e.height);const r=Array.isArray(n)?n:n?[n]:[];o.forEach(i=>{const d=i.x*e.width,c=i.y*e.height,t=i.width*e.width,s=i.height*e.height,l=r.includes(i.id);a.strokeStyle=i.color||"#3B82F6",a.lineWidth=l?4:3,a.strokeRect(d,c,t,s),l&&(a.strokeStyle="#F59E0B",a.lineWidth=2,a.setLineDash([8,4]),a.strokeRect(d-3,c-3,t+6,s+6),a.setLineDash([]),r.length===1?this.drawResizeHandles(a,d,c,t,s):this.drawMultiSelectionMarkers(a,d,c,t,s)),i.text&&(a.fillStyle=i.color||"#3B82F6",a.font="bold 16px sans-serif",a.fillText(i.text,d+5,c-5))})},drawMultiSelectionMarkers(o,e,n,a,r){const d="#10B981";[{x:e,y:n},{x:e+a,y:n},{x:e,y:n+r},{x:e+a,y:n+r}].forEach(t=>{o.fillStyle=d,o.fillRect(t.x-6/2,t.y-6/2,6,6)})},drawResizeHandles(o,e,n,a,r){const d="#F59E0B";[{x:e,y:n},{x:e+a,y:n},{x:e,y:n+r},{x:e+a,y:n+r}].forEach(t=>{o.fillStyle=d,o.fillRect(t.x-10/2,t.y-10/2,10,10),o.strokeStyle="#fff",o.lineWidth=2,o.strokeRect(t.x-10/2,t.y-10/2,10,10)})},getClickedAnnotation(o,e,n,a){for(let r=n.length-1;r>=0;r--){const i=n[r],d=i.x*a.width,c=i.y*a.height,t=i.width*a.width,s=i.height*a.height;if(o>=d&&o<=d+t&&e>=c&&e<=c+s)return i}return null},getResizeHandle(o,e,n,a){const d=n.x*a.width,c=n.y*a.height,t=n.width*a.width,s=n.height*a.height,l=[{pos:"tl",x:d,y:c},{pos:"tr",x:d+t,y:c},{pos:"bl",x:d,y:c+s},{pos:"br",x:d+t,y:c+s}];for(const h of l)if(Math.sqrt(Math.pow(o-h.x,2)+Math.pow(e-h.y,2))<=10/2+5)return h.pos;return null},resizeAnnotation(o,e,n,a,r){let i=o.x*r.width,d=o.y*r.height,c=o.width*r.width,t=o.height*r.height;switch(e){case"tl":c=i+c-n,t=d+t-a,i=n,d=a;break;case"tr":c=n-i,t=d+t-a,d=a;break;case"bl":c=i+c-n,t=a-d,i=n;break;case"br":c=n-i,t=a-d;break}return c<0&&(i=i+c,c=Math.abs(c)),t<0&&(d=d+t,t=Math.abs(t)),{x:i/r.width,y:d/r.height,width:c/r.width,height:t/r.height}},moveAnnotation(o,e,n,a){let r=o.x*a.width+e,i=o.y*a.height+n;const d=o.width*a.width,c=o.height*a.height;return r=Math.max(0,Math.min(r,a.width-d)),i=Math.max(0,Math.min(i,a.height-c)),{x:r/a.width,y:i/a.height}},setCursor(o,e){o&&(o.style.cursor=e==="rectangle"?"crosshair":"pointer")},setResizeCursor(o,e){if(!o)return;const n={tl:"nwse-resize",tr:"nesw-resize",bl:"nesw-resize",br:"nwse-resize"};o.style.cursor=n[e]||"default"},setMoveCursor(o){o&&(o.style.cursor="move")}}}function z(){return{saveState(o,e,n=20){const a=JSON.parse(JSON.stringify(o)),r=[...e,a];return r.length>n&&r.shift(),{undoStack:r,redoStack:[]}},undo(o,e,n){if(e.length===0)return null;const a=JSON.parse(JSON.stringify(o)),r=[...n,a],i=[...e];return{annotations:i.pop(),undoStack:i,redoStack:r}},redo(o,e,n){if(n.length===0)return null;const a=JSON.parse(JSON.stringify(o)),r=[...e,a],i=[...n];return{annotations:i.pop(),undoStack:r,redoStack:i}},deleteSelected(o,e){if(e===null)return null;const n=o.findIndex(r=>r.id===e);if(n===-1)return null;const a=[...o];return a.splice(n,1),{annotations:a,selectedId:null}},removeAnnotation(o,e){if(e<0||e>=o.length)return o;const n=[...o];return n.splice(e,1),n},clearLastAnnotation(o){if(o.length===0)return o;const e=[...o];return e.pop(),e},clearAllAnnotations(o,e){return e("Clear all annotations? This cannot be undone.")?[]:o},selectAnnotation(o,e,n,a=.01){const r=o.find(i=>e>=i.x-a&&e<=i.x+i.width+a&&n>=i.y-a&&n<=i.y+i.height+a);return r?r.id:null},deselectAnnotation(){return null}}}function N(){return{async goToPage(o,e,n){return!o||e<1||e>n?null:{pdfPage:await o.getPage(e),pageNum:e}},async goToFirstPage(o,e){return this.goToPage(o,1,e)},async goToLastPage(o,e){return this.goToPage(o,e,e)},async goToNextPage(o,e,n){return e>=n?null:this.goToPage(o,e+1,n)},async goToPreviousPage(o,e,n){return e<=1?null:this.goToPage(o,e-1,n)},isValidPageNumber(o,e){return o>=1&&o<=e&&Number.isInteger(o)},sanitizePageInput(o,e){const n=parseInt(o,10);return isNaN(n)||n<1?1:n>e?e:n}}}function I(o){const e=$(),n=F(),a=z(),r=N(),i=R();let d=null,c=null;return{imageLoaded:!1,showModal:!1,showAnnotationModal:!1,showAnnotationV2Modal:!1,error:!1,modalImageLoaded:!1,modalError:!1,annotationViewerLoaded:!1,isSaving:!1,isDrawing:!1,loadingMetadata:!1,activeTab:"metadata",currentPdfUrl:null,currentPageNum:null,totalPages:1,pageInputValue:1,baseScale:1,zoomLevel:1,rotation:0,currentTool:"rectangle",isDrawing:!1,startX:0,startY:0,selectedAnnotationId:null,selectedAnnotationIds:[],isResizing:!1,isMoving:!1,resizeHandle:null,moveStartX:0,moveStartY:0,undoStack:[],redoStack:[],clipboard:[],availableTemplates:[],draftSaveTimer:null,hasUnsavedChanges:!1,lastSavedAt:null,annotationsLastModified:null,measurements:[],measurementMode:null,savedView:null,pdfPageId:null,projectId:null,projectNumber:"TFW-0001",projectContext:null,availableRooms:[],availableRoomLocations:[],availableCabinetRuns:[],availableCabinets:[],annotations:[],annotationType:"room",selectedRoomId:null,selectedRoomLocationId:null,selectedCabinetRunId:null,selectedCabinetId:null,selectedRunType:"base",currentRoomType:"",measurementLength:"",measurementWidth:"",measurementHeight:"",measurementLengthInches:"",measurementWidthInches:"",measurementHeightInches:"",measurementDepthInches:"",measurementLinearFeet:"",measurementDoorCount:"",pageType:"",coverCustomerId:"",coverCompanyId:"",coverBranchId:"",coverAddressStreet1:"",coverAddressStreet2:"",coverAddressCity:"",coverAddressStateId:"",coverAddressZip:"",coverAddressCountryId:"",floorPlanFloorNumber:"",floorPlanRoomsIncluded:[],floorPlanScale:"",floorPlanOrientation:"",floorPlanNotes:"",elevationRoomId:null,elevationRoomLocationId:null,elevationViewDirection:"",elevationCabinetRuns:[],elevationScale:"",elevationShowHeights:!0,elevationNotes:"",detailType:"",detailCabinetId:null,detailNumber:"",detailScale:"",detailNotes:"",otherDescription:"",otherReferenceInfo:"",otherNotes:"",filteredRoomLocations:[],filteredCabinetRuns:[],filteredCabinets:[],roomColors:{kitchen:"#3B82F6",pantry:"#10B981",laundry:"#F59E0B",bathroom:"#EF4444",mudroom:"#8B5CF6",office:"#EC4899",bedroom:"#06B6D4",closet:"#84CC16"},roomCodes:{kitchen:"K",pantry:"P",laundry:"L",bathroom:"B",mudroom:"M",office:"O",bedroom:"BR",closet:"C"},async fallbackLoadPage(t,s){return console.warn("‚ö†Ô∏è PDF manager not available, using fallback direct load"),await(await o.getDocument(t).promise).getPage(s)},async loadThumbnail(t,s,l){var h;this.currentPdfUrl=t,this.currentPageNum=s,this.pdfPageId=l;try{const u=((h=window.PDFDocumentManager)==null?void 0:h.getInstance())||window.pdfManager,g=u?await u.getPage(t,s):await this.fallbackLoadPage(t,s),p=g.getViewport({scale:1}),f=this.$refs.thumbnail,m=f.closest(".w-full"),S=((m?m.clientWidth:300)-16)/p.width,C=g.getViewport({scale:S});f.width=C.width,f.height=C.height;const b={canvasContext:f.getContext("2d"),viewport:C};await g.render(b).promise,this.imageLoaded=!0}catch(u){console.error("Error loading thumbnail:",u),this.error=!0}},async loadModalImage(){var t;try{this.modalImageLoaded=!1,this.modalError=!1;const s=((t=window.PDFDocumentManager)==null?void 0:t.getInstance())||window.pdfManager,l=s?await s.getPage(this.currentPdfUrl,this.currentPageNum):await this.fallbackLoadPage(this.currentPdfUrl,this.currentPageNum),u=1400/l.getViewport({scale:1}).width,g=l.getViewport({scale:u}),p=this.$refs.modalCanvas;p.width=g.width,p.height=g.height;const f={canvasContext:p.getContext("2d"),viewport:g};await l.render(f).promise,this.modalImageLoaded=!0}catch(s){console.error("Error loading modal PDF:",s),this.modalError=!0}},async loadCanvasAnnotationViewer(){try{const t=await e.loadPdfPage(o,this.currentPdfUrl,this.currentPageNum);c=t.pdfDocument,d=t.pdfPage,this.totalPages=t.totalPages,this.pageInputValue=this.currentPageNum;const s=d.getViewport({scale:1});this.baseScale=e.calculateBaseScale(s),await this.loadMetadata(),await this.renderCanvas(),this.annotationViewerLoaded=!0,console.log("‚úÖ Canvas annotation viewer loaded successfully")}catch(t){console.error("Canvas annotation loading error:",t),alert("Failed to load PDF annotation viewer: "+t.message)}},async loadMetadata(){this.loadingMetadata=!0;try{if(!this.pdfPageId){console.warn("No PDF page ID available for loading metadata");return}const t=await L(this.pdfPageId);this.availableRooms=t.rooms,this.availableRoomLocations=t.roomLocations,this.availableCabinetRuns=t.cabinetRuns,this.availableCabinets=t.cabinets,this.projectId=t.projectId,this.projectNumber=t.projectNumber,this.annotations=t.annotations,this.annotationsLastModified=t.annotationsLastModified,t.projectContext&&(this.projectContext=t.projectContext),await this.loadPageMetadata(),console.log("‚úÖ Loaded all metadata")}catch(t){console.error("Failed to load metadata:",t)}finally{this.loadingMetadata=!1}},async renderCanvas(){d&&(await e.renderCanvas(d,this.$refs.pdfCanvas,this.$refs.annotationCanvas,this.baseScale,this.zoomLevel,this.rotation),n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationId))},async zoomIn(){this.zoomLevel=e.zoomIn(this.zoomLevel),await this.renderCanvas()},async zoomOut(){this.zoomLevel=e.zoomOut(this.zoomLevel),await this.renderCanvas()},async resetZoom(){this.zoomLevel=e.resetZoom(),await this.renderCanvas()},async fitToPage(){const t=this.$refs.pdfCanvas.closest(".flex-1");this.zoomLevel=e.calculateFitToPage(d,t,this.baseScale,this.rotation),await this.renderCanvas()},async fitToWidth(){const t=this.$refs.pdfCanvas.closest(".flex-1");this.zoomLevel=e.calculateFitToWidth(d,t,this.baseScale,this.rotation),await this.renderCanvas()},async fitToHeight(){const t=this.$refs.pdfCanvas.closest(".flex-1");this.zoomLevel=e.calculateFitToHeight(d,t,this.baseScale,this.rotation),await this.renderCanvas()},async actualSize(){this.zoomLevel=1,await this.renderCanvas()},async rotateClockwise(){this.rotation=e.rotateClockwise(this.rotation),await this.renderCanvas()},async rotateCounterClockwise(){this.rotation=e.rotateCounterClockwise(this.rotation),await this.renderCanvas()},resetView(){const t=e.resetView();this.zoomLevel=t.zoomLevel,this.rotation=t.rotation,this.renderCanvas()},saveCurrentView(){this.savedView=e.saveView(this.zoomLevel,this.rotation,this.currentPageNum),alert(`View saved! (${Math.round(this.zoomLevel*100)}% zoom, ${this.rotation}¬∞ rotation)`)},async restoreSavedView(){if(!this.savedView){alert("No saved view to restore");return}this.zoomLevel=this.savedView.zoomLevel,this.rotation=this.savedView.rotation,this.savedView.pageNum!==this.currentPageNum?await this.goToPage(this.savedView.pageNum):await this.renderCanvas()},async goToPage(t){const s=await r.goToPage(c,t,this.totalPages);s&&(this.currentPageNum=s.pageNum,this.pageInputValue=s.pageNum,this.annotations=[],d=s.pdfPage,await this.renderCanvas())},async goToFirstPage(){const t=await r.goToFirstPage(c,this.totalPages);t&&(this.currentPageNum=t.pageNum,this.pageInputValue=t.pageNum,this.annotations=[],d=t.pdfPage,await this.renderCanvas())},async goToLastPage(){const t=await r.goToLastPage(c,this.totalPages);t&&(this.currentPageNum=t.pageNum,this.pageInputValue=t.pageNum,this.annotations=[],d=t.pdfPage,await this.renderCanvas())},async goToNextPage(){const t=await r.goToNextPage(c,this.currentPageNum,this.totalPages);t&&(this.currentPageNum=t.pageNum,this.pageInputValue=t.pageNum,this.annotations=[],d=t.pdfPage,await this.renderCanvas())},async goToPreviousPage(){const t=await r.goToPreviousPage(c,this.currentPageNum,this.totalPages);t&&(this.currentPageNum=t.pageNum,this.pageInputValue=t.pageNum,this.annotations=[],d=t.pdfPage,await this.renderCanvas())},setTool(t){this.currentTool=t,this.selectedAnnotationId=null,n.setCursor(this.$refs.annotationCanvas,t)},startDrawing(t){const s=this.$refs.annotationCanvas.getBoundingClientRect(),l=t.clientX-s.left,h=t.clientY-s.top;if(this.currentTool==="select"&&this.selectedAnnotationId){const g=this.annotations.find(p=>p.id===this.selectedAnnotationId);if(g){const p=n.getResizeHandle(l,h,g,this.$refs.annotationCanvas);if(p){this.isResizing=!0,this.resizeHandle=p,this.startX=l,this.startY=h;return}const f=n.getClickedAnnotation(l,h,this.annotations,this.$refs.annotationCanvas);if(f&&f.id===this.selectedAnnotationId){this.isMoving=!0,this.moveStartX=l,this.moveStartY=h;return}}}if(this.currentTool==="select"){const g=n.getClickedAnnotation(l,h,this.annotations,this.$refs.annotationCanvas);if(g){const p=a.saveState(this.annotations,this.undoStack);this.undoStack=p.undoStack,this.redoStack=p.redoStack,this.toggleSelection(g.id,t.shiftKey)}else t.shiftKey||this.deselectAll();return}const u=n.startDrawing(t,this.$refs.annotationCanvas,this.currentTool);u&&(this.isDrawing=u.isDrawing,this.startX=u.startX,this.startY=u.startY)},draw(t){const s=this.$refs.annotationCanvas.getBoundingClientRect(),l=t.clientX-s.left,h=t.clientY-s.top;if(this.isResizing&&this.selectedAnnotationId){const g=this.annotations.find(p=>p.id===this.selectedAnnotationId);if(g){const p=n.resizeAnnotation(g,this.resizeHandle,l,h,this.$refs.annotationCanvas);Object.assign(g,p),n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationId)}return}if(this.isMoving&&this.selectedAnnotationId){const g=this.annotations.find(p=>p.id===this.selectedAnnotationId);if(g){const p=l-this.moveStartX,f=h-this.moveStartY,m=n.moveAnnotation(g,p,f,this.$refs.annotationCanvas);g.x=m.x,g.y=m.y,this.moveStartX=l,this.moveStartY=h,n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationId)}return}if(!this.isDrawing)return;const u={isDrawing:this.isDrawing,startX:this.startX,startY:this.startY};n.drawPreview(t,this.$refs.annotationCanvas,u,this.annotations,(g,p)=>n.redrawAnnotations(g,p,this.selectedAnnotationId))},stopDrawing(t){if(this.isResizing){const u=a.saveState(this.annotations,this.undoStack);this.undoStack=u.undoStack,this.redoStack=u.redoStack,this.isResizing=!1,this.resizeHandle=null,n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationId);return}if(this.isMoving){const u=a.saveState(this.annotations,this.undoStack);this.undoStack=u.undoStack,this.redoStack=u.redoStack,this.isMoving=!1,n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationId);return}if(!this.isDrawing)return;const s={isDrawing:this.isDrawing,startX:this.startX,startY:this.startY},l={annotationType:this.annotationType,roomType:this.currentRoomType,projectNumber:this.projectNumber,roomCodes:this.roomCodes,roomColors:this.roomColors},h=n.stopDrawing(t,this.$refs.annotationCanvas,s,l,this.annotations);if(h){const u=a.saveState(this.annotations,this.undoStack);this.undoStack=u.undoStack,this.redoStack=u.redoStack,this.annotations.push(h),n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationId)}this.isDrawing=!1},cancelDrawing(){this.isDrawing&&(this.isDrawing=!1,n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationId))},undo(){const t=a.undo(this.annotations,this.undoStack,this.redoStack);t&&(this.annotations=t.annotations,this.undoStack=t.undoStack,this.redoStack=t.redoStack,n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationId))},redo(){const t=a.redo(this.annotations,this.undoStack,this.redoStack);t&&(this.annotations=t.annotations,this.undoStack=t.undoStack,this.redoStack=t.redoStack,n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationId))},deleteSelected(){const t=a.deleteSelected(this.annotations,this.selectedAnnotationId);if(t){const s=a.saveState(this.annotations,this.undoStack);this.undoStack=s.undoStack,this.redoStack=s.redoStack,this.annotations=t.annotations,this.selectedAnnotationId=t.selectedId,n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationId)}},removeAnnotation(t){const s=a.saveState(this.annotations,this.undoStack);this.undoStack=s.undoStack,this.redoStack=s.redoStack,this.annotations=a.removeAnnotation(this.annotations,t),n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationId)},clearLastAnnotation(){const t=a.saveState(this.annotations,this.undoStack);this.undoStack=t.undoStack,this.redoStack=t.redoStack,this.annotations=a.clearLastAnnotation(this.annotations),n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationId)},clearAllAnnotations(){const t=a.saveState(this.annotations,this.undoStack);this.undoStack=t.undoStack,this.redoStack=t.redoStack,this.annotations=a.clearAllAnnotations(this.annotations,confirm),n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationId)},filterRoomLocations(){this.filteredRoomLocations=i.filterRoomLocations(this.selectedRoomId,this.availableRoomLocations)},filterCabinetRuns(){this.filteredCabinetRuns=i.filterCabinetRuns(this.selectedRoomLocationId,this.availableCabinetRuns)},filterCabinets(){this.filteredCabinets=i.filterCabinets(this.selectedCabinetRunId,this.availableCabinets)},resetChildSelections(){const t=i.resetChildSelections();Object.assign(this,t)},resetPageTypeFields(){this.pageType!=="cover"&&(this.coverCustomerId="",this.coverCompanyId="",this.coverBranchId="",this.coverAddressStreet1="",this.coverAddressStreet2="",this.coverAddressCity="",this.coverAddressStateId="",this.coverAddressZip="",this.coverAddressCountryId="")},autoPopulateCoverPageFields(){if(!this.projectContext){console.warn("‚ö†Ô∏è No project context available for auto-population");return}!this.coverCustomerId&&this.projectContext.partner&&(this.coverCustomerId=String(this.projectContext.partner.id),console.log("‚úÖ Auto-populated customer ID:",this.coverCustomerId)),!this.coverCompanyId&&this.projectContext.company&&(this.coverCompanyId=String(this.projectContext.company.id),console.log("‚úÖ Auto-populated company ID:",this.coverCompanyId)),!this.coverBranchId&&this.projectContext.branch&&(this.coverBranchId=String(this.projectContext.branch.id),console.log("‚úÖ Auto-populated branch ID:",this.coverBranchId)),this.projectContext.address&&(!this.coverAddressStreet1&&this.projectContext.address.street1&&(this.coverAddressStreet1=this.projectContext.address.street1,console.log("‚úÖ Auto-populated street1:",this.coverAddressStreet1)),!this.coverAddressStreet2&&this.projectContext.address.street2&&(this.coverAddressStreet2=this.projectContext.address.street2,console.log("‚úÖ Auto-populated street2:",this.coverAddressStreet2)),!this.coverAddressCity&&this.projectContext.address.city&&(this.coverAddressCity=this.projectContext.address.city,console.log("‚úÖ Auto-populated city:",this.coverAddressCity)),!this.coverAddressStateId&&this.projectContext.address.state_id&&(this.coverAddressStateId=String(this.projectContext.address.state_id),console.log("‚úÖ Auto-populated state ID:",this.coverAddressStateId)),!this.coverAddressZip&&this.projectContext.address.zip&&(this.coverAddressZip=this.projectContext.address.zip,console.log("‚úÖ Auto-populated zip:",this.coverAddressZip)),!this.coverAddressCountryId&&this.projectContext.address.country_id&&(this.coverAddressCountryId=String(this.projectContext.address.country_id),console.log("‚úÖ Auto-populated country ID:",this.coverAddressCountryId))),console.log("‚úÖ Cover page auto-population complete")},async loadPageMetadata(){if(this.pdfPageId)try{const t=await fetch(`/api/pdf/page/${this.pdfPageId}/metadata`);if(t.ok){const s=await t.json();this.pageType=s.page_type||"",s.page_type==="cover"&&s.cover_metadata&&(this.coverCustomerId=s.cover_metadata.customer_id||"",this.coverCompanyId=s.cover_metadata.company_id||"",this.coverBranchId=s.cover_metadata.branch_id||"",this.coverAddressStreet1=s.cover_metadata.address_street1||"",this.coverAddressStreet2=s.cover_metadata.address_street2||"",this.coverAddressCity=s.cover_metadata.address_city||"",this.coverAddressStateId=s.cover_metadata.address_state_id||"",this.coverAddressZip=s.cover_metadata.address_zip||"",this.coverAddressCountryId=s.cover_metadata.address_country_id||""),s.page_type==="cover"&&this.projectContext&&this.autoPopulateCoverPageFields(),console.log("‚úÖ Loaded page metadata")}}catch(t){console.error("Failed to load page metadata:",t)}},async savePageMetadata(){if(!this.pdfPageId)return;const t={page_type:this.pageType};this.pageType==="cover"&&(t.cover_metadata={customer_id:this.coverCustomerId,company_id:this.coverCompanyId,branch_id:this.coverBranchId,address_street1:this.coverAddressStreet1,address_street2:this.coverAddressStreet2,address_city:this.coverAddressCity,address_state_id:this.coverAddressStateId,address_zip:this.coverAddressZip,address_country_id:this.coverAddressCountryId});try{if(!(await fetch(`/api/pdf/page/${this.pdfPageId}/metadata`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify(t)})).ok)throw new Error("Failed to save page metadata");return!0}catch(s){throw console.error("Failed to save page metadata:",s),s}},async saveAnnotations(){this.isSaving=!0;try{if(await this.savePageMetadata(),this.annotations.length>0){const t={selectedRoomId:this.selectedRoomId,selectedRoomLocationId:this.selectedRoomLocationId,selectedCabinetRunId:this.selectedCabinetRunId,selectedRunType:this.selectedRunType},s=await M(this.pdfPageId,this.annotations,this.annotationType,t);alert(`‚úÖ Saved page metadata!
‚úÖ Saved ${s.count} annotations!
‚úÖ Created ${s.entities_created_count} entities!`)}else alert("‚úÖ Saved page metadata!");this.showAnnotationModal=!1}catch(t){alert("‚ùå Failed to save: "+t.message)}finally{this.isSaving=!1}},toggleSelection(t,s){if(s){const l=this.selectedAnnotationIds.indexOf(t);l>-1?this.selectedAnnotationIds.splice(l,1):this.selectedAnnotationIds.push(t)}else this.selectedAnnotationIds=[t];this.selectedAnnotationId=this.selectedAnnotationIds.length>0?this.selectedAnnotationIds[0]:null,n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationIds)},selectAll(){this.selectedAnnotationIds=this.annotations.map(t=>t.id),this.selectedAnnotationId=this.selectedAnnotationIds[0]||null,n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationIds)},deselectAll(){this.selectedAnnotationIds=[],this.selectedAnnotationId=null,n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationIds)},copySelected(){if(this.selectedAnnotationIds.length===0){alert("No annotations selected to copy");return}this.clipboard=this.annotations.filter(t=>this.selectedAnnotationIds.includes(t.id)).map(t=>JSON.parse(JSON.stringify(t))),alert(`‚úÖ Copied ${this.clipboard.length} annotation(s)`)},pasteFromClipboard(){if(this.clipboard.length===0){alert("Clipboard is empty");return}const t=a.saveState(this.annotations,this.undoStack);this.undoStack=t.undoStack,this.redoStack=t.redoStack;const s=this.clipboard.map(l=>({...l,id:Date.now()+Math.random(),x:l.x+.05,y:l.y+.05}));this.annotations.push(...s),this.selectedAnnotationIds=s.map(l=>l.id),this.selectedAnnotationId=this.selectedAnnotationIds[0],this.markUnsavedChanges(),n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationIds),alert(`‚úÖ Pasted ${s.length} annotation(s)`)},saveAsTemplate(){if(this.selectedAnnotationIds.length!==1){alert("Select exactly one annotation to save as template");return}const t=this.annotations.find(h=>h.id===this.selectedAnnotationIds[0]),s=prompt("Enter template name:",`${t.annotation_type} Template`);if(!s)return;const l={id:Date.now(),name:s,annotation_type:t.annotation_type,room_type:t.room_type,color:t.color,width:t.width,height:t.height};this.availableTemplates.push(l),this.saveTemplatesToLocalStorage(),alert(`‚úÖ Template "${s}" saved!`)},applyTemplate(t){const s=this.availableTemplates.find(u=>u.id===t);if(!s)return;const l=a.saveState(this.annotations,this.undoStack);this.undoStack=l.undoStack,this.redoStack=l.redoStack;const h={id:Date.now(),x:.1,y:.1,width:s.width,height:s.height,text:this.generateLabel(s.annotation_type,s.room_type),room_type:s.room_type,color:s.color,annotation_type:s.annotation_type};this.annotations.push(h),this.selectedAnnotationIds=[h.id],this.selectedAnnotationId=h.id,this.markUnsavedChanges(),n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationIds)},saveTemplatesToLocalStorage(){localStorage.setItem("pdf_annotation_templates",JSON.stringify(this.availableTemplates))},loadTemplatesFromLocalStorage(){const t=localStorage.getItem("pdf_annotation_templates");t&&(this.availableTemplates=JSON.parse(t))},setMeasurementTool(t){this.measurementMode=t,this.currentTool="measurement"},calculateDistance(t,s,l,h){const u=this.$refs.annotationCanvas,g=t*u.width,p=s*u.height,f=l*u.width,m=h*u.height,w=Math.sqrt(Math.pow(f-g,2)+Math.pow(m-p,2)),v=w/(this.baseScale*72),S=v/12;return{pixels:w,inches:v,feet:S}},calculateArea(t){const s=this.$refs.annotationCanvas;let l=0;for(let g=0;g<t.length;g++){const p=(g+1)%t.length,f=t[g].x*s.width,m=t[g].y*s.height,w=t[p].x*s.width,v=t[p].y*s.height;l+=f*v,l-=w*m}l=Math.abs(l/2);const h=l/Math.pow(this.baseScale*72,2),u=h/144;return{pixels:l,sqInches:h,sqFeet:u}},markUnsavedChanges(){this.hasUnsavedChanges=!0,this.scheduleDraftSave()},scheduleDraftSave(){this.draftSaveTimer&&clearTimeout(this.draftSaveTimer),this.draftSaveTimer=setTimeout(()=>{this.saveDraft()},3e4)},saveDraft(){const t={pdfPageId:this.pdfPageId,annotations:this.annotations,savedAt:new Date().toISOString()};localStorage.setItem(`pdf_annotation_draft_${this.pdfPageId}`,JSON.stringify(t)),this.lastSavedAt=t.savedAt,console.log("‚úÖ Draft auto-saved at",this.lastSavedAt)},loadDraft(){const t=localStorage.getItem(`pdf_annotation_draft_${this.pdfPageId}`);if(!t)return!1;const s=JSON.parse(t),l=new Date(s.savedAt),h=this.annotationsLastModified?new Date(this.annotationsLastModified):null;if(h&&h>l)return console.log(`üîÑ Database annotations (${h.toLocaleString()}) are newer than draft (${l.toLocaleString()}). Using database.`),localStorage.removeItem(`pdf_annotation_draft_${this.pdfPageId}`),!1;let u=`Restore unsaved annotations from ${l.toLocaleString()}?`;return h&&(u+=`

‚ö†Ô∏è Database has ${this.annotations.length} annotation(s) from ${h.toLocaleString()}.

Click OK to use LOCAL DRAFT (${s.annotations.length} annotations)
Click Cancel to use DATABASE (${this.annotations.length} annotations)`),confirm(u)?(console.log(`‚úÖ User chose to restore draft with ${s.annotations.length} annotations`),this.annotations=s.annotations,this.lastSavedAt=s.savedAt,n.redrawAnnotations(this.annotations,this.$refs.annotationCanvas,this.selectedAnnotationIds),!0):(console.log(`‚úÖ User chose to keep database annotations (${this.annotations.length} annotations)`),localStorage.removeItem(`pdf_annotation_draft_${this.pdfPageId}`),!1)},clearDraft(){localStorage.removeItem(`pdf_annotation_draft_${this.pdfPageId}`),this.hasUnsavedChanges=!1,this.lastSavedAt=null},init(){this.loadTemplatesFromLocalStorage(),this.$watch("showModal",t=>{t&&setTimeout(()=>this.loadModalImage(),100)}),this.$watch("showAnnotationModal",t=>{t&&!this.annotationViewerLoaded&&(this.loadCanvasAnnotationViewer(),setTimeout(()=>{this.loadDraft()},500))}),this.$watch("annotations",()=>{this.annotationViewerLoaded&&this.markUnsavedChanges()}),document.addEventListener("keydown",t=>{this.showAnnotationModal&&(t.ctrlKey&&t.key==="z"&&(t.preventDefault(),this.undo()),t.ctrlKey&&t.key==="y"&&(t.preventDefault(),this.redo()),t.ctrlKey&&t.key==="c"&&(t.preventDefault(),this.copySelected()),t.ctrlKey&&t.key==="v"&&(t.preventDefault(),this.pasteFromClipboard()),t.ctrlKey&&t.key==="a"&&(t.preventDefault(),this.selectAll()),t.key==="Delete"&&this.selectedAnnotationIds.length>0&&(t.preventDefault(),this.deleteSelected()),t.key==="Escape"&&(t.preventDefault(),this.deselectAll()),(t.key==="r"||t.key==="R")&&(t.preventDefault(),this.setTool("rectangle")),(t.key==="v"||t.key==="V")&&(t.preventDefault(),this.setTool("select")),(t.key==="m"||t.key==="M")&&(t.preventDefault(),this.setMeasurementTool("distance")))})}}}k.workerSrc="/js/pdf.worker.min.js";const V=A.getInstance();window.pdfjsLib=y;window.PDFDocumentManager=A;window.pdfManager=V;window.createAnnotationComponent=I;console.log("‚úÖ PDF Document Manager initialized (shared instance)");document.addEventListener("alpine:init",()=>{Alpine.data("pdfThumbnailPdfJs",()=>I(y)),console.log("‚úÖ PDF Annotation System loaded - Alpine components registered")});
