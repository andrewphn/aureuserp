import{G as Po,p as Mo}from"./pdf-BnRl7pXp.js";const Eo="modulepreload",Do=function(o){return"/build/"+o},ie={},ko=function(e,n,i){let t=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),a=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));t=Promise.allSettled(n.map(c=>{if(c=Do(c),c in ie)return;ie[c]=!0;const s=c.endsWith(".css"),d=s?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${d}`))return;const u=document.createElement("link");if(u.rel=s?"stylesheet":Eo,s||(u.as="script"),u.crossOrigin="",u.href=c,a&&u.setAttribute("nonce",a),document.head.appendChild(u),s)return new Promise((f,m)=>{u.addEventListener("load",f),u.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${c}`)))})}))}function r(l){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=l,window.dispatchEvent(a),!a.defaultPrevented)throw l}return t.then(l=>{for(const a of l||[])a.status==="rejected"&&r(a.reason);return e().catch(r)})};function ae(o){return{pdfUrl:o.pdfUrl,pageNumber:o.pageNumber,pdfPageId:o.pdfPageId,projectId:o.projectId,totalPages:o.totalPages||1,pageMap:o.pageMap||{},currentPage:o.pageNumber||1,pageType:o.pageType||null,pdfReady:!1,treeReady:!1,annotationsReady:!1,systemReady:!1,pageDimensions:null,canvasScale:1,zoomLevel:1,zoomMin:1,zoomMax:3,activeRoomId:null,activeRoomName:"",activeLocationId:null,activeLocationName:"",drawMode:null,editorModalOpen:!1,isolationMode:!1,isolationLevel:null,isolatedRoomId:null,isolatedRoomName:"",isolatedLocationId:null,isolatedLocationName:"",isolatedCabinetRunId:null,isolatedCabinetRunName:"",isolationViewType:null,isolationOrientation:null,overlayWidth:"100%",overlayHeight:"100%",hiddenAnnotations:[],visibleAnnotationsList:[],tree:[],expandedNodes:[],selectedNodeId:null,selectedPath:[],selectedAnnotation:null,loading:!1,navigating:!1,error:null,treeViewMode:"room",treeSidebarState:"full",showFilters:!1,filterScope:"page",filters:{types:[],rooms:[],locations:[],viewTypes:[],verticalZones:[],myAnnotations:!1,recent:!1,unlinked:!1,pageRange:{from:null,to:null},dateRange:{from:null,to:null}},contextMenu:{show:!1,x:0,y:0,nodeId:null,nodeType:null,nodeName:"",parentRoomId:null},roomSearchQuery:"",locationSearchQuery:"",roomSuggestions:[],locationSuggestions:[],showRoomDropdown:!1,showLocationDropdown:!1,annotations:[],isDrawing:!1,drawStart:null,drawPreview:null,isResizing:!1,isMoving:!1,resizeTicking:!1,moveTicking:!1,resizeHandle:null,moveStart:null,resizeStart:null,activeAnnotationId:null,resizeSaveTimeout:null,pendingResizeChanges:null,autoSaveTimeout:null,activeViewType:"plan",activeOrientation:null,availableOrientations:{elevation:["front","back","left","right"],section:["A-A","B-B","C-C"],detail:[]},viewScale:1,annotationReferences:{},pageObserver:null,visiblePages:[],_overlayRect:null,_lastRectUpdate:0,_rectCacheMs:100,_cachedZoom:void 0,pdfIframe:null,scrollX:0,scrollY:0,historyStack:[],historyIndex:-1,maxHistorySize:50,isUndoRedoAction:!1,_initialized:!1}}function Y(o){const e={room:"#f59e0b",location:"#9333ea",cabinet_run:"#3b82f6",cabinet:"#10b981"};return e[o]||e.cabinet}function Oo(o,e=null){let i={plan:"Plan View",elevation:"Elevation View",section:"Section View",detail:"Detail View"}[o]||"Unknown View";if(e&&(o==="elevation"||o==="section")){const t=o==="elevation"?e.charAt(0).toUpperCase()+e.slice(1):e;i+=` - ${t}`}return i}function Ho(o){return{plan:"var(--primary-600)",elevation:"var(--warning-600)",section:"var(--info-600)",detail:"var(--success-600)"}[o]||"var(--gray-600)"}function Vo(o,e,n){if(e._resizeLockout||e.isResizing||e.isMoving){console.log("‚ö†Ô∏è Context change blocked - resize/move in progress");return}console.log("üéØ Selecting annotation context:",o.type,o.label),e.activeAnnotationId=o.id,e.selectedAnnotation=o,o.type==="room"?(e.activeRoomId=o.roomId||o.id,e.activeRoomName=o.label,e.activeLocationId=null,e.activeLocationName="",e.roomSearchQuery=o.label,e.locationSearchQuery="",console.log(`‚úì Room context set: Room "${o.label}"`),console.log("‚úì Enabled tools: Draw Location")):o.type==="location"?(e.activeRoomId=o.roomId,e.activeRoomName=o.roomName||(n.getRoomNameById?n.getRoomNameById(o.roomId):""),e.activeLocationId=o.id,e.activeLocationName=o.label,e.roomSearchQuery=e.activeRoomName,e.locationSearchQuery=o.label,console.log(`‚úì Location context set: Room "${e.activeRoomName}" ‚Üí Location "${o.label}"`),console.log("‚úì Enabled tools: Draw Cabinet Run, Draw Cabinet")):o.type==="cabinet_run"?(e.activeRoomId=o.roomId,e.activeRoomName=o.roomName||(n.getRoomNameById?n.getRoomNameById(o.roomId):""),e.activeLocationId=o.locationId,e.activeLocationName=o.locationName||(n.getLocationNameById?n.getLocationNameById(o.locationId):""),e.roomSearchQuery=e.activeRoomName,e.locationSearchQuery=e.activeLocationName,console.log(`‚úì Cabinet Run context set: Room "${e.activeRoomName}" ‚Üí Location "${e.activeLocationName}" ‚Üí Run "${o.label}"`),console.log("‚úì Enabled tools: Draw Cabinet")):o.type==="cabinet"&&(e.activeRoomId=o.roomId,e.activeRoomName=o.roomName||(n.getRoomNameById?n.getRoomNameById(o.roomId):""),e.activeLocationId=o.locationId,e.activeLocationName=o.locationName||(n.getLocationNameById?n.getLocationNameById(o.locationId):""),e.roomSearchQuery=e.activeRoomName,e.locationSearchQuery=e.activeLocationName,console.log(`‚úì Cabinet context set: Room "${e.activeRoomName}" ‚Üí Location "${e.activeLocationName}" ‚Üí Cabinet "${o.label}"`),console.log("‚úì Enabled tools: Draw Cabinet (sibling)")),e.selectedNodeId=o.id}const Fo=Object.freeze(Object.defineProperty({__proto__:null,createInitialState:ae,getColorForType:Y,getViewTypeColor:Ho,getViewTypeLabel:Oo,selectAnnotationContext:Vo},Symbol.toStringTag,{value:"Module"}));function ce(o){o._overlayRect=null,o._lastRectUpdate=0,o._rectCacheMs=100,o._cachedZoom=void 0}function Xo(o){if(o._cachedZoom!==void 0)return o._cachedZoom;const e=window.getComputedStyle(document.documentElement),n=parseFloat(e.zoom||"1");return o._cachedZoom=n,console.log("üîç CSS zoom factor (not browser zoom):",n),n}function W(o){o._cachedZoom=void 0}function se(o,e){var t,r;if(!e){const l=(t=o.pdfEmbed)==null?void 0:t.querySelector("canvas");return l?l.getBoundingClientRect():null}const n=Date.now();if(e._overlayRect&&n-e._lastRectUpdate<e._rectCacheMs)return e._overlayRect;const i=(r=o.pdfEmbed)==null?void 0:r.querySelector("canvas");return i?(e._overlayRect=i.getBoundingClientRect(),e._lastRectUpdate=n,e._overlayRect):null}function x(o,e){return se(o,e)}function de(o,e){if(!o.pdfEmbed||!e.pageDimensions)return 1;const n=o.pdfEmbed.querySelector("canvas");if(!n)return 1;const t=n.getBoundingClientRect().width,r=e.pageDimensions.width;return t/r}function z(o,e,n=0,i=0,t,r){var p;if(!r.pageDimensions)return{x:0,y:0,width:0,height:0};const l=(p=t.pdfEmbed)==null?void 0:p.querySelector("canvas");if(!l)return{x:0,y:0,width:0,height:0};const a=l.offsetWidth,c=l.offsetHeight,s=o/r.pageDimensions.width,d=(r.pageDimensions.height-e)/r.pageDimensions.height,u=s*a,f=d*c,m=n/r.pageDimensions.width*a,y=i/r.pageDimensions.height*c;return{x:u,y:f,width:m,height:y}}function h(o,e,n,i){var u;if(!i.pageDimensions)return{x:0,y:0,normalized:{x:0,y:0}};const t=(u=n.pdfEmbed)==null?void 0:u.querySelector("canvas");if(!t)return{x:0,y:0,normalized:{x:0,y:0}};const r=t.offsetWidth,l=t.offsetHeight,a=o/r,c=e/l,s=a*i.pageDimensions.width,d=i.pageDimensions.height-c*i.pageDimensions.height;return{x:s,y:d,normalized:{x:a,y:c}}}function Yo(o,e,n){return z(o.pdfX,o.pdfY,o.pdfWidth,o.pdfHeight,e,n)}function w(o,e){if(!o.pdfEmbed||!o.annotationOverlay)return;const n=o.pdfEmbed.querySelector("canvas");if(!n)return;const i=n.offsetWidth,t=n.offsetHeight;e.overlayWidth=`${i}px`,e.overlayHeight=`${t}px`,e._overlayRect=null,console.log(`üìê Overlay synced to canvas: ${i} √ó ${t} (layout space, zoom applied by browser)`)}function L(o,e){o.pageDimensions&&o.annotations.forEach(n=>{const i=z(n.pdfX,n.pdfY,n.pdfWidth,n.pdfHeight,e,o);n.screenX=i.x,n.screenY=i.y,n.screenWidth=i.width,n.screenHeight=i.height})}function Wo(o,e){if(o._resizeLockout||o.isResizing||o.isMoving){console.log("‚ö†Ô∏è Render blocked - resize/move in progress");return}console.log("üé® Rendering annotations"),L(o,e)}function jo(o,e,n){return o>=n.x&&o<=n.x+n.width&&e>=n.y&&e<=n.y+n.height}function ue(o,e,n){let i;const t=()=>{console.log("üîç Browser zoom/resize detected - re-syncing annotations"),clearTimeout(i),i=setTimeout(()=>{o._overlayRect=null,o._lastRectUpdate=0,W(o),w(e,o),setTimeout(()=>{L(o,e),o.isolationMode&&n.updateIsolationMask&&n.updateIsolationMask(),setTimeout(()=>{w(e,o),L(o,e),o.isolationMode&&n.updateIsolationMask&&n.updateIsolationMask(),console.log("‚úì Final sync complete after zoom/resize")},300),console.log("‚úì Annotations re-synced after browser zoom/resize")},50)},150)};return window.visualViewport&&window.visualViewport.addEventListener("resize",t),window.addEventListener("resize",t),console.log("‚úì Browser zoom handler initialized"),()=>{window.visualViewport&&window.visualViewport.removeEventListener("resize",t),window.removeEventListener("resize",t),clearTimeout(i),console.log("‚úì Browser zoom handler cleaned up")}}const Zo=Object.freeze(Object.defineProperty({__proto__:null,getAnnotationScreenPosition:Yo,getCanvasRect:se,getCanvasScale:de,getEffectiveZoom:Xo,getOverlayRect:x,initializeCoordinateSystem:ce,invalidateZoomCache:W,pdfToScreen:z,pointInRect:jo,renderAnnotations:Wo,screenToPdf:h,setupBrowserZoomHandler:ue,syncOverlayToCanvas:w,updateAnnotationPositions:L},Symbol.toStringTag,{value:"Module"})),$=new WeakMap;async function fe(o){console.log("üìÑ Preloading PDF document...");try{if(typeof window.pdfjsLib>"u")throw new Error("PDF.js library not loaded");const n=await window.pdfjsLib.getDocument(o.pdfUrl).promise;$.set(o,n),console.log("‚úì PDF document preloaded",{numPages:n.numPages,fingerprint:n.fingerprint})}catch(e){throw console.error("‚ùå Failed to preload PDF:",e),o.error=`Failed to load PDF: ${e.message}`,e}}async function Bo(o){console.log(`üìê Extracting dimensions for page ${o.currentPage}...`);const e=$.get(o);if(!e){console.error("‚ùå PDF document not preloaded");return}try{const i=(await e.getPage(o.currentPage)).getViewport({scale:1});o.pageDimensions={width:i.width,height:i.height},console.log(`‚úì Page dimensions: ${i.width} √ó ${i.height} pts`)}catch(n){console.warn("‚ö†Ô∏è PDF.js dimension extraction failed, using fallback method:",n.message),o.pageDimensions={width:612,height:792},console.log("‚úì Using fallback dimensions: 612 √ó 792 pts (letter size)"),o.error=null}}async function me(o,e){console.log(`üñºÔ∏è Rendering PDF page ${o.currentPage} to canvas at ${Math.round(o.zoomLevel*100)}% zoom...`);const n=e.pdfEmbed;if(!n){console.warn("‚ö†Ô∏è PDF embed container not found in DOM, skipping render");return}if((!n.clientWidth||n.clientWidth<10)&&(console.warn("‚ö†Ô∏è PDF embed container has no width, waiting for layout..."),await new Promise(i=>setTimeout(i,100)),!n.clientWidth||n.clientWidth<10)){console.error("‚ùå PDF embed container still has no width after waiting"),o.error="PDF viewer container not ready";return}try{let i=$.get(o);if(!i&&(console.log("üìÑ PDF not in WeakMap, preloading..."),await fe(o),i=$.get(o),!i))throw new Error("PDF document failed to preload");const t=await i.getPage(o.currentPage),r=t.getViewport({scale:1}),c=n.clientWidth/r.width*o.zoomLevel,s=t.getViewport({scale:c}),d=document.createElement("canvas"),u=d.getContext("2d");d.width=s.width,d.height=s.height,o.zoomLevel===1?(d.style.width="100%",d.style.height="auto"):(d.style.width=`${s.width}px`,d.style.height=`${s.height}px`),d.style.display="block";const f={canvasContext:u,viewport:s};await t.render(f).promise,n.innerHTML="",n.appendChild(d),o.canvasScale=c,console.log("‚úì PDF page rendered to canvas"),console.log(`‚úì Canvas dimensions: ${d.width} √ó ${d.height}`),console.log(`‚úì Canvas scale factor: ${c.toFixed(3)}`),o.pdfReady=!0,console.log(`‚úì PDF page ${o.currentPage} displayed successfully`)}catch(i){throw console.error("‚ùå Failed to render PDF:",i),o.error=`Failed to render PDF: ${i.message}`,i}}async function Qo(o,e,n){try{console.log("üöÄ Initializing PDF viewer system..."),await fe(o),await Bo(o),await me(o,e),n.$nextTick&&await n.$nextTick(),await new Promise(i=>setTimeout(i,100)),o.canvasScale=Uo(e,o),console.log(`üìê Canvas scale: ${o.canvasScale.toFixed(3)}`),w(e,o),console.log("‚úì PDF system initialized successfully")}catch(i){throw console.error("‚ùå PDF system initialization failed:",i),o.error=i.message,i}}function Uo(o,e){if(!o.pdfEmbed||!e.pageDimensions)return console.warn("‚ö†Ô∏è calculateCanvasScale: Missing refs.pdfEmbed or pageDimensions"),1;const n=o.pdfEmbed.querySelector("iframe"),i=o.pdfEmbed.querySelector("canvas");let t;if(i&&i.clientWidth>0)t=i.clientWidth;else if(n&&n.clientWidth>0)t=n.clientWidth;else if(o.pdfEmbed.clientWidth>0)t=o.pdfEmbed.clientWidth;else return console.warn("‚ö†Ô∏è calculateCanvasScale: No element has valid clientWidth, using default scale"),1;const r=e.pageDimensions.width,l=t/r;return console.log(`üìê Scale calculation: actual=${t}px, natural=${r}pts, scale=${l.toFixed(3)}`),l}function ge(o,e,n){return function(...i){e[n]||(e[n]=!0,window.requestAnimationFrame(()=>{e[n]=!1,o.apply(e,i)}))}}function Ko(o="temp"){return`${o}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function _(o){if(o===null||typeof o!="object")return o;if(o instanceof Date)return new Date(o.getTime());if(o instanceof Array)return o.map(n=>_(n));const e={};for(const n in o)o.hasOwnProperty(n)&&(e[n]=_(o[n]));return e}function I(){var o;return((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.content)||""}function qo(o,e={}){const n=document.createElementNS("http://www.w3.org/2000/svg",o);for(const[i,t]of Object.entries(e))n.setAttribute(i,t);return n}function v(o,e){if(!e.tree||!o)return"";const n=e.tree.find(i=>i.id===o);return n?n.name:""}function T(o,e){var n;if(!e.tree||!o)return"";for(const i of e.tree){const t=(n=i.children)==null?void 0:n.find(r=>r.id===o);if(t)return t.name}return""}function Go(o,e){var n;if(!e.tree||!o)return"";for(const i of e.tree)for(const t of i.children||[]){const r=(n=t.children)==null?void 0:n.find(l=>l.id===o);if(r)return r.name}return""}async function b(o,e,n={}){console.log(`üì• Loading annotations for page ${o.currentPage} (pdfPageId: ${o.pdfPageId})...`),o.annotations=[];try{const t=await(await fetch(`/api/pdf/page/${o.pdfPageId}/annotations`)).json();t.success&&t.annotations&&(o.annotations=t.annotations.map(r=>Jo(r,o,e)),o.annotations.forEach(r=>he(r,o)),console.log(`‚úì Loaded ${o.annotations.length} annotations with parent connections`),o.annotations.forEach(r=>{(r.type==="cabinet_run"||r.type==="cabinet")&&console.log(`  ${r.type==="cabinet_run"?"üì¶":"üóÑÔ∏è"} ${r.label}:`,`roomId=${r.roomId}, locationId=${r.locationId}, cabinetRunId=${r.cabinetRunId}`)}),o.isolationMode&&(console.log("üîç [LOAD] Re-applying isolation filter to newly loaded annotations"),en(o)))}catch(i){console.error("Failed to load annotations:",i),o.error=i.message}}function Jo(o,e,n){const i=z(o.x*e.pageDimensions.width,(1-o.y)*e.pageDimensions.height,o.width*e.pageDimensions.width,o.height*e.pageDimensions.height,n,e);return{id:o.id,type:o.annotation_type,parentId:o.parent_annotation_id,pdfX:o.x*e.pageDimensions.width,pdfY:(1-o.y)*e.pageDimensions.height,pdfWidth:o.width*e.pageDimensions.width,pdfHeight:o.height*e.pageDimensions.height,normalizedX:o.x,normalizedY:o.y,screenX:i.x,screenY:i.y,screenWidth:i.width,screenHeight:i.height,roomId:o.room_id,roomLocationId:o.room_location_id,cabinetRunId:o.cabinet_run_id,cabinetSpecId:o.cabinet_specification_id,viewType:o.view_type,label:o.text||"Annotation",color:o.color||Y(o.annotation_type),notes:o.notes,pageNumber:e.currentPage,pdfPageId:e.pdfPageId,projectId:e.projectId}}function he(o,e,n=new Set){if(!n.has(o.id)&&(n.add(o.id),o.roomId&&!o.roomName&&(o.roomName=v(o.roomId,e)),o.parentId)){const i=e.annotations.find(t=>t.id===o.parentId);i&&(he(i,e,n),!o.roomId&&i.roomId&&(o.roomId=i.roomId,o.roomName=i.roomName),i.type==="location"?(o.locationId=i.roomLocationId,o.locationName=i.label):i.locationId&&(o.locationId=i.locationId,o.locationName=i.locationName),i.type==="cabinet_run"?(o.cabinetRunId=i.cabinetRunId,o.cabinetRunName=i.label):i.cabinetRunId&&(o.cabinetRunId=i.cabinetRunId,o.cabinetRunName=i.cabinetRunName))}}function en(o){o.hiddenAnnotations=[],o.annotations.forEach(e=>{}),console.log(`üëÅÔ∏è [LOAD] Hidden annotations after filter: [${o.hiddenAnnotations.join(", ")}]`)}async function pe(o,e,n=!1){console.log("üíæ Saving annotations...",o.annotations);try{const i=o.annotations.map(l=>{const a=l.id&&l.id.toString().startsWith("temp_"),c={annotation_type:l.type,parent_annotation_id:l.parentId||null,x:l.normalizedX,y:l.normalizedY,width:l.pdfWidth/o.pageDimensions.width,height:l.pdfHeight/o.pageDimensions.height,text:l.label,color:l.color,view_type:l.viewType||"plan",notes:l.notes||null,room_type:l.type};return a?l.type==="cabinet"&&o.activeCabinetId?(c.cabinet_specification_id=o.activeCabinetId,c.cabinet_run_id=o.activeCabinetRunId,c.room_location_id=o.activeLocationId,c.room_id=o.activeRoomId,console.log(`üîó Linking new annotation to existing cabinet ${o.activeCabinetId}`)):(c.room_id=l.roomId||o.activeRoomId||null,c.room_location_id=l.roomLocationId||o.activeLocationId||null,c.cabinet_run_id=l.cabinetRunId||o.activeCabinetRunId||null,c.cabinet_specification_id=l.cabinetSpecId||null,c.context={project_id:o.projectId,room_id:c.room_id,room_location_id:c.room_location_id,cabinet_run_id:c.cabinet_run_id,location_type:"wall",run_type:"base",position_in_run:0,product_variant_id:1},console.log("üÜï New annotation will create entity:",c.context)):(c.room_id=l.roomId||null,c.room_location_id=l.roomLocationId||null,c.cabinet_run_id=l.cabinetRunId||null,c.cabinet_specification_id=l.cabinetSpecId||null),c}),t=await fetch(`/api/pdf/page/${o.pdfPageId}/annotations`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":I()},body:JSON.stringify({annotations:i,create_entities:!0})});if(!t.ok){const l=t.headers.get("content-type");if(l&&l.includes("text/html")){const a=await t.text();throw console.error("Server returned HTML error page:",a.substring(0,500)),new Error(`Server error (${t.status}): Check console for details`)}throw new Error(`Server error: ${t.status} ${t.statusText}`)}const r=await t.json();if(r.success)console.log(`‚úì Saved ${r.count} annotations`),n||alert(`Successfully saved ${r.count} annotations!`),e&&await e();else throw new Error(r.error||"Failed to save annotations")}catch(i){throw console.error("Failed to save annotations:",i),alert(`Error saving annotations: ${i.message}`),i}}async function ve(o,e,n){if(confirm(`Delete "${o.label}"?`)){if(console.log("üóëÔ∏è Deleting annotation:",o),o.id.toString().startsWith("temp_")){e.annotations=e.annotations.filter(i=>i.id!==o.id),console.log("‚úì Temporary annotation removed from local state");return}try{const t=await(await fetch(`/api/pdf/page/annotations/${o.id}`,{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":I()}})).json();if(t.success)e.annotations=e.annotations.filter(r=>r.id!==o.id),console.log("‚úì Annotation deleted successfully"),n&&await n();else throw new Error(t.error||"Failed to delete annotation")}catch(i){throw console.error("Failed to delete annotation:",i),alert(`Error deleting annotation: ${i.message}`),i}}}function O(o,e){console.log("‚úèÔ∏è Editing annotation:",o);const n={...o,pdfPageId:e.pdfPageId,projectId:e.projectId};window.Livewire.dispatch("edit-annotation",{annotation:n})}function ye(o,e,n){if(!e||!n.annotations)return null;console.log(`üîç [findAnnotationByEntity] Looking for ${o} with ID ${e}`);for(const i of n.annotations){if(o==="room"&&i.roomId===e&&i.type==="room")return console.log("‚úÖ Found room annotation:",i),i;if(o==="room_location"&&i.roomLocationId===e&&i.type==="location")return console.log("‚úÖ Found location annotation:",i),i;if(o==="cabinet_run"&&i.cabinetRunId===e&&i.type==="cabinet_run")return console.log("‚úÖ Found cabinet run annotation:",i),i}return console.log(`‚ùå No annotation found for ${o} with ID ${e}`),null}function we(o,e){if(!e.annotations)return null;console.log(`üîç [checkForDuplicateEntity] Checking for duplicates - mode: ${o}`);let n=null,i=null;if(o==="room")n="room",i=e.activeRoomId;else if(o==="location")n="room_location",i=e.activeLocationId;else if(o==="cabinet_run")n="cabinet_run",i=e.activeLocationId;else if(o==="cabinet")return null;if(!i)return console.log("‚úÖ No entity selected - allowing new entity creation"),null;const t=ye(n,i,e);return t?(console.log(`‚ö†Ô∏è Duplicate found! Entity ${i} already has annotation:`,t),t):(console.log("‚úÖ No duplicate found - safe to draw"),null)}function Ie(o,e){const n=o.color;o.color="#ff0000",setTimeout(()=>{o.color=n},2e3),console.log(`üéØ Highlighted annotation: ${o.label}`)}function on(o,e){var n;return e.activeAnnotationId===o.id||((n=e.selectedAnnotation)==null?void 0:n.id)===o.id?100:10}function nn(o,e){o.locked=!o.locked,console.log(`${o.locked?"üîí":"üîì"} ${o.locked?"Locked":"Unlocked"} annotation: ${o.label}`),o.locked&&e.activeAnnotationId===o.id&&(e.activeAnnotationId=null,e.selectedAnnotation=null)}const tn=Object.freeze(Object.defineProperty({__proto__:null,checkForDuplicateEntity:we,deleteAnnotation:ve,editAnnotation:O,findAnnotationByEntity:ye,getAnnotationZIndex:on,highlightAnnotation:Ie,loadAnnotations:b,saveAnnotations:pe,toggleLockAnnotation:nn},Symbol.toStringTag,{value:"Module"})),rn={room:0,room_location:1,cabinet_run:2,cabinet:3};function ln(o,e){const n=[],i=!!e.activeRoomId,t=!!e.activeLocationId,r=!!e.activeCabinetRunId,l=rn[o];return l===0||(l>=1&&!i&&n.push({type:"room",level:0,required:!0}),l>=2&&!t&&n.push({type:"room_location",level:1,required:!0}),l>=3&&!r&&n.push({type:"cabinet_run",level:2,required:!0}),console.log(`üîç [Hierarchy Detection] Drawing ${o}, missing levels:`,n)),n}function be(o,e,n){var u;if(!e.drawMode)return;$e(e);const i=(u=n.pdfEmbed)==null?void 0:u.querySelector("canvas");if(!i)return;const t=i.getBoundingClientRect(),r=o.clientX-t.left,l=o.clientY-t.top,a=i.offsetWidth/t.width,c=i.offsetHeight/t.height,s=r*a,d=l*c;e.isDrawing=!0,e.drawStart={x:s,y:d},e.drawPreview={x:s,y:d,width:0,height:0},console.log("üñ±Ô∏è Drawing started at",{x:s,y:d},"(layout space)")}function Re(o,e,n){var p;if(!e.isDrawing||!e.drawStart)return;const i=(p=n.pdfEmbed)==null?void 0:p.querySelector("canvas");if(!i)return;const t=i.getBoundingClientRect(),r=o.clientX-t.left,l=o.clientY-t.top,a=i.offsetWidth/t.width,c=i.offsetHeight/t.height,s=r*a,d=l*c,u=Math.min(e.drawStart.x,s),f=Math.min(e.drawStart.y,d),m=Math.abs(s-e.drawStart.x),y=Math.abs(d-e.drawStart.y);e.drawPreview={x:u,y:f,width:m,height:y}}function Se(o,e,n){if(!e.isDrawing||!e.drawPreview||!n.annotationOverlay)return;j(e);const i=20;if(e.drawPreview.width<i||e.drawPreview.height<i){console.log("‚ö†Ô∏è Rectangle too small, ignoring draw"),H(e);return}console.log("‚úì Drawing finished, creating annotation..."),cn(e,n),H(e)}function an(o){o.isDrawing&&(console.log("‚ùå Drawing cancelled (mouse left canvas)"),j(o),H(o))}function H(o){o.isDrawing=!1,o.drawStart=null,o.drawPreview=null}function cn(o,e){const n=o.drawPreview,i=h(n.x,n.y,e,o),t=h(n.x+n.width,n.y+n.height,e,o),r={x:n.x,y:n.y,width:n.width,height:n.height};let l=null;if(o.isolationMode)l=o.isolationLevel==="room"?o.isolatedRoomId:o.isolationLevel==="location"?o.isolatedLocationId:o.isolationLevel==="cabinet_run"?o.isolatedCabinetRunId:null,console.log(`üéØ [createAnnotation] Isolation mode - parentId: ${l}`);else if(o.drawMode==="location"&&o.activeRoomId){const d=te("room",o.activeRoomId,o);l=(d==null?void 0:d.id)||null,console.log(`üéØ [createAnnotation] Normal mode - drawing location under room ${o.activeRoomId}, found parent: ${l}`)}else if((o.drawMode==="cabinet_run"||o.drawMode==="cabinet")&&o.activeLocationId){const d=te("room_location",o.activeLocationId,o);l=(d==null?void 0:d.id)||null,console.log(`üéØ [createAnnotation] Normal mode - drawing ${o.drawMode} under location ${o.activeLocationId}, found parent: ${l}`)}let a=null;if(o.drawMode==="location")a=o.activeLocationId;else if(o.drawMode==="cabinet_run"||o.drawMode==="cabinet")if(o.isolationMode&&o.isolationLevel==="location"){const d=o.annotations.find(u=>u.id===o.isolatedLocationId);a=(d==null?void 0:d.roomLocationId)||null}else a=o.activeLocationId;const c={id:Ko("temp"),type:o.drawMode,pdfX:i.x,pdfY:i.y,pdfWidth:Math.abs(t.x-i.x),pdfHeight:Math.abs(i.y-t.y),normalizedX:i.normalized.x,normalizedY:i.normalized.y,screenX:r.x,screenY:r.y,screenWidth:r.width,screenHeight:r.height,roomId:o.activeRoomId,roomName:o.activeRoomName,roomLocationId:a,cabinetRunId:o.drawMode==="cabinet_run"?o.activeLocationId:o.drawMode==="cabinet"&&o.isolationMode&&o.isolationLevel==="cabinet_run"?o.isolatedCabinetRunId:null,locationId:o.activeLocationId,locationName:o.activeLocationName,viewType:"plan",label:sn(o),color:dn(o),createdAt:new Date,pdfPageId:o.pdfPageId,projectId:o.projectId,parentId:l};console.log("üìç [createAnnotation] roomLocationId set to:",a,"(activeLocationId:",o.activeLocationId,")"),o.annotations.push(c),console.log("‚úì Annotation created:",c);const s=ln(o.drawMode,o);s.length>0?(console.log("üèóÔ∏è Missing hierarchy detected, opening builder modal:",s),window.Livewire.dispatch("open-hierarchy-builder",{annotation:c,missingLevels:s,context:{projectId:o.projectId,roomId:o.activeRoomId,locationId:o.activeLocationId,cabinetRunId:o.activeCabinetRunId}})):(console.log("‚úÖ Complete hierarchy, opening annotation editor"),window.Livewire.dispatch("edit-annotation",{annotation:c}))}function sn(o){if(o.drawMode==="room")return o.activeRoomName||"Room";if(o.drawMode==="location")return`Location ${o.annotations.filter(n=>n.type==="location"&&n.roomId===o.activeRoomId).length+1}`;{const e=o.annotations.filter(n=>n.type===o.drawMode&&n.locationId===o.activeLocationId).length+1;return o.drawMode==="cabinet_run"?`Run ${e}`:`Cabinet ${e}`}}function dn(o){return Y(o.drawMode)}function Le(o,e,n,i){if(e.drawMode===o){e.drawMode=null;return}if(n){const t=n(o);if(t){window.FilamentNotification&&new window.FilamentNotification().title("Annotation Already Exists").warning().body(`${t.label} already has an annotation on this page. Highlighting it now.`).send(),i&&i(t);return}}e.drawMode=o}function _e(o){return(o.isolationMode&&o.isolationLevel==="room"||o.activeRoomId)&&o.pdfReady}function Ae(o){return(o.isolationMode&&o.isolationLevel==="location"||o.isolationMode&&o.isolationLevel==="cabinet_run"||o.activeRoomId&&o.activeLocationId)&&o.pdfReady}function ze(o){o.activeRoomId=null,o.activeRoomName="",o.activeLocationId=null,o.activeLocationName="",o.roomSearchQuery="",o.locationSearchQuery="",o.drawMode=null}function Ne(o){return o.activeRoomName?o.activeLocationName?`üè† ${o.activeRoomName} ‚Üí üìç ${o.activeLocationName}`:`üè† ${o.activeRoomName}`:"No context selected"}function te(o,e,n){if(!e||!n.annotations)return null;for(const i of n.annotations){if(o==="room"&&i.roomId===e&&i.type==="room")return i;if(o==="room_location"&&i.roomLocationId===e&&i.type==="location")return i;if(o==="cabinet_run"&&i.cabinetRunId===e&&i.type==="cabinet_run")return i}return null}function $e(o){o._drawingLockout===void 0&&(o._drawingLockout=!1,o._drawingLockoutTimer=null),o._drawingLockoutTimer&&(clearTimeout(o._drawingLockoutTimer),console.log("üîÑ Drawing lockout timer reset (micro-adjustment detected)")),o._drawingLockout=!0,o._drawingLockoutTimer=setTimeout(()=>{o._drawingLockout=!1,o._drawingLockoutTimer=null,console.log("‚úì Drawing lockout released (1s inactivity)")},1e3),console.log("üîí Drawing lockout activated")}function un(o){return o._drawingLockout===!0}function j(o){o._drawingLockoutTimer&&(clearTimeout(o._drawingLockoutTimer),o._drawingLockoutTimer=null),o._drawingLockout=!1,console.log("üîì Drawing lockout cleared")}function Te(o,e){!o||!o.type||(console.log("üéØ Setting drawing context from:",o.type,o.label||o.id),o.type==="room"?(e.activeRoomId=o.roomId,e.activeRoomName=o.label,e.roomSearchQuery=o.label,e.activeLocationId=null,e.activeLocationName="",e.locationSearchQuery="",console.log(`‚úì Context set: üè† ${o.label} (can now draw Locations)`)):o.type==="location"?(e.activeRoomId=o.roomId,e.activeRoomName=v(o.roomId,e),e.roomSearchQuery=e.activeRoomName,e.activeLocationId=o.roomLocationId||o.id,e.activeLocationName=o.label,e.locationSearchQuery=o.label,console.log(`‚úì Context set: üè† ${e.activeRoomName} ‚Üí üìç ${o.label} (can now draw Cabinet Runs)`)):o.type==="cabinet_run"?(e.activeRoomId=o.roomId,e.activeRoomName=v(o.roomId,e),e.roomSearchQuery=e.activeRoomName,e.activeLocationId=o.locationId||o.roomLocationId,e.activeLocationName=T(e.activeLocationId,e),e.locationSearchQuery=e.activeLocationName,e.activeCabinetRunId=o.cabinetRunId||o.id,e.activeCabinetRunName=o.label,console.log(`‚úì Context set: üè† ${e.activeRoomName} ‚Üí üìç ${e.activeLocationName} ‚Üí üóÑÔ∏è ${o.label} (can now draw Cabinets)`)):o.type==="cabinet"&&(e.activeRoomId=o.roomId,e.activeRoomName=v(o.roomId,e),e.roomSearchQuery=e.activeRoomName,e.activeLocationId=o.locationId,e.activeLocationName=T(o.locationId,e),e.locationSearchQuery=e.activeLocationName,e.activeCabinetRunId=o.cabinetRunId,e.activeCabinetRunName=Go(o.cabinetRunId,e),console.log(`‚úì Context set: üè† ${e.activeRoomName} ‚Üí üìç ${e.activeLocationName} ‚Üí üóÑÔ∏è ${e.activeCabinetRunName} ‚Üí üóÇÔ∏è ${o.label}`)))}const fn=Object.freeze(Object.defineProperty({__proto__:null,activateDrawingLockout:$e,canDraw:Ae,canDrawLocation:_e,cancelDrawing:an,clearContext:ze,clearDrawingLockout:j,finishDrawing:Se,getContextLabel:Ne,isDrawingLocked:un,setDrawMode:Le,setDrawingContextFromNode:Te,startDrawing:be,updateDrawPreview:Re},Symbol.toStringTag,{value:"Module"}));function Ce(o,e,n,i){o.stopPropagation(),Z(i),i.isResizing=!0,i.activeAnnotationId=e.id,i.resizeHandle=n,i.resizeStart={mouseX:o.clientX,mouseY:o.clientY,annoX:e.screenX,annoY:e.screenY,annoWidth:e.screenWidth,annoHeight:e.screenHeight},console.log("üîÑ Resize started:",{annotation:e.label,handle:n}),i._resizeMoveHandler=t=>xe(t,i),i._resizeEndHandler=t=>Pe(t,i,i._refs),document.addEventListener("mousemove",i._resizeMoveHandler),document.addEventListener("mouseup",i._resizeEndHandler),console.log("üìé Document resize listeners attached")}const xe=ge(function(o,e){!e.isResizing||!e.resizeStart||mn(o,e)},{},"resizeTicking");function mn(o,e){console.log("üîÑ [RESIZE] updateResize called",{isResizing:e.isResizing,hasResizeStart:!!e.resizeStart,lockoutActive:e._resizeLockout,activeAnnotationId:e.activeAnnotationId});const n=o.clientX-e.resizeStart.mouseX,i=o.clientY-e.resizeStart.mouseY,t=e.annotations.find(u=>u.id===e.activeAnnotationId);if(!t){console.warn("‚ö†Ô∏è [RESIZE] No annotation found for ID:",e.activeAnnotationId);return}let r=e.resizeStart.annoX,l=e.resizeStart.annoY,a=e.resizeStart.annoWidth,c=e.resizeStart.annoHeight;const s=e.resizeHandle;s.includes("w")?(r=e.resizeStart.annoX+n,a=e.resizeStart.annoWidth-n):s.includes("e")&&(a=e.resizeStart.annoWidth+n),s.includes("n")?(l=e.resizeStart.annoY+i,c=e.resizeStart.annoHeight-i):s.includes("s")&&(c=e.resizeStart.annoHeight+i);const d=20;if(a<d||c<d){console.log("‚ö†Ô∏è [RESIZE] Size too small, skipping update");return}console.log("üìè [RESIZE] Updating annotation dimensions",{annotation:t.label,newWidth:a.toFixed(1),newHeight:c.toFixed(1)}),t.screenX=r,t.screenY=l,t.screenWidth=a,t.screenHeight=c}function Pe(o,e,n){if(!e.isResizing)return;const i=e.annotations.find(t=>t.id===e.activeAnnotationId);if(i&&e.resizeStart){const t=Math.abs(i.screenWidth-e.resizeStart.annoWidth),r=Math.abs(i.screenHeight-e.resizeStart.annoHeight);if(!(t>2||r>2)){console.log("‚è∏Ô∏è Resize cancelled - no significant size change detected"),i.screenX=e.resizeStart.annoX,i.screenY=e.resizeStart.annoY,i.screenWidth=e.resizeStart.annoWidth,i.screenHeight=e.resizeStart.annoHeight,e.isResizing=!1,e.resizeHandle=null,e.resizeStart=null,e.activeAnnotationId=null,P(e),e._resizeMoveHandler&&(document.removeEventListener("mousemove",e._resizeMoveHandler),document.removeEventListener("mouseup",e._resizeEndHandler),e._resizeMoveHandler=null,e._resizeEndHandler=null,console.log("üîå Document resize listeners removed (cancelled)"));return}console.log("‚úì Resize finished, saving..."),gn(i,e,n)}e.isResizing=!1,e.resizeHandle=null,e.resizeStart=null,e.activeAnnotationId=null,e._resizeMoveHandler&&(document.removeEventListener("mousemove",e._resizeMoveHandler),document.removeEventListener("mouseup",e._resizeEndHandler),e._resizeMoveHandler=null,e._resizeEndHandler=null,console.log("üîå Document resize listeners removed"))}function gn(o,e,n){const i=h(o.screenX,o.screenY,n,e),t=h(o.screenX+o.screenWidth,o.screenY+o.screenHeight,n,e);o.pdfX=i.x,o.pdfY=i.y,o.pdfWidth=Math.abs(t.x-i.x),o.pdfHeight=Math.abs(i.y-t.y),o.normalizedX=i.normalized.x,o.normalizedY=i.normalized.y,console.log("‚úì Resize completed:",o.label),ke(o,e)}function Me(o,e,n){o.target.classList.contains("resize-handle")||(Z(n),n.isMoving=!0,n.activeAnnotationId=e.id,n.moveStart={mouseX:o.clientX,mouseY:o.clientY,annoX:e.screenX,annoY:e.screenY},console.log("üñ±Ô∏è Move started:",e.label),n._moveMoveHandler=i=>Ee(i,n),n._moveEndHandler=i=>De(i,n,n._refs),document.addEventListener("mousemove",n._moveMoveHandler),document.addEventListener("mouseup",n._moveEndHandler),console.log("üìé Document move listeners attached"))}const Ee=ge(function(o,e){!e.isMoving||!e.moveStart||hn(o,e)},{},"moveTicking");function hn(o,e){console.log("üñ±Ô∏è [MOVE] updateMove called",{isMoving:e.isMoving,hasMoveStart:!!e.moveStart,lockoutActive:e._resizeLockout,activeAnnotationId:e.activeAnnotationId});const n=o.clientX-e.moveStart.mouseX,i=o.clientY-e.moveStart.mouseY,t=e.annotations.find(r=>r.id===e.activeAnnotationId);if(!t){console.warn("‚ö†Ô∏è [MOVE] No annotation found for ID:",e.activeAnnotationId);return}console.log("üìç [MOVE] Updating annotation position",{annotation:t.label,deltaX:n.toFixed(1),deltaY:i.toFixed(1)}),t.screenX=e.moveStart.annoX+n,t.screenY=e.moveStart.annoY+i}function De(o,e,n){if(!e.isMoving)return;const i=e.annotations.find(t=>t.id===e.activeAnnotationId);if(i&&e.moveStart){const t=Math.abs(i.screenX-e.moveStart.annoX),r=Math.abs(i.screenY-e.moveStart.annoY);if(!(t>2||r>2)){console.log("‚è∏Ô∏è Move cancelled - no significant movement detected"),i.screenX=e.moveStart.annoX,i.screenY=e.moveStart.annoY,e.isMoving=!1,e.moveStart=null,e.activeAnnotationId=null,P(e),e._moveMoveHandler&&(document.removeEventListener("mousemove",e._moveMoveHandler),document.removeEventListener("mouseup",e._moveEndHandler),e._moveMoveHandler=null,e._moveEndHandler=null,console.log("üîå Document move listeners removed (cancelled)"));return}console.log("‚úì Move finished, saving..."),pn(i,e,n)}e.isMoving=!1,e.moveStart=null,e.activeAnnotationId=null,e._moveMoveHandler&&(document.removeEventListener("mousemove",e._moveMoveHandler),document.removeEventListener("mouseup",e._moveEndHandler),e._moveMoveHandler=null,e._moveEndHandler=null,console.log("üîå Document move listeners removed"))}function pn(o,e,n){const i=h(o.screenX,o.screenY,n,e);o.pdfX=i.x,o.pdfY=i.y,o.normalizedX=i.normalized.x,o.normalizedY=i.normalized.y,console.log("‚úì Move completed:",o.label),ke(o,e)}function ke(o,e){console.log("üíæ [SAVE] debouncedSaveAnnotation called",{annotation:o.label,lockoutActive:e._resizeLockout,hasPendingTimeout:!!e.resizeSaveTimeout,isResizing:e.isResizing,isMoving:e.isMoving}),e._resizeLockout&&console.warn("‚ö†Ô∏è [SAVE] Resize lockout active - save requested during active resize/move!"),e.resizeSaveTimeout&&(console.log("üîÑ [SAVE] Clearing existing save timeout"),clearTimeout(e.resizeSaveTimeout)),e.pendingResizeChanges=o,e.resizeSaveTimeout=setTimeout(async()=>{var n;console.log("‚è∞ [SAVE] Save timeout fired",{annotation:(n=e.pendingResizeChanges)==null?void 0:n.label,lockoutActive:e._resizeLockout,isResizing:e.isResizing,isMoving:e.isMoving}),e.pendingResizeChanges&&(await vn(e.pendingResizeChanges,e),e.pendingResizeChanges=null,P(e))},1e3),console.log("‚úì [SAVE] Save scheduled for 1s from now")}async function vn(o,e){if(console.log("üåê [API] saveAnnotationToServer called",{annotation:o.label,annotationId:o.id,lockoutActive:e._resizeLockout,isResizing:e.isResizing,isMoving:e.isMoving}),o.id.toString().startsWith("temp_")){console.log("‚è≠Ô∏è [API] Skipping save for temporary annotation");return}console.log("üì§ [API] Sending PATCH request to server...");try{const i=await(await fetch(`/api/pdf/page/annotations/${o.id}`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":I()},body:JSON.stringify({x:o.normalizedX,y:o.normalizedY,width:o.pdfWidth/e.pageDimensions.width,height:o.pdfHeight/e.pageDimensions.height})})).json();if(i.success)console.log("‚úÖ [API] Annotation saved successfully:",o.label);else throw new Error(i.error||"Failed to save annotation")}catch(n){console.error("‚ùå [API] Failed to save annotation:",n)}}function yn(o){return{n:"n-resize",ne:"ne-resize",e:"e-resize",se:"se-resize",s:"s-resize",sw:"sw-resize",w:"w-resize",nw:"nw-resize"}[o]||"default"}function wn(){return["n","ne","e","se","s","sw","w","nw"]}function In(o,e=8){const n=e/2;return{n:{left:"50%",top:`-${n}px`,transform:"translateX(-50%)"},ne:{right:`-${n}px`,top:`-${n}px`},e:{right:`-${n}px`,top:"50%",transform:"translateY(-50%)"},se:{right:`-${n}px`,bottom:`-${n}px`},s:{left:"50%",bottom:`-${n}px`,transform:"translateX(-50%)"},sw:{left:`-${n}px`,bottom:`-${n}px`},w:{left:`-${n}px`,top:"50%",transform:"translateY(-50%)"},nw:{left:`-${n}px`,top:`-${n}px`}}[o]||{}}function Z(o){o._resizeLockout===void 0&&(o._resizeLockout=!1),o._resizeLockout||(o._resizeLockout=!0,console.log("üîí Resize lockout activated (stays active until save completes)"))}function bn(o){return o._resizeLockout===!0}function P(o){o._resizeLockout&&(o._resizeLockout=!1,console.log("üîì Resize lockout cleared (save complete)"))}function Oe(o,e){if(!e.isResizing||!e.resizeStart)return;const n=o.clientX-e.resizeStart.mouseX,i=o.clientY-e.resizeStart.mouseY,t=e.annotations.find(u=>u.id===e.activeAnnotationId);if(!t)return;let r=e.resizeStart.annoX,l=e.resizeStart.annoY,a=e.resizeStart.annoWidth,c=e.resizeStart.annoHeight;const s=e.resizeHandle;s.includes("w")?(r=e.resizeStart.annoX+n,a=e.resizeStart.annoWidth-n):s.includes("e")&&(a=e.resizeStart.annoWidth+n),s.includes("n")?(l=e.resizeStart.annoY+i,c=e.resizeStart.annoHeight-i):s.includes("s")&&(c=e.resizeStart.annoHeight+i);const d=20;a<d||c<d||(t.screenX=r,t.screenY=l,t.screenWidth=a,t.screenHeight=c)}function He(o,e){if(!e.isMoving||!e.moveStart)return;const n=o.clientX-e.moveStart.mouseX,i=o.clientY-e.moveStart.mouseY,t=e.annotations.find(r=>r.id===e.activeAnnotationId);t&&(t.screenX=e.moveStart.annoX+n,t.screenY=e.moveStart.annoY+i)}function Ve(o,e,n){if(e.isResizing){const i=e.annotations.find(t=>t.id===e.activeAnnotationId);if(i){const t=h(i.screenX,i.screenY,n,e),r=h(i.screenX+i.screenWidth,i.screenY+i.screenHeight,n,e);i.pdfX=t.x,i.pdfY=t.y,i.pdfWidth=Math.abs(r.x-t.x),i.pdfHeight=Math.abs(t.y-r.y),i.normalizedX=t.normalized.x,i.normalizedY=t.normalized.y}e.isResizing=!1,e.resizeHandle=null,e.resizeStart=null,e.activeAnnotationId=null}else if(e.isMoving){const i=e.annotations.find(t=>t.id===e.activeAnnotationId);if(i){const t=h(i.screenX,i.screenY,n,e);i.pdfX=t.x,i.pdfY=t.y,i.normalizedX=t.normalized.x,i.normalizedY=t.normalized.y}e.isMoving=!1,e.moveStart=null,e.activeAnnotationId=null}}const Rn=Object.freeze(Object.defineProperty({__proto__:null,activateResizeLockout:Z,clearResizeLockout:P,finishResizeOrMove:Ve,getHandlePosition:In,getResizeCursor:yn,getResizeHandles:wn,handleMove:He,handleMoveEnd:De,handleMoveUpdate:Ee,handleResize:Oe,handleResizeEnd:Pe,handleResizeMove:xe,isResizeLocked:bn,startMove:Me,startResize:Ce},Symbol.toStringTag,{value:"Module"}));function Sn(o,e){if(o.isUndoRedoAction)return;const n={annotations:_(o.annotations),timestamp:Date.now(),action:e};o.historyIndex<o.historyStack.length-1&&(o.historyStack=o.historyStack.slice(0,o.historyIndex+1)),o.historyStack.push(n),o.historyStack.length>o.maxHistorySize?o.historyStack.shift():o.historyIndex++,console.log(`üìö History: ${e} (${o.historyIndex+1}/${o.historyStack.length})`)}function B(o){if(!M(o)){console.log("‚èÆÔ∏è Nothing to undo");return}o.historyIndex--;const e=o.historyStack[o.historyIndex];o.isUndoRedoAction=!0,o.annotations=_(e.annotations),o.isUndoRedoAction=!1,console.log(`‚èÆÔ∏è Undo: ${e.action} (${o.historyIndex+1}/${o.historyStack.length})`)}function Q(o){if(!E(o)){console.log("‚è≠Ô∏è Nothing to redo");return}o.historyIndex++;const e=o.historyStack[o.historyIndex];o.isUndoRedoAction=!0,o.annotations=_(e.annotations),o.isUndoRedoAction=!1,console.log(`‚è≠Ô∏è Redo: ${e.action} (${o.historyIndex+1}/${o.historyStack.length})`)}function M(o){return o.historyIndex>0}function E(o){return o.historyIndex<o.historyStack.length-1}function Ln(o){o.historyStack=[],o.historyIndex=-1,console.log("üóëÔ∏è History cleared")}function _n(o){var e,n,i;return{size:o.historyStack.length,index:o.historyIndex,canUndo:M(o),canRedo:E(o),current:((e=o.historyStack[o.historyIndex])==null?void 0:e.action)||"none",next:((n=o.historyStack[o.historyIndex+1])==null?void 0:n.action)||"none",previous:((i=o.historyStack[o.historyIndex-1])==null?void 0:i.action)||"none"}}function Fe(o){document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.key==="z"&&!e.shiftKey&&(e.preventDefault(),B(o)),(e.ctrlKey||e.metaKey)&&(e.shiftKey&&e.key==="z"||e.key==="y")&&(e.preventDefault(),Q(o))}),console.log("‚å®Ô∏è Undo/Redo keyboard shortcuts registered")}const An=Object.freeze(Object.defineProperty({__proto__:null,canRedo:E,canUndo:M,clearHistory:Ln,getHistoryInfo:_n,pushToHistory:Sn,redo:Q,setupUndoRedoKeyboards:Fe,undo:B},Symbol.toStringTag,{value:"Module"}));async function R(o,e,n){if(console.log("üîí Entering isolation mode for:",o.type,o.label),e.isolationViewType=e.activeViewType,e.isolationOrientation=e.activeOrientation,console.log(`üìê Isolation view context: ${e.isolationViewType}${e.isolationOrientation?` (${e.isolationOrientation})`:""}`),o.type==="cabinet_run")e.isolationMode=!0,e.isolationLevel="cabinet_run",e.isolatedRoomId=o.roomId,e.isolatedRoomName=o.roomName||v(o.roomId,e),e.isolatedLocationId=o.locationId||o.roomLocationId,e.isolatedLocationName=o.locationName||T(o.locationId||o.roomLocationId,e),e.isolatedCabinetRunId=o.id,e.isolatedCabinetRunEntityId=o.cabinetRunId,e.isolatedCabinetRunName=o.label,e.activeRoomId=o.roomId,e.activeRoomName=e.isolatedRoomName,e.activeLocationId=o.locationId||o.roomLocationId,e.activeLocationName=e.isolatedLocationName,e.roomSearchQuery=e.isolatedRoomName,e.locationSearchQuery=e.isolatedLocationName,console.log(`‚úì Cabinet Run isolation: üè† ${e.isolatedRoomName} ‚Üí üìç ${e.isolatedLocationName} ‚Üí üóÑÔ∏è ${o.label}`);else if(o.type==="location")e.isolationMode=!0,e.isolationLevel="location",e.isolatedRoomId=o.roomId,e.isolatedRoomName=o.roomName||v(o.roomId,e),e.isolatedLocationId=o.id,e.isolatedLocationName=o.label,e.isolatedCabinetRunId=null,e.isolatedCabinetRunEntityId=null,e.isolatedCabinetRunName="",e.activeRoomId=o.roomId,e.activeRoomName=e.isolatedRoomName,e.activeLocationId=o.roomLocationId,e.activeLocationName=o.label,e.roomSearchQuery=e.isolatedRoomName,e.locationSearchQuery=o.label,console.log(`‚úì Location isolation: üè† ${e.isolatedRoomName} ‚Üí üìç ${o.label} (entity ID: ${o.roomLocationId})`);else{const i=o.type==="room"?o.id:o.roomId,t=o.roomId,r=o.type==="room"?o.label:o.roomName||v(o.roomId,e);e.isolationMode=!0,e.isolationLevel="room",e.isolatedRoomId=i,e.isolatedRoomEntityId=t,e.isolatedRoomName=r,e.isolatedLocationId=null,e.isolatedLocationName="",e.isolatedCabinetRunId=null,e.isolatedCabinetRunEntityId=null,e.isolatedCabinetRunName="",e.activeRoomId=t,e.activeRoomName=r,e.activeLocationId=null,e.activeLocationName="",e.locationSearchQuery="",e.roomSearchQuery=r,console.log(`‚úì Room isolation: üè† ${r} (annoId: ${i}, entityId: ${t})`)}e.expandedNodes.includes(e.isolatedRoomId)||e.expandedNodes.push(e.isolatedRoomId),e.isolatedLocationId&&!e.expandedNodes.includes(e.isolatedLocationId)&&e.expandedNodes.push(e.isolatedLocationId),e.isolatedCabinetRunId&&!e.expandedNodes.includes(e.isolatedCabinetRunId)&&e.expandedNodes.push(e.isolatedCabinetRunId),e.selectedNodeId=e.isolationLevel==="cabinet_run"?e.isolatedCabinetRunId:e.isolationLevel==="location"?e.isolatedLocationId:e.isolatedRoomId,zn(e),n.zoomToFitAnnotation&&await n.zoomToFitAnnotation(o),n.$nextTick&&await n.$nextTick(),await new Promise(i=>setTimeout(i,100)),n.syncOverlayToCanvas&&n.syncOverlayToCanvas(),n.$nextTick&&await n.$nextTick(),await new Promise(i=>setTimeout(i,150)),A(e)}async function Xe(o,e){console.log("üîì Exiting isolation mode"),o.isolationMode=!1,o.isolationLevel=null,o.isolatedRoomId=null,o.isolatedRoomName="",o.isolatedLocationId=null,o.isolatedLocationName="",o.isolatedCabinetRunId=null,o.isolatedCabinetRunEntityId=null,o.isolatedCabinetRunName="",o.isolationViewType=null,o.isolationOrientation=null,e.clearContext&&e.clearContext(),o.selectedNodeId=null,console.log(`üëÅÔ∏è [EXIT ISOLATION] Clearing hidden annotations (was: [${o.hiddenAnnotations.join(", ")}])`),o.hiddenAnnotations=[],e.resetZoom&&await e.resetZoom(),console.log("‚úì Returned to normal view with reset zoom"),A(o)}function zn(o){o.hiddenAnnotations=[],o.annotations.forEach(e=>{U(e,o)||(console.log(`üëÅÔ∏è [ENTER ISOLATION] Hiding annotation ${e.id} (${e.label} - type: ${e.type})`),o.hiddenAnnotations.push(e.id))}),console.log(`üëÅÔ∏è [ENTER ISOLATION] Hidden annotations: [${o.hiddenAnnotations.join(", ")}]`)}function U(o,e){return e.isolationMode?Nn(o,e)?e.isolationLevel==="room"?o.id===e.isolatedRoomId||o.type==="location"&&o.roomId===e.isolatedRoomEntityId:e.isolationLevel==="location"?o.type==="cabinet_run"&&o.roomLocationId===e.activeLocationId:e.isolationLevel==="cabinet_run"?o.type==="cabinet"&&o.cabinetRunId===e.isolatedCabinetRunEntityId:!0:!1:o.type==="room"||o.type==="location"}function Nn(o,e){const n=e.isolationMode?e.isolationViewType:e.activeViewType,i=e.isolationMode?e.isolationOrientation:e.activeOrientation;return!n||!o.viewType?!0:!(o.viewType!==n||(n==="elevation"||n==="section")&&i&&o.orientation!==i)}function A(o){const e=document.getElementById("maskRects");if(!e)return;e.innerHTML="",console.log(`üìê [MASK UPDATE] Overlay dimensions: ${o.overlayWidth} √ó ${o.overlayHeight}`);const n=o.annotations.filter(t=>!o.hiddenAnnotations.includes(t.id));let i=null;if(o.isolationMode&&(o.isolationLevel==="room"?i=o.annotations.find(t=>t.type==="room"&&t.roomId===o.isolatedRoomId):o.isolationLevel==="location"?i=o.annotations.find(t=>t.type==="location"&&t.roomLocationId===o.isolatedLocationId):o.isolationLevel==="cabinet_run"&&(i=o.annotations.find(t=>t.type==="cabinet_run"&&t.cabinetRunId===o.isolatedCabinetRunId))),i&&i.screenX!==void 0){const t=re(i);e.appendChild(t),console.log(`‚úì Added isolated entity boundary to mask: ${i.label}`)}n.forEach(t=>{if(t.screenX!==void 0&&t.screenWidth>0&&t.screenHeight>0){const r=re(t);e.appendChild(r)}})}function re(o){const n=(o.screenX||0)-15,i=(o.screenY||0)-15,t=(o.screenWidth||0)+15*2,r=(o.screenHeight||0)+15*2;return qo("rect",{x:n,y:i,width:t,height:r,fill:"black",rx:"8",filter:"url(#feather)"})}function Ye(o){if(!o.isolationMode)return[];const e=[];return o.isolatedRoomName&&e.push({label:o.isolatedRoomName,level:"room",icon:"üè†"}),o.isolatedLocationName&&e.push({label:o.isolatedLocationName,level:"location",icon:"üìç"}),o.isolatedCabinetRunName&&e.push({label:o.isolatedCabinetRunName,level:"cabinet_run",icon:"üóÑÔ∏è"}),e}const We=Object.freeze(Object.defineProperty({__proto__:null,enterIsolationMode:R,exitIsolationMode:Xe,getIsolationBreadcrumbs:Ye,isAnnotationVisibleInIsolation:U,updateIsolationMask:A},Symbol.toStringTag,{value:"Module"}));function je(o){let e=[...o.annotations];if(o.filterScope==="page"&&(e=e.filter(n=>n.pageNumber===o.currentPage)),o.filters.types.length>0&&(e=e.filter(n=>o.filters.types.includes(n.type))),o.filters.rooms.length>0&&(e=e.filter(n=>o.filters.rooms.includes(n.roomId))),o.filters.locations.length>0&&(e=e.filter(n=>o.filters.locations.includes(n.locationId))),o.filters.viewTypes.length>0&&(e=e.filter(n=>o.filters.viewTypes.includes(n.viewType))),o.filters.verticalZones.length>0&&(e=e.filter(n=>o.filters.verticalZones.includes(n.verticalZone))),o.filters.myAnnotations){const n=window.currentUserId;e=e.filter(i=>i.createdBy===n)}if(o.filters.recent){const n=new Date;n.setDate(n.getDate()-1),e=e.filter(i=>new Date(i.createdAt)>n)}if(o.filters.unlinked&&(e=e.filter(n=>!n.roomId&&!n.locationId&&!n.cabinetRunId)),o.filters.pageRange.from||o.filters.pageRange.to){const n=o.filters.pageRange.from||1,i=o.filters.pageRange.to||o.totalPages;e=e.filter(t=>t.pageNumber>=n&&t.pageNumber<=i)}if(o.filters.dateRange.from||o.filters.dateRange.to){const n=o.filters.dateRange.from?new Date(o.filters.dateRange.from):new Date(0),i=o.filters.dateRange.to?new Date(o.filters.dateRange.to):new Date;e=e.filter(t=>{const r=new Date(t.createdAt);return r>=n&&r<=i})}return e}function K(o){let e=0;return o.filterScope==="all"&&e++,e+=o.filters.types.length,e+=o.filters.rooms.length,e+=o.filters.locations.length,e+=o.filters.viewTypes.length,e+=o.filters.verticalZones.length,o.filters.myAnnotations&&e++,o.filters.recent&&e++,o.filters.unlinked&&e++,(o.filters.pageRange.from||o.filters.pageRange.to)&&e++,(o.filters.dateRange.from||o.filters.dateRange.to)&&e++,e}function Ze(o){const e=[];if(o.filterScope==="all"&&e.push({type:"scope",label:"All Pages",key:"filterScope"}),o.filters.types.forEach(n=>{e.push({type:"array",arrayKey:"types",value:n,label:`Type: ${$n(n)}`})}),o.filters.rooms.forEach(n=>{const i=v(n,o);e.push({type:"array",arrayKey:"rooms",value:n,label:`Room: ${i}`})}),o.filters.locations.forEach(n=>{const i=T(n,o);e.push({type:"array",arrayKey:"locations",value:n,label:`Location: ${i}`})}),o.filters.viewTypes.forEach(n=>{e.push({type:"array",arrayKey:"viewTypes",value:n,label:`View: ${Tn(n)}`})}),o.filters.verticalZones.forEach(n=>{e.push({type:"array",arrayKey:"verticalZones",value:n,label:`Zone: ${n}`})}),o.filters.myAnnotations&&e.push({type:"boolean",key:"myAnnotations",label:"My Work"}),o.filters.recent&&e.push({type:"boolean",key:"recent",label:"Recent (24h)"}),o.filters.unlinked&&e.push({type:"boolean",key:"unlinked",label:"Unlinked"}),o.filters.pageRange.from||o.filters.pageRange.to){const n=o.filters.pageRange.from||1,i=o.filters.pageRange.to||o.totalPages;e.push({type:"range",key:"pageRange",label:`Pages ${n}-${i}`})}if(o.filters.dateRange.from||o.filters.dateRange.to){const n=o.filters.dateRange.from||"start",i=o.filters.dateRange.to||"end";e.push({type:"range",key:"dateRange",label:`Date: ${n} to ${i}`})}return e}function Be(o){const e=new Set,n=new Map,i=new Map,t=new Set,r=new Set;return o.annotations.forEach(l=>{l.type&&e.add(l.type),l.roomId&&l.roomName&&n.set(l.roomId,l.roomName),l.locationId&&l.locationName&&i.set(l.locationId,l.locationName),l.viewType&&t.add(l.viewType),l.verticalZone&&r.add(l.verticalZone)}),{types:Array.from(e).sort(),rooms:Array.from(n.entries()).map(([l,a])=>({id:l,name:a})).sort((l,a)=>l.name.localeCompare(a.name)),locations:Array.from(i.entries()).map(([l,a])=>({id:l,name:a})).sort((l,a)=>l.name.localeCompare(a.name)),viewTypes:Array.from(t).sort(),verticalZones:Array.from(r).sort()}}function q(o){o.filterScope="page",o.filters.types=[],o.filters.rooms=[],o.filters.locations=[],o.filters.viewTypes=[],o.filters.verticalZones=[],o.filters.myAnnotations=!1,o.filters.recent=!1,o.filters.unlinked=!1,o.filters.pageRange.from=null,o.filters.pageRange.to=null,o.filters.dateRange.from=null,o.filters.dateRange.to=null,console.log("‚úì All filters cleared")}function Qe(o,e){if(o.type==="boolean")e.filters[o.key]=!1;else if(o.type==="array"){const n=e.filters[o.arrayKey].indexOf(o.value);n>-1&&e.filters[o.arrayKey].splice(n,1)}else o.type==="scope"?e.filterScope="page":o.type==="range"&&(o.key==="pageRange"?(e.filters.pageRange.from=null,e.filters.pageRange.to=null):o.key==="dateRange"&&(e.filters.dateRange.from=null,e.filters.dateRange.to=null));console.log("‚úì Filter removed:",o.label)}function Ue(o,e){switch(q(e),o){case"myWork":e.filters.myAnnotations=!0;break;case"recent":e.filters.recent=!0;break;case"unlinked":e.filters.unlinked=!0;break}console.log("‚úì Preset applied:",o)}function Ke(o,e){const n=K(e);switch(o){case"myWork":return e.filters.myAnnotations&&n===1;case"recent":return e.filters.recent&&n===1;case"unlinked":return e.filters.unlinked&&n===1;case"all":return n===0;default:return!1}}function qe(o){if(o.filters.viewTypes.length===0)return Array.from({length:o.totalPages},(n,i)=>i+1);const e=new Set;return Object.entries(o.pageMap).forEach(([n,i])=>{o.annotations.some(r=>r.pageNumber===parseInt(n)&&o.filters.viewTypes.includes(r.viewType))&&e.add(parseInt(n))}),Array.from(e).sort((n,i)=>n-i)}function $n(o){return{room:"Room",location:"Location",cabinet_run:"Cabinet Run",cabinet:"Cabinet"}[o]||o}function Tn(o){return{plan:"Plan",elevation:"Elevation",section:"Section",detail:"Detail"}[o]||o}const Cn=Object.freeze(Object.defineProperty({__proto__:null,applyFilterPreset:Ue,clearAllFilters:q,countActiveFilters:K,getActiveFilterChips:Ze,getAvailableFilterOptions:Be,getFilteredAnnotations:je,getFilteredPageNumbers:qe,isPresetActive:Ke,removeFilterChip:Qe},Symbol.toStringTag,{value:"Module"}));async function C(o){o.loading=!0;try{const n=await(await fetch(`/api/projects/${o.projectId}/tree`)).json();o.tree=Ge(n),o.treeReady=!0,console.log("‚úì Tree loaded:",o.tree)}catch(e){o.error="Failed to load project tree",console.error(e)}finally{o.loading=!1}}async function G(o,e={}){if(o._resizeLockout||o.isResizing||o.isMoving){console.log("‚è≥ Tree refresh deferred - resize/move in progress"),setTimeout(()=>G(o,e),100);return}console.log("üå≥ Refreshing project tree"),await C(o),(e.$refs||null)&&(e.$nextTick&&await e.$nextTick(),e.syncOverlayToCanvas&&e.syncOverlayToCanvas(),console.log("‚úì Annotation positions recalculated after tree refresh"))}function Ge(o){return Array.isArray(o)?o.map(e=>{const n={...e};return n.children?Array.isArray(n.children)&&(n.children=Ge(n.children)):n.children=[],n}):[]}function Je(o,e){const n=e.expandedNodes.indexOf(o);n>-1?e.expandedNodes.splice(n,1):e.expandedNodes.push(o)}function eo(o,e){return e.expandedNodes.includes(o)}async function oo(o,e,n){var m,y,p,oe,ne;const{nodeId:i,type:t,name:r,parentRoomId:l=null,parentLocationId:a=null,parentCabinetRunId:c=null}=o;e.selectedNodeId=i;const s=[];let d=null,u=null,f=null;if(t==="room")s.push(i),e.activeRoomId=i,e.activeRoomName=r,e.roomSearchQuery=r,e.activeLocationId=null,e.activeLocationName="",e.locationSearchQuery="",d=e.tree.find(g=>g.id===i);else if(t==="room_location")l&&s.push(l),s.push(i),e.activeRoomId=l,e.activeLocationId=i,e.activeLocationName=r,e.locationSearchQuery=r,f=e.tree.find(g=>g.id===l),f&&(e.activeRoomName=f.name,e.roomSearchQuery=f.name,d=(m=f.children)==null?void 0:m.find(g=>g.id===i));else if(t==="cabinet_run")l&&s.push(l),a&&s.push(a),s.push(i),e.activeRoomId=l,e.activeLocationId=a,e.activeCabinetRunId=i,e.activeCabinetRunName=r,f=e.tree.find(g=>g.id===l),f&&(e.activeRoomName=f.name,e.roomSearchQuery=f.name,u=(y=f.children)==null?void 0:y.find(g=>g.id===a),u&&(e.activeLocationName=u.name,e.locationSearchQuery=u.name,d=(p=u.children)==null?void 0:p.find(g=>g.id===i)));else if(t==="cabinet"&&(l&&s.push(l),a&&s.push(a),c&&s.push(c),s.push(i),e.activeRoomId=l,e.activeLocationId=a,e.activeCabinetRunId=c,e.activeCabinetId=i,e.activeCabinetName=r,f=e.tree.find(g=>g.id===l),f&&(e.activeRoomName=f.name,e.roomSearchQuery=f.name,u=(oe=f.children)==null?void 0:oe.find(g=>g.id===a),u))){e.activeLocationName=u.name,e.locationSearchQuery=u.name;const g=(ne=u.children)==null?void 0:ne.find(xo=>xo.id===c);g&&(e.activeCabinetRunName=g.name)}e.selectedPath=s,n.navigateToNodePage&&await n.navigateToNodePage(d,u,f),console.log("üå≥ Selected node:",{nodeId:i,type:t,name:r,path:s})}async function J(o,e,n,i,t){const r=i.activeViewType;let l=null;if(o&&o.pages&&o.pages.length>0){const a=o.pages.find(c=>c.viewType===r);a&&(l=a.page,console.log(`üìç Found ${r} view on ${o.name} at page ${l}`))}if(!l&&e&&e.pages&&e.pages.length>0){const a=e.pages.find(c=>c.viewType===r);a&&(l=a.page,console.log(`üìç Found ${r} view on parent location ${e.name} at page ${l}`))}if(!l&&n&&n.pages&&n.pages.length>0){const a=n.pages.find(c=>c.viewType===r);a&&(l=a.page,console.log(`üìç Found ${r} view on parent room ${n.name} at page ${l}`))}!l&&o&&o.pages&&o.pages.length>0&&(l=o.pages[0].page,console.log(`üìç No ${r} view found, using first available page ${l}`)),l&&l!==i.currentPage&&t.goToPage&&await t.goToPage(l)}function no(o,e,n){const{nodeId:i,nodeType:t,nodeName:r,parentRoomId:l=null,parentLocationId:a=null}=e;console.log("üñ±Ô∏è Right-click detected!",{nodeId:i,nodeType:t,nodeName:r}),n.contextMenu={show:!0,x:o.clientX,y:o.clientY,nodeId:i,nodeType:t,nodeName:r,parentRoomId:l,parentLocationId:a},console.log("‚úì Context menu state updated:",n.contextMenu)}async function io(o,e){const{nodeId:n,nodeType:i,nodeName:t}=o.contextMenu;if(!confirm(`Are you sure you want to delete "${t}"? This will also delete all associated annotations and data.`)){o.contextMenu.show=!1;return}console.log(`üóëÔ∏è Deleting ${i}:`,n);try{let r="";i==="room"?r=`/api/project/room/${n}`:i==="room_location"?r=`/api/project/location/${n}`:i==="cabinet_run"&&(r=`/api/project/cabinet-run/${n}`);const a=await(await fetch(r,{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":I()}})).json();if(a.success)console.log(`‚úì ${i} deleted successfully`),o.contextMenu.show=!1,e&&await e(),o.selectedNodeId===n&&(o.activeRoomId=null,o.activeRoomName="",o.activeLocationId=null,o.activeLocationName="",o.roomSearchQuery="",o.locationSearchQuery="",o.drawMode=null,o.selectedNodeId=null);else throw new Error(a.error||`Failed to delete ${i}`)}catch(r){console.error(`Failed to delete ${i}:`,r),alert(`Error deleting ${i}: ${r.message}`),o.contextMenu.show=!1}}async function to(o,e,n){var d,u,f;const{nodeId:i,nodeType:t,parentRoomId:r=null,parentLocationId:l=null}=o;let a=null,c=null,s=null;t==="room"?a=e.tree.find(m=>m.id===i):t==="room_location"?(s=e.tree.find(m=>m.id===r),s&&(a=(d=s.children)==null?void 0:d.find(m=>m.id===i))):t==="cabinet_run"&&(s=e.tree.find(m=>m.id===r),s&&(c=(u=s.children)==null?void 0:u.find(m=>m.id===l),c&&(a=(f=c.children)==null?void 0:f.find(m=>m.id===i)))),(a||c||s)&&await J(a,c,s,e,n)}function ro(o){const e=new Map;o.forEach(i=>{e.set(i.id,{...i,children:[]})});const n=[];return e.forEach(i=>{i.parentId&&e.has(i.parentId)?e.get(i.parentId).children.push(i):n.push(i)}),n}function lo(o){const e=new Map;return Object.keys(o.pageMap).forEach(i=>{e.set(parseInt(i),{pageNumber:parseInt(i),annotations:[]})}),(o.filteredAnnotations||o.annotations).forEach(i=>{const t=i.pageNumber||o.currentPage;e.has(t)?e.get(t).annotations.push(i):e.set(t,{pageNumber:t,annotations:[i]})}),e.forEach((i,t)=>{i.annotations=ro(i.annotations)}),Array.from(e.values()).sort((i,t)=>i.pageNumber-t.pageNumber)}const xn=Object.freeze(Object.defineProperty({__proto__:null,buildAnnotationTree:ro,deleteTreeNode:io,getPageGroupedAnnotations:lo,isExpanded:eo,loadTree:C,navigateOnDoubleClick:to,navigateToNodePage:J,refreshTree:G,selectNode:oo,showContextMenu:no,toggleNode:Je},Symbol.toStringTag,{value:"Module"}));async function ao(o,e){if(o.navigating){console.log("‚è∏Ô∏è Navigation already in progress");return}const n=e.getFilteredPageNumbers?e.getFilteredPageNumbers():D(o);if(n.length===0){console.log("‚ö†Ô∏è No pages match the current filter criteria");return}const i=n.indexOf(o.currentPage);if(i<n.length-1){o.navigating=!0;try{const t=n[i+1];await ee(t,o,e)}finally{o.navigating=!1}}else console.log("üìÑ Already at last page matching filters")}async function co(o,e){if(o.navigating){console.log("‚è∏Ô∏è Navigation already in progress");return}const n=e.getFilteredPageNumbers?e.getFilteredPageNumbers():D(o);if(n.length===0){console.log("‚ö†Ô∏è No pages match the current filter criteria");return}const i=n.indexOf(o.currentPage);if(i>0){o.navigating=!0;try{const t=n[i-1];await ee(t,o,e)}finally{o.navigating=!1}}else console.log("üìÑ Already at first page matching filters")}async function so(o,e,n){if(e.navigating){console.log("‚è∏Ô∏è Navigation already in progress");return}if(o<1||o>e.totalPages){console.warn(`‚ö†Ô∏è Invalid page number: ${o}`);return}e.navigating=!0;try{await ee(o,e,n)}finally{e.navigating=!1}}async function ee(o,e,n){console.log(`üìÑ Navigating to page ${o}`),e.currentPage=o,Pn(o,e),e.annotations=[],n.displayPdf&&await n.displayPdf(),n.loadAnnotations&&await n.loadAnnotations(),console.log(`‚úì Navigated to page ${o}`)}function Pn(o,e){const n=e.pageMap[o];n?(e.pdfPageId=n,console.log(`‚úì Updated pdfPageId to ${e.pdfPageId} for page ${o}`)):console.warn(`‚ö†Ô∏è No pdfPageId found for page ${o} in pageMap`)}function D(o){return Array.from({length:o.totalPages},(e,n)=>n+1)}function uo(o,e){const n=e?e():D(o);return n.indexOf(o.currentPage)<n.length-1}function fo(o,e){return(e?e():D(o)).indexOf(o.currentPage)>0}const Mn=Object.freeze(Object.defineProperty({__proto__:null,canGoNext:uo,canGoPrevious:fo,goToPage:so,nextPage:ao,previousPage:co},Symbol.toStringTag,{value:"Module"}));function mo(o,e){console.log("üîç Searching rooms with query:",o);const n=e.tree?e.tree.map(i=>({id:i.id,name:i.name,isNew:!1})):[];if(!o||o.trim()==="")e.roomSuggestions=n,console.log(`‚úì Showing ${n.length} existing rooms`);else{const i=o.toLowerCase(),t=n.filter(r=>r.name.toLowerCase().includes(i));e.roomSuggestions=[{id:"new_"+Date.now(),name:o,isNew:!0},...t],console.log(`‚úì Found ${t.length} matching rooms, showing "Create ${o}" option`)}}async function go(o,e,n){if(console.log("üè† Selecting room:",o),o.isNew){console.log("üìù Creating new room:",o.name);try{const t=await(await fetch(`/api/project/${e.projectId}/rooms`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":I()},body:JSON.stringify({name:o.name,room_type:null})})).json();if(t.success&&t.room)console.log("‚úì Room created successfully:",t.room),e.activeRoomId=t.room.id,e.activeRoomName=t.room.name,e.roomSearchQuery=t.room.name,e.showRoomDropdown=!1,n&&await n(),console.log("‚úì Room added to project tree");else throw new Error(t.error||"Failed to create room")}catch(i){console.error("‚ùå Failed to create room:",i),alert(`Error creating room: ${i.message}`),e.showRoomDropdown=!1}}else e.activeRoomId=o.id,e.activeRoomName=o.name,e.roomSearchQuery=o.name,e.showRoomDropdown=!1,console.log("‚úì Selected existing room:",o.name)}function ho(o,e){var t;if(!e.activeRoomId)return;console.log("üîç Searching locations with query:",o);const n=(t=e.tree)==null?void 0:t.find(r=>r.id===e.activeRoomId),i=n!=null&&n.children?n.children.map(r=>({id:r.id,name:r.name,isNew:!1})):[];if(!o||o.trim()==="")e.locationSuggestions=i,console.log(`‚úì Showing ${i.length} existing locations`);else{const r=o.toLowerCase(),l=i.filter(a=>a.name.toLowerCase().includes(r));e.locationSuggestions=[{id:"new_"+Date.now(),name:o,isNew:!0},...l],console.log(`‚úì Found ${l.length} matching locations, showing "Create ${o}" option`)}}async function po(o,e,n){if(console.log("üìç Selecting location:",o),o.isNew){console.log("üìù Creating new location:",o.name);try{const t=await(await fetch(`/api/project/${e.projectId}/rooms/${e.activeRoomId}/locations`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":I()},body:JSON.stringify({name:o.name})})).json();if(t.success&&t.location)console.log("‚úì Location created successfully:",t.location),e.activeLocationId=t.location.id,e.activeLocationName=t.location.name,e.locationSearchQuery=t.location.name,e.showLocationDropdown=!1,n&&await n(),console.log("‚úì Location added to project tree");else throw new Error(t.error||"Failed to create location")}catch(i){console.error("‚ùå Failed to create location:",i),alert(`Error creating location: ${i.message}`),e.showLocationDropdown=!1}}else e.activeLocationId=o.id,e.activeLocationName=o.name,e.locationSearchQuery=o.name,e.showLocationDropdown=!1,console.log("‚úì Selected existing location:",o.name)}function En(o){o.roomSearchQuery="",o.roomSuggestions=[],o.showRoomDropdown=!1}function Dn(o){o.locationSearchQuery="",o.locationSuggestions=[],o.showLocationDropdown=!1}const kn=Object.freeze(Object.defineProperty({__proto__:null,clearLocationSearch:Dn,clearRoomSearch:En,searchLocations:ho,searchRooms:mo,selectLocation:po,selectRoom:go},Symbol.toStringTag,{value:"Module"}));async function vo(o,e,n){const i=Math.min(o.zoomLevel+.25,o.zoomMax);await N(i,o,e,n)}async function yo(o,e,n){const i=Math.max(o.zoomLevel-.25,o.zoomMin);await N(i,o,e,n)}async function V(o,e,n){await N(1,o,e,n)}async function N(o,e,n,i){e.zoomLevel=o,e._overlayRect=null,W(e),i.displayPdf&&await i.displayPdf(),i.$nextTick&&await i.$nextTick(),await On(n,50,500),w(n,e),e._overlayRect=null,i.$nextTick&&await i.$nextTick(),L(e,n),e.isolationMode&&i.updateIsolationMask&&i.updateIsolationMask(),console.log(`üîç Zoom set to ${Math.round(o*100)}%`)}async function On(o,e=50,n=500){var c;const i=(c=o.pdfEmbed)==null?void 0:c.querySelector("canvas");if(!i){console.warn("‚ö†Ô∏è Canvas not found, skipping ready check");return}const t=Date.now();let r=i.offsetWidth,l=i.offsetHeight,a=0;for(;Date.now()-t<n;){await new Promise(u=>setTimeout(u,e));const s=i.offsetWidth,d=i.offsetHeight;if(s===r&&d===l&&s>0&&d>0){if(a++,a>=2){console.log(`‚úì Canvas stable at ${s} √ó ${d} (${Date.now()-t}ms)`);return}}else a=0;r=s,l=d}console.warn(`‚ö†Ô∏è Canvas not stable after ${n}ms, proceeding anyway`)}function wo(o){return Math.round(o.zoomLevel*100)}async function F(o,e,n,i){console.log("üîç Zooming to fit annotation:",o.label);let t=null;if(o.screenWidth&&o.screenHeight?(t=o,console.log("   ‚úì Using annotation directly (has screen coordinates)")):(t=e.annotations.find(m=>m.id===o.id&&m.screenWidth&&m.screenHeight),t&&console.log("   ‚úì Found by annotation ID")),t||(t=e.annotations.find(m=>m.type!==o.type||!m.screenWidth||!m.screenHeight?!1:m.roomId===o.id||m.roomLocationId===o.id||m.cabinetRunId===o.id||m.cabinetId===o.id),t&&console.log(`   ‚úì Found by entity ID match for type: ${o.type}`)),!t){console.warn("‚ö†Ô∏è Annotation does not have valid screen coordinates yet, skipping zoom");return}const r=n.annotationOverlay;if(!r){console.warn("‚ö†Ô∏è Container not found for zoom calculation");return}const l=r.getBoundingClientRect(),a=l.width,c=l.height,s=.8,d=a*s/t.screenWidth,u=c*s/t.screenHeight;let f=Math.min(d,u);f=Math.max(e.zoomMin,Math.min(f,e.zoomMax)),await N(f,e,n,i),i.$nextTick&&await i.$nextTick(),await Hn(t,e,n),console.log(`‚úì Zoomed to ${Math.round(f*100)}% and centered annotation`)}async function Hn(o,e,n){var u;if(!((u=n.pdfEmbed)==null?void 0:u.querySelector("canvas"))){console.warn("‚ö†Ô∏è Canvas not found for centering");return}const t=n.annotationOverlay;if(!t)return;const r=t.getBoundingClientRect(),l=r.width,a=r.height;let c=le(t,"X"),s=le(t,"Y");const d={x:o.screenX+o.screenWidth/2,y:o.screenY+o.screenHeight/2};console.log("üìç Centering calculation:",{annoScreenPos:d,containerWidth:l,containerHeight:a,targetScrollLeft:d.x-l/2,targetScrollTop:d.y-a/2}),c.scrollLeft=d.x-l/2,s.scrollTop=d.y-a/2,console.log("üìç After scroll:",{actualScrollLeft:c.scrollLeft,actualScrollTop:s.scrollTop})}function le(o,e){let n=o.parentElement;for(;n&&n!==document.body;){const i=window.getComputedStyle(n),t=e==="X"?i.overflowX:i.overflowY,r=e==="X"?n.scrollWidth>n.clientWidth:n.scrollHeight>n.clientHeight;if((t==="auto"||t==="scroll")&&r)return n;n=n.parentElement}return document.documentElement||document.body}function Io(o){return o.zoomLevel<=o.zoomMin}function bo(o){return o.zoomLevel>=o.zoomMax}const Vn=Object.freeze(Object.defineProperty({__proto__:null,getZoomPercentage:wo,isAtMaxZoom:bo,isAtMinZoom:Io,resetZoom:V,setZoom:N,zoomIn:vo,zoomOut:yo,zoomToFitAnnotation:F},Symbol.toStringTag,{value:"Module"}));function Ro(o,e=null,n,i){console.log(`üìê Switching to ${o} view${e?" ("+e+")":""}`),n.activeViewType=o,n.activeOrientation=e,o==="plan"&&(n.activeOrientation=null),i.updateAnnotationVisibility&&i.updateAnnotationVisibility(),console.log(`‚úì View switched to ${o}${e?" - "+e:""}`)}function So(o,e,n){console.log(`üß≠ Setting orientation to ${o}`),e.activeOrientation=o,n.updateAnnotationVisibility&&n.updateAnnotationVisibility()}function X(o,e){const n=o.viewType||"plan";return e.activeViewType==="plan"?n==="plan":e.activeViewType===n?e.activeOrientation&&o.viewOrientation?o.viewOrientation===e.activeOrientation:!0:!1}function Lo(o){console.log(`üîç Updating annotation visibility for ${o.activeViewType} view`)}function _o(o){return o.activeViewType==="plan"?"Plan View":o.activeViewType==="elevation"?`Elevation View${o.activeOrientation?` - ${o.activeOrientation.charAt(0).toUpperCase()+o.activeOrientation.slice(1)}`:""}`:o.activeViewType==="section"?`Section View${o.activeOrientation?` - ${o.activeOrientation}`:""}`:o.activeViewType==="detail"?`Detail View${o.activeOrientation?` - ${o.activeOrientation}`:""}`:"Unknown View"}function Ao(o){return o.activeViewType==="plan"?"var(--primary-600)":o.activeViewType==="elevation"?"var(--warning-600)":o.activeViewType==="section"?"var(--info-600)":o.activeViewType==="detail"?"var(--success-600)":"var(--gray-600)"}const Fn=Object.freeze(Object.defineProperty({__proto__:null,getCurrentViewColor:Ao,getCurrentViewLabel:_o,isAnnotationVisibleInView:X,setOrientation:So,setViewType:Ro,updateAnnotationVisibility:Lo},Symbol.toStringTag,{value:"Module"}));function zo(o,e,n,i="primary",t){t.annotationReferences[o]||(t.annotationReferences[o]=[]),t.annotationReferences[o].some(l=>l.entity_type===e&&l.entity_id===n)||(t.annotationReferences[o].push({entity_type:e,entity_id:n,reference_type:i}),console.log(`‚úì Added ${i} reference: ${e} #${n} to annotation #${o}`))}function No(o,e,n,i){i.annotationReferences[o]&&(i.annotationReferences[o]=i.annotationReferences[o].filter(t=>!(t.entity_type===e&&t.entity_id===n)),console.log(`‚úì Removed reference: ${e} #${n} from annotation #${o}`))}function k(o,e){return e.annotationReferences[o]||[]}function $o(o,e,n){return k(o,n).filter(t=>t.entity_type===e)}function To(o,e,n,i){return k(o,i).some(r=>r.entity_type===e&&r.entity_id===n)}function Co(o,e){if(e.annotationReferences[o]){const n=e.annotationReferences[o].length;delete e.annotationReferences[o],console.log(`‚úì Cleared ${n} references from annotation #${o}`)}}const Xn=Object.freeze(Object.defineProperty({__proto__:null,addEntityReference:zo,clearAnnotationReferences:Co,getEntityReferences:k,getReferencesByType:$o,hasEntityReference:To,removeEntityReference:No},Symbol.toStringTag,{value:"Module"}));function Yn(o,e,n){const i=x(e,n);if(!i)return"-top-10 left-0";const t=o.screenY,r=i.height-(o.screenY+o.screenHeight);o.screenX;const l=i.width-(o.screenX+o.screenWidth);return t>=40?"-top-10 left-0":r>=40?"-bottom-10 left-0":l>=100?"top-0 -right-2 translate-x-full":"top-0 -left-2 -translate-x-full"}function Wn(o,e,n){const i=x(e,n);if(!i)return"-top-7 right-0";const t=o.screenY;return i.width-(o.screenX+o.screenWidth),t>=30?"-top-7 right-0":"-bottom-7 right-0"}function S(o){return{...ae(o),get filteredAnnotations(){return je(this)},get activeFiltersCount(){return K(this)},get activeFilterChips(){return Ze(this)},get availableFilterOptions(){return Be(this)},get filteredPageNumbers(){return qe(this)},get isolationBreadcrumbs(){return Ye(this)},get availableTypes(){return[...new Set(this.annotations.map(n=>n.type))].sort()},get availableRooms(){const e=new Map;return this.annotations.forEach(n=>{n.roomId&&n.roomName&&e.set(n.roomId,{id:n.roomId,name:n.roomName})}),Array.from(e.values()).sort((n,i)=>n.name.localeCompare(i.name))},get availableLocations(){const e=new Map;return this.annotations.forEach(n=>{n.locationId&&n.locationName&&e.set(n.locationId,{id:n.locationId,name:n.locationName})}),Array.from(e.values()).sort((n,i)=>n.name.localeCompare(i.name))},get availableViewTypes(){return[...new Set(this.annotations.map(n=>n.viewType||"plan"))].sort()},get availableVerticalZones(){return[...new Set(this.annotations.map(n=>n.verticalZone).filter(Boolean))].sort()},get filteredTree(){return this.tree},get visibleAnnotationsList(){return this.annotations.filter(e=>!this.hiddenAnnotations.includes(e.id)&&X(e,this))},async init(){if(this._initialized){console.warn("‚ö†Ô∏è PDF Viewer already initialized");return}console.log("üöÄ Initializing PDF Annotation Viewer...");try{ce(this),await Qo(this,this.$refs,{$nextTick:()=>this.$nextTick()}),await C(this),await b(this,this.$refs),Fe(this),this._cleanupBrowserZoomHandler=ue(this,this.$refs,{updateIsolationMask:()=>A(this)}),this.setupLivewireListeners(),this._initialized=!0,this.systemReady=!0,console.log("‚úì PDF Viewer initialized successfully")}catch(e){console.error("‚ùå PDF Viewer initialization failed:",e),this.error=e.message}},destroy(){console.log("üßπ Cleaning up PDF Viewer..."),this._cleanupBrowserZoomHandler&&(this._cleanupBrowserZoomHandler(),this._cleanupBrowserZoomHandler=null),console.log("‚úì PDF Viewer cleaned up")},setupLivewireListeners(){window.Livewire.on("annotation-created",e=>{console.log("üì• Livewire: annotation-created",e),b(this,this.$refs)}),window.Livewire.on("annotation-updated",e=>{console.log("üì• Livewire: annotation-updated",e),b(this,this.$refs)}),window.Livewire.on("annotation-editor-closed",e=>{console.log("üì• Livewire: annotation-editor-closed",e);const n=this.annotations.length;this.annotations=this.annotations.filter(t=>!t.id.toString().startsWith("temp_"));const i=this.annotations.length;n>i&&console.log(`‚úì Cleaned up ${n-i} temporary annotation(s)`)}),window.Livewire.on("hierarchy-completed",e=>{console.log("üì• Livewire: hierarchy-completed",e);const{annotation:n,createdIds:i,context:t}=e,r=this.annotations.find(l=>l.id===n.id);if(r){if(i.room&&(r.roomId=i.room),i.room_location&&(r.roomLocationId=i.room_location),i.cabinet_run&&(r.cabinetRunId=i.cabinet_run),i.cabinet&&(r.cabinetSpecId=i.cabinet),console.log("‚úì Updated annotation with hierarchy:",r),r.parentId){const l=this.annotations.find(a=>a.id===r.parentId);l&&l.type==="location"&&(r.locationId=l.roomLocationId,r.locationName=l.label,console.log("‚úì Populated locationId from parent:",r.locationId))}this.isolationMode&&(console.log("üîç Checking visibility for newly created annotation in isolation mode"),ko(()=>Promise.resolve().then(()=>We),void 0).then(l=>{const a=l.isAnnotationVisibleInIsolation(r,this);!a&&!this.hiddenAnnotations.includes(r.id)?(this.hiddenAnnotations.push(r.id),console.log(`üëÅÔ∏è Hiding newly created annotation ${r.id} (not visible in current isolation)`)):a&&this.hiddenAnnotations.includes(r.id)&&(this.hiddenAnnotations=this.hiddenAnnotations.filter(c=>c!==r.id),console.log(`üëÅÔ∏è Showing newly created annotation ${r.id} (visible in current isolation)`))}))}t.roomId&&(this.activeRoomId=t.roomId),t.locationId&&(this.activeLocationId=t.locationId),t.cabinetRunId&&(this.activeCabinetRunId=t.cabinetRunId),this.saveAnnotations(!0)})},getCanvasScale(){return de(this.$refs,this)},pdfToScreen(e,n,i,t){return z(e,n,i,t,this.$refs,this)},screenToPdf(e,n){return h(e,n,this.$refs,this)},syncOverlayToCanvas(){w(this.$refs,this)},getOverlayRect(){return x(this.$refs,this)},async loadAnnotations(){await b(this,this.$refs)},async saveAnnotations(e=!1){await pe(this,async()=>{await this.loadAnnotations(),await this.$nextTick(),await this.refreshTree(),await this.$nextTick(),this.syncOverlayToCanvas()},e)},async deleteAnnotation(e){await ve(e,this,()=>this.refreshTree())},editAnnotation(e){O(e,this)},selectAnnotation(e){O(e,this)},startDrawing(e){be(e,this,this.$refs)},updateDrawPreview(e){Re(e,this,this.$refs)},finishDrawing(e){Se(e,this,this.$refs)},setDrawMode(e){Le(e,this,n=>we(n,this),n=>Ie(n))},canDrawLocation(){return _e(this)},canDraw(){return Ae(this)},clearContext(){ze(this)},getContextLabel(){return Ne(this)},startResize(e,n,i){Ce(e,n,i,this)},startMove(e,n){Me(e,n,this)},updateDrawing(e){this.updateDrawPreview(e)},cancelDrawing(e){this.isDrawing&&(this.isDrawing=!1,this.drawStart=null,this.drawPreview=null)},handleResize(e){Oe(e,this)},handleMove(e){He(e,this)},finishResizeOrMove(e){Ve(e,this,this.$refs),this.autoSaveTimeout&&clearTimeout(this.autoSaveTimeout),this.autoSaveTimeout=setTimeout(()=>{this.saveAnnotations(!0)},1e3)},selectAnnotationContext(e){e.type==="room"?this.selectNode(e.roomId,"room",e.label||e.name,null,null,null):e.type==="room_location"||e.type==="location"?this.selectNode(e.roomLocationId||e.id,"room_location",e.label||e.name,e.roomId,null,null):e.type==="cabinet_run"?this.selectNode(e.cabinetRunId||e.id,"cabinet_run",e.label||e.name,e.roomId,e.roomLocationId||e.locationId,null):e.type==="cabinet"&&this.selectNode(e.id,"cabinet",e.label||e.name,e.roomId,e.roomLocationId||e.locationId,e.cabinetRunId)},undo(){B(this)},redo(){Q(this)},canUndo(){return M(this)},canRedo(){return E(this)},async enterIsolationMode(e){await R(e,this,{zoomToFitAnnotation:n=>F(n,this,this.$refs,this.getCallbacks()),syncOverlayToCanvas:()=>this.syncOverlayToCanvas(),$nextTick:()=>this.$nextTick()})},async exitIsolationMode(){await Xe(this,{clearContext:()=>this.clearContext(),resetZoom:()=>V(this,this.$refs,this.getCallbacks())})},isAnnotationVisibleInIsolation(e){return U(e,this)},updateIsolationMask(){A(this)},clearAllFilters(){q(this)},removeFilter(e){Qe(e,this)},applyPreset(e){Ue(e,this)},isPresetActive(e){return Ke(e,this)},hasActiveFilters(){return this.activeFiltersCount>0},async loadTree(){await C(this)},async refreshTree(){await G(this,{$refs:this.$refs,...this.getCallbacks()})},toggleNode(e){Je(e,this)},isExpanded(e){return eo(e,this)},async selectNode(e,n,i,t,r,l){await oo({nodeId:e,type:n,name:i,parentRoomId:t,parentLocationId:r,parentCabinetRunId:l},this,{navigateToNodePage:(a,c,s)=>J(a,c,s,this,this.getCallbacks())})},showContextMenu(e,n,i,t,r,l){no(e,{nodeId:n,nodeType:i,nodeName:t,parentRoomId:r,parentLocationId:l},this)},async deleteTreeNode(){await io(this,()=>this.refreshTree())},async navigateToNodeOnDoubleClick(e,n,i,t){await to({nodeId:e,nodeType:n,parentRoomId:i,parentLocationId:t},this,{goToPage:r=>this.goToPage(r)})},async nextPage(){await ao(this,this.getCallbacks())},async previousPage(){await co(this,this.getCallbacks())},async goToPage(e){await so(e,this,this.getCallbacks())},canGoNext(){return uo(this,()=>this.filteredPageNumbers)},canGoPrevious(){return fo(this,()=>this.filteredPageNumbers)},searchRooms(e){mo(e,this)},async selectRoom(e){await go(e,this,()=>this.refreshTree())},searchLocations(e){ho(e,this)},async selectLocation(e){await po(e,this,()=>this.refreshTree())},async zoomIn(){await vo(this,this.$refs,this.getCallbacks())},async zoomOut(){await yo(this,this.$refs,this.getCallbacks())},async resetZoom(){await V(this,this.$refs,this.getCallbacks())},getZoomPercentage(){return wo(this)},async zoomToFitAnnotation(e){await F(e,this,this.$refs,this.getCallbacks())},isAtMinZoom(){return Io(this)},isAtMaxZoom(){return bo(this)},setViewType(e,n=null){Ro(e,n,this,{updateAnnotationVisibility:()=>this.updateAnnotationVisibility()})},setOrientation(e){So(e,this,{updateAnnotationVisibility:()=>this.updateAnnotationVisibility()})},isAnnotationVisibleInView(e){return X(e,this)},updateAnnotationVisibility(){Lo(this)},getCurrentViewLabel(){return _o(this)},addEntityReference(e,n,i,t="primary"){zo(e,n,i,t,this)},removeEntityReference(e,n,i){No(e,n,i,this)},getEntityReferences(e){return k(e,this)},getReferencesByType(e,n){return $o(e,n,this)},hasEntityReference(e,n,i){return To(e,n,i,this)},clearAnnotationReferences(e){Co(e,this)},getPageGroupedAnnotations(){return lo(this)},getCurrentViewColor(){return Ao(this)},getLabelPositionClasses(e){return Yn(e,this.$refs,this)},getButtonPositionClasses(e){return Wn(e,this.$refs,this)},handleNodeClick(e){this.selectedAnnotation=e,this.activeAnnotationId=e.id,console.log("üëÜ Node clicked:",e.label||e.id,"type:",e.type),Te(e,this)},handleAnnotationDoubleClick(e){console.log("üëÜüëÜ Annotation double-clicked:",e.label||e.id),R(e,this,this.getCallbacks())},handleNodeDoubleClick(e,n,...i){console.log("üëÜüëÜ Tree node double-clicked:",e,n);let t=null;if(e==="room")t=this.annotations.find(r=>r.type==="room"&&r.roomId===n);else if(e==="room_location"||e==="location"){const[r]=i;t=this.annotations.find(l=>l.type==="location"&&l.roomLocationId===n&&l.roomId===r)}else if(e==="cabinet_run"){const[r,l]=i;t=this.annotations.find(a=>a.type==="cabinet_run"&&a.cabinetRunId===n&&a.roomId===r&&(a.locationId===l||a.roomLocationId===l))}else if(e==="cabinet"){const[r,l,a]=i;t=this.annotations.find(c=>c.type==="cabinet"&&c.id===n)}t?R(t,this,this.getCallbacks()):console.warn("‚ö†Ô∏è Could not find annotation to isolate:",e,n)},handleTreeNodeDoubleClick(e,n,i,...t){console.log("üëÜüëÜ Tree node double-clicked (with label):",e,i,n);let r=null;if(e==="room")r={type:"room",id:n,label:i,roomId:n};else if(e==="location"){const[l,a,c,s]=t;r={type:"location",id:n,label:i,roomId:l,roomName:a,roomLocationId:c||n,locationId:c||n,locationName:s||i}}else if(e==="cabinet_run"){const[l,a,c,s,d]=t;r={type:"cabinet_run",id:n,label:i,roomId:l,roomName:a,locationId:c,roomLocationId:c,locationName:s,cabinetRunId:d||n}}r?R(r,this,this.getCallbacks()):console.warn("‚ö†Ô∏è Could not create annotation for isolation:",e,i)},getCallbacks(){return{displayPdf:()=>me(this,this.$refs),loadAnnotations:()=>this.loadAnnotations(),getFilteredPageNumbers:()=>this.filteredPageNumbers,updateIsolationMask:()=>this.updateIsolationMask(),syncOverlayToCanvas:()=>this.syncOverlayToCanvas(),resetZoom:()=>this.resetZoom(),$nextTick:()=>this.$nextTick()}}}}function jn(o,e){const i=e.annotations.filter(r=>r.roomId===o).map(r=>r.id);i.some(r=>!e.hiddenAnnotations.includes(r))?i.forEach(r=>{e.hiddenAnnotations.includes(r)||e.hiddenAnnotations.push(r)}):e.hiddenAnnotations=e.hiddenAnnotations.filter(r=>!i.includes(r)),console.log(`üëÅÔ∏è Toggled room ${o} visibility`)}function Zn(o,e){return e.annotations.filter(i=>i.roomId===o).some(i=>!e.hiddenAnnotations.includes(i.id))}function Bn(o,e){const i=e.annotations.filter(r=>r.type==="location"&&r.roomLocationId===o||r.locationId===o).map(r=>r.id);i.some(r=>!e.hiddenAnnotations.includes(r))?i.forEach(r=>{e.hiddenAnnotations.includes(r)||e.hiddenAnnotations.push(r)}):e.hiddenAnnotations=e.hiddenAnnotations.filter(r=>!i.includes(r)),console.log(`üëÅÔ∏è Toggled location ${o} visibility`)}function Qn(o,e){return e.annotations.filter(i=>i.type==="location"&&i.roomLocationId===o||i.locationId===o).some(i=>!e.hiddenAnnotations.includes(i.id))}function Un(o,e){const i=e.annotations.filter(r=>r.type==="cabinet_run"&&r.cabinetRunId===o||r.cabinetRunId===o).map(r=>r.id);i.some(r=>!e.hiddenAnnotations.includes(r))?i.forEach(r=>{e.hiddenAnnotations.includes(r)||e.hiddenAnnotations.push(r)}):e.hiddenAnnotations=e.hiddenAnnotations.filter(r=>!i.includes(r)),console.log(`üëÅÔ∏è Toggled cabinet run ${o} visibility`)}function Kn(o,e){return e.annotations.filter(i=>i.type==="cabinet_run"&&i.cabinetRunId===o||i.cabinetRunId===o).some(i=>!e.hiddenAnnotations.includes(i.id))}function qn(o,e){const n=e.hiddenAnnotations.indexOf(o);n>-1?(e.hiddenAnnotations.splice(n,1),console.log(`üëÅÔ∏è Showing annotation ${o}`)):(e.hiddenAnnotations.push(o),console.log(`üëÅÔ∏è Hiding annotation ${o}`))}function Gn(o,e){return!e.hiddenAnnotations.includes(o)}function Jn(o,e,n){if(!n.annotations||n.annotations.length===0)return!1;let i;return e==="room"?i=n.annotations.filter(t=>t.roomId===o):e==="location"?i=n.annotations.filter(t=>t.type==="location"&&t.roomLocationId===o||t.locationId===o):e==="cabinet_run"&&(i=n.annotations.filter(t=>t.type==="cabinet_run"&&t.cabinetRunId===o||t.cabinetRunId===o)),i&&i.length>0}const ei=Object.freeze(Object.defineProperty({__proto__:null,hasAnnotationsOnCurrentPage:Jn,isAnnotationVisible:Gn,isCabinetRunVisible:Kn,isLocationVisible:Qn,isRoomVisible:Zn,toggleAnnotationVisibility:qn,toggleCabinetRunVisibility:Un,toggleLocationVisibility:Bn,toggleRoomVisibility:jn},Symbol.toStringTag,{value:"Module"}));Po.workerSrc="/js/pdf.worker.min.js";window.pdfjsLib=Mo;window.createPdfViewerComponent=S;window.PdfViewerManagers={AnnotationManager:tn,TreeManager:xn,CoordTransform:Zo,DrawingSystem:fn,ResizeMoveSystem:Rn,StateManager:Fo,IsolationModeManager:We,VisibilityToggleManager:ei,ZoomManager:Vn,ViewTypeManager:Fn,EntityReferenceManager:Xn,FilterSystem:Cn,NavigationManager:Mn,UndoRedoManager:An,AutocompleteManager:kn};typeof Alpine<"u"?(Alpine.data("annotationSystemV3",S),Alpine.data("annotationSystemV2",S),console.log("‚úÖ PDF Annotation System loaded - Alpine components registered (V2 + V3)")):document.addEventListener("alpine:init",()=>{Alpine.data("annotationSystemV3",S),Alpine.data("annotationSystemV2",S),console.log("‚úÖ PDF Annotation System loaded - Alpine components registered (V2 + V3)")});console.log("‚úì PDF Viewer component loaded and ready");
