function me(e){return{pdfUrl:e.pdfUrl,pageNumber:e.pageNumber,pdfPageId:e.pdfPageId,projectId:e.projectId,totalPages:e.totalPages||1,pageMap:e.pageMap||{},currentPage:e.pageNumber||1,pageType:e.pageType||null,pdfReady:!1,treeReady:!1,annotationsReady:!1,systemReady:!1,pageDimensions:null,canvasScale:1,zoomLevel:1,zoomMin:1,zoomMax:3,activeRoomId:null,activeRoomName:"",activeLocationId:null,activeLocationName:"",drawMode:null,editorModalOpen:!1,isolationMode:!1,isolationLevel:null,isolatedRoomId:null,isolatedRoomName:"",isolatedLocationId:null,isolatedLocationName:"",isolatedCabinetRunId:null,isolatedCabinetRunName:"",isolationViewType:null,isolationOrientation:null,overlayWidth:"100%",overlayHeight:"100%",hiddenAnnotations:[],visibleAnnotationsList:[],tree:[],expandedNodes:[],selectedNodeId:null,selectedPath:[],selectedAnnotation:null,loading:!1,navigating:!1,error:null,treeViewMode:"room",treeSidebarState:"full",showFilters:!1,filterScope:"page",filters:{types:[],rooms:[],locations:[],viewTypes:[],verticalZones:[],myAnnotations:!1,recent:!1,unlinked:!1,pageRange:{from:null,to:null},dateRange:{from:null,to:null}},contextMenu:{show:!1,x:0,y:0,nodeId:null,nodeType:null,nodeName:"",parentRoomId:null},roomSearchQuery:"",locationSearchQuery:"",roomSuggestions:[],locationSuggestions:[],showRoomDropdown:!1,showLocationDropdown:!1,annotations:[],isDrawing:!1,drawStart:null,drawPreview:null,isResizing:!1,isMoving:!1,resizeTicking:!1,moveTicking:!1,resizeHandle:null,moveStart:null,resizeStart:null,activeAnnotationId:null,resizeSaveTimeout:null,pendingResizeChanges:null,autoSaveTimeout:null,activeViewType:"plan",activeOrientation:null,availableOrientations:{elevation:["front","back","left","right"],section:["A-A","B-B","C-C"],detail:[]},viewScale:1,annotationReferences:{},pageObserver:null,visiblePages:[],_overlayRect:null,_lastRectUpdate:0,_rectCacheMs:100,_cachedZoom:void 0,pdfIframe:null,scrollX:0,scrollY:0,historyStack:[],historyIndex:-1,maxHistorySize:50,isUndoRedoAction:!1,_initialized:!1}}function x(e){const o={room:"#f59e0b",location:"#9333ea",cabinet_run:"#3b82f6",cabinet:"#10b981"};return o[e]||o.cabinet}function ge(e,o=null){let i={plan:"Plan View",elevation:"Elevation View",section:"Section View",detail:"Detail View"}[e]||"Unknown View";if(o&&(e==="elevation"||e==="section")){const r=e==="elevation"?o.charAt(0).toUpperCase()+o.slice(1):o;i+=` - ${r}`}return i}function pe(e){return{plan:"var(--primary-600)",elevation:"var(--warning-600)",section:"var(--info-600)",detail:"var(--success-600)"}[e]||"var(--gray-600)"}function he(e,o,n){if(o._resizeLockout||o.isResizing||o.isMoving){console.log("‚ö†Ô∏è Context change blocked - resize/move in progress");return}console.log("üéØ Selecting annotation context:",e.type,e.label),o.activeAnnotationId=e.id,o.selectedAnnotation=e,e.type==="room"?(o.activeRoomId=e.roomId||e.id,o.activeRoomName=e.label,o.activeLocationId=null,o.activeLocationName="",o.roomSearchQuery=e.label,o.locationSearchQuery="",console.log(`‚úì Room context set: Room "${e.label}"`),console.log("‚úì Enabled tools: Draw Location")):e.type==="location"?(o.activeRoomId=e.roomId,o.activeRoomName=e.roomName||(n.getRoomNameById?n.getRoomNameById(e.roomId):""),o.activeLocationId=e.id,o.activeLocationName=e.label,o.roomSearchQuery=o.activeRoomName,o.locationSearchQuery=e.label,console.log(`‚úì Location context set: Room "${o.activeRoomName}" ‚Üí Location "${e.label}"`),console.log("‚úì Enabled tools: Draw Cabinet Run, Draw Cabinet")):e.type==="cabinet_run"?(o.activeRoomId=e.roomId,o.activeRoomName=e.roomName||(n.getRoomNameById?n.getRoomNameById(e.roomId):""),o.activeLocationId=e.locationId,o.activeLocationName=e.locationName||(n.getLocationNameById?n.getLocationNameById(e.locationId):""),o.roomSearchQuery=o.activeRoomName,o.locationSearchQuery=o.activeLocationName,console.log(`‚úì Cabinet Run context set: Room "${o.activeRoomName}" ‚Üí Location "${o.activeLocationName}" ‚Üí Run "${e.label}"`),console.log("‚úì Enabled tools: Draw Cabinet")):e.type==="cabinet"&&(o.activeRoomId=e.roomId,o.activeRoomName=e.roomName||(n.getRoomNameById?n.getRoomNameById(e.roomId):""),o.activeLocationId=e.locationId,o.activeLocationName=e.locationName||(n.getLocationNameById?n.getLocationNameById(e.locationId):""),o.roomSearchQuery=o.activeRoomName,o.locationSearchQuery=o.activeLocationName,console.log(`‚úì Cabinet context set: Room "${o.activeRoomName}" ‚Üí Location "${o.activeLocationName}" ‚Üí Cabinet "${e.label}"`),console.log("‚úì Enabled tools: Draw Cabinet (sibling)")),o.selectedNodeId=e.id}const xn=Object.freeze(Object.defineProperty({__proto__:null,createInitialState:me,getColorForType:x,getViewTypeColor:pe,getViewTypeLabel:ge,selectAnnotationContext:he},Symbol.toStringTag,{value:"Module"}));function ve(e){e._overlayRect=null,e._lastRectUpdate=0,e._rectCacheMs=100,e._cachedZoom=void 0}function ye(e){if(e._cachedZoom!==void 0)return e._cachedZoom;const o=window.getComputedStyle(document.documentElement),n=parseFloat(o.zoom||"1");return e._cachedZoom=n,console.log("üîç CSS zoom factor (not browser zoom):",n),n}function M(e){e._cachedZoom=void 0}function j(e,o){var r,t;if(!o){const l=(r=e.pdfEmbed)==null?void 0:r.querySelector("canvas");return l?l.getBoundingClientRect():null}const n=Date.now();if(o._overlayRect&&n-o._lastRectUpdate<o._rectCacheMs)return o._overlayRect;const i=(t=e.pdfEmbed)==null?void 0:t.querySelector("canvas");return i?(o._overlayRect=i.getBoundingClientRect(),o._lastRectUpdate=n,o._overlayRect):null}function T(e,o){return j(e,o)}function we(e,o){if(!e.pdfEmbed||!o.pageDimensions)return 1;const n=e.pdfEmbed.querySelector("canvas");if(!n)return 1;const r=n.getBoundingClientRect().width,t=o.pageDimensions.width;return r/t}function z(e,o,n=0,i=0,r,t){var h;if(!t.pageDimensions)return{x:0,y:0,width:0,height:0};const l=(h=r.pdfEmbed)==null?void 0:h.querySelector("canvas");if(!l)return{x:0,y:0,width:0,height:0};const a=l.offsetWidth,c=l.offsetHeight,d=e/t.pageDimensions.width,s=(t.pageDimensions.height-o)/t.pageDimensions.height,u=d*a,f=s*c,m=n/t.pageDimensions.width*a,y=i/t.pageDimensions.height*c;return{x:u,y:f,width:m,height:y}}function p(e,o,n,i){var u;if(!i.pageDimensions)return{x:0,y:0,normalized:{x:0,y:0}};const r=(u=n.pdfEmbed)==null?void 0:u.querySelector("canvas");if(!r)return{x:0,y:0,normalized:{x:0,y:0}};const t=r.offsetWidth,l=r.offsetHeight,a=e/t,c=o/l,d=a*i.pageDimensions.width,s=i.pageDimensions.height-c*i.pageDimensions.height;return{x:d,y:s,normalized:{x:a,y:c}}}function Ie(e,o,n){return z(e.pdfX,e.pdfY,e.pdfWidth,e.pdfHeight,o,n)}function I(e,o){if(!e.pdfEmbed||!e.annotationOverlay)return;const n=e.pdfEmbed.querySelector("canvas");if(!n)return;const i=n.offsetWidth,r=n.offsetHeight;o.overlayWidth=`${i}px`,o.overlayHeight=`${r}px`,o._overlayRect=null,console.log(`üìê Overlay synced to canvas: ${i} √ó ${r} (layout space, zoom applied by browser)`)}function R(e,o){e.pageDimensions&&e.annotations.forEach(n=>{const i=z(n.pdfX,n.pdfY,n.pdfWidth,n.pdfHeight,o,e);n.screenX=i.x,n.screenY=i.y,n.screenWidth=i.width,n.screenHeight=i.height})}function Re(e,o){if(e._resizeLockout||e.isResizing||e.isMoving){console.log("‚ö†Ô∏è Render blocked - resize/move in progress");return}console.log("üé® Rendering annotations"),R(e,o)}function be(e,o,n){return e>=n.x&&e<=n.x+n.width&&o>=n.y&&o<=n.y+n.height}function Se(e,o,n){let i;const r=()=>{console.log("üîç Browser zoom/resize detected - re-syncing annotations"),clearTimeout(i),i=setTimeout(()=>{e._overlayRect=null,e._lastRectUpdate=0,M(e),I(o,e),setTimeout(()=>{R(e,o),e.isolationMode&&n.updateIsolationMask&&n.updateIsolationMask(),setTimeout(()=>{I(o,e),R(e,o),e.isolationMode&&n.updateIsolationMask&&n.updateIsolationMask(),console.log("‚úì Final sync complete after zoom/resize")},300),console.log("‚úì Annotations re-synced after browser zoom/resize")},50)},150)};return window.visualViewport&&window.visualViewport.addEventListener("resize",r),window.addEventListener("resize",r),console.log("‚úì Browser zoom handler initialized"),()=>{window.visualViewport&&window.visualViewport.removeEventListener("resize",r),window.removeEventListener("resize",r),clearTimeout(i),console.log("‚úì Browser zoom handler cleaned up")}}const Mn=Object.freeze(Object.defineProperty({__proto__:null,getAnnotationScreenPosition:Ie,getCanvasRect:j,getCanvasScale:we,getEffectiveZoom:ye,getOverlayRect:T,initializeCoordinateSystem:ve,invalidateZoomCache:M,pdfToScreen:z,pointInRect:be,renderAnnotations:Re,screenToPdf:p,setupBrowserZoomHandler:Se,syncOverlayToCanvas:I,updateAnnotationPositions:R},Symbol.toStringTag,{value:"Module"})),L=new WeakMap;async function Q(e){console.log("üìÑ Preloading PDF document...");try{if(typeof window.pdfjsLib>"u")throw new Error("PDF.js library not loaded");const n=await window.pdfjsLib.getDocument(e.pdfUrl).promise;L.set(e,n),console.log("‚úì PDF document preloaded",{numPages:n.numPages,fingerprint:n.fingerprint})}catch(o){throw console.error("‚ùå Failed to preload PDF:",o),e.error=`Failed to load PDF: ${o.message}`,o}}async function Le(e){console.log(`üìê Extracting dimensions for page ${e.currentPage}...`);const o=L.get(e);if(!o){console.error("‚ùå PDF document not preloaded");return}try{const i=(await o.getPage(e.currentPage)).getViewport({scale:1});e.pageDimensions={width:i.width,height:i.height},console.log(`‚úì Page dimensions: ${i.width} √ó ${i.height} pts`)}catch(n){console.warn("‚ö†Ô∏è PDF.js dimension extraction failed, using fallback method:",n.message),e.pageDimensions={width:612,height:792},console.log("‚úì Using fallback dimensions: 612 √ó 792 pts (letter size)"),e.error=null}}async function _e(e,o){console.log(`üñºÔ∏è Rendering PDF page ${e.currentPage} to canvas at ${Math.round(e.zoomLevel*100)}% zoom...`);const n=o.pdfEmbed;if(!n){console.warn("‚ö†Ô∏è PDF embed container not found in DOM, skipping render");return}if((!n.clientWidth||n.clientWidth<10)&&(console.warn("‚ö†Ô∏è PDF embed container has no width, waiting for layout..."),await new Promise(i=>setTimeout(i,100)),!n.clientWidth||n.clientWidth<10)){console.error("‚ùå PDF embed container still has no width after waiting"),e.error="PDF viewer container not ready";return}try{let i=L.get(e);if(!i&&(console.log("üìÑ PDF not in WeakMap, preloading..."),await Q(e),i=L.get(e),!i))throw new Error("PDF document failed to preload");const r=await i.getPage(e.currentPage),t=r.getViewport({scale:1}),c=n.clientWidth/t.width*e.zoomLevel,d=r.getViewport({scale:c}),s=document.createElement("canvas"),u=s.getContext("2d");s.width=d.width,s.height=d.height,e.zoomLevel===1?(s.style.width="100%",s.style.height="auto"):(s.style.width=`${d.width}px`,s.style.height=`${d.height}px`),s.style.display="block";const f={canvasContext:u,viewport:d};await r.render(f).promise,n.innerHTML="",n.appendChild(s),e.canvasScale=c,console.log("‚úì PDF page rendered to canvas"),console.log(`‚úì Canvas dimensions: ${s.width} √ó ${s.height}`),console.log(`‚úì Canvas scale factor: ${c.toFixed(3)}`),e.pdfReady=!0,console.log(`‚úì PDF page ${e.currentPage} displayed successfully`)}catch(i){throw console.error("‚ùå Failed to render PDF:",i),e.error=`Failed to render PDF: ${i.message}`,i}}async function Tn(e,o,n){try{console.log("üöÄ Initializing PDF viewer system..."),await Q(e),await Le(e),await _e(e,o),n.$nextTick&&await n.$nextTick(),await new Promise(i=>setTimeout(i,100)),e.canvasScale=ze(o,e),console.log(`üìê Canvas scale: ${e.canvasScale.toFixed(3)}`),I(o,e),console.log("‚úì PDF system initialized successfully")}catch(i){throw console.error("‚ùå PDF system initialization failed:",i),e.error=i.message,i}}function ze(e,o){if(!e.pdfEmbed||!o.pageDimensions)return console.warn("‚ö†Ô∏è calculateCanvasScale: Missing refs.pdfEmbed or pageDimensions"),1;const n=e.pdfEmbed.querySelector("iframe"),i=e.pdfEmbed.querySelector("canvas");let r;if(i&&i.clientWidth>0)r=i.clientWidth;else if(n&&n.clientWidth>0)r=n.clientWidth;else if(e.pdfEmbed.clientWidth>0)r=e.pdfEmbed.clientWidth;else return console.warn("‚ö†Ô∏è calculateCanvasScale: No element has valid clientWidth, using default scale"),1;const t=o.pageDimensions.width,l=r/t;return console.log(`üìê Scale calculation: actual=${r}px, natural=${t}pts, scale=${l.toFixed(3)}`),l}function Z(e,o,n){return function(...i){o[n]||(o[n]=!0,window.requestAnimationFrame(()=>{o[n]=!1,e.apply(o,i)}))}}function Ne(e="temp"){return`${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function b(e){if(e===null||typeof e!="object")return e;if(e instanceof Date)return new Date(e.getTime());if(e instanceof Array)return e.map(n=>b(n));const o={};for(const n in e)e.hasOwnProperty(n)&&(o[n]=b(e[n]));return o}function w(){var e;return((e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.content)||""}function $e(e,o={}){const n=document.createElementNS("http://www.w3.org/2000/svg",e);for(const[i,r]of Object.entries(o))n.setAttribute(i,r);return n}function v(e,o){if(!o.tree||!e)return"";const n=o.tree.find(i=>i.id===e);return n?n.name:""}function _(e,o){var n;if(!o.tree||!e)return"";for(const i of o.tree){const r=(n=i.children)==null?void 0:n.find(t=>t.id===e);if(r)return r.name}return""}function Ae(e,o){var n;if(!o.tree||!e)return"";for(const i of o.tree)for(const r of i.children||[]){const t=(n=r.children)==null?void 0:n.find(l=>l.id===e);if(t)return t.name}return""}async function xe(e,o,n={}){console.log(`üì• Loading annotations for page ${e.currentPage} (pdfPageId: ${e.pdfPageId})...`),e.annotations=[];try{const r=await(await fetch(`/api/pdf/page/${e.pdfPageId}/annotations`)).json();r.success&&r.annotations&&(e.annotations=r.annotations.map(t=>Me(t,e,o)),e.annotations.forEach(t=>B(t,e)),console.log(`‚úì Loaded ${e.annotations.length} annotations with parent connections`),e.annotations.forEach(t=>{(t.type==="cabinet_run"||t.type==="cabinet")&&console.log(`  ${t.type==="cabinet_run"?"üì¶":"üóÑÔ∏è"} ${t.label}:`,`roomId=${t.roomId}, locationId=${t.locationId}, cabinetRunId=${t.cabinetRunId}`)}),e.isolationMode&&(console.log("üîç [LOAD] Re-applying isolation filter to newly loaded annotations"),Te(e)))}catch(i){console.error("Failed to load annotations:",i),e.error=i.message}}function Me(e,o,n){const i=z(e.x*o.pageDimensions.width,(1-e.y)*o.pageDimensions.height,e.width*o.pageDimensions.width,e.height*o.pageDimensions.height,n,o);return{id:e.id,type:e.annotation_type,parentId:e.parent_annotation_id,pdfX:e.x*o.pageDimensions.width,pdfY:(1-e.y)*o.pageDimensions.height,pdfWidth:e.width*o.pageDimensions.width,pdfHeight:e.height*o.pageDimensions.height,normalizedX:e.x,normalizedY:e.y,screenX:i.x,screenY:i.y,screenWidth:i.width,screenHeight:i.height,roomId:e.room_id,roomLocationId:e.room_location_id,cabinetRunId:e.cabinet_run_id,cabinetSpecId:e.cabinet_specification_id,viewType:e.view_type,label:e.text||"Annotation",color:e.color||x(e.annotation_type),notes:e.notes,pageNumber:o.currentPage,pdfPageId:o.pdfPageId,projectId:o.projectId}}function B(e,o,n=new Set){if(!n.has(e.id)&&(n.add(e.id),e.roomId&&!e.roomName&&(e.roomName=v(e.roomId,o)),e.parentId)){const i=o.annotations.find(r=>r.id===e.parentId);i&&(B(i,o,n),!e.roomId&&i.roomId&&(e.roomId=i.roomId,e.roomName=i.roomName),i.type==="location"?(e.locationId=i.roomLocationId,e.locationName=i.label):i.locationId&&(e.locationId=i.locationId,e.locationName=i.locationName),i.type==="cabinet_run"?(e.cabinetRunId=i.cabinetRunId,e.cabinetRunName=i.label):i.cabinetRunId&&(e.cabinetRunId=i.cabinetRunId,e.cabinetRunName=i.cabinetRunName))}}function Te(e){e.hiddenAnnotations=[],e.annotations.forEach(o=>{}),console.log(`üëÅÔ∏è [LOAD] Hidden annotations after filter: [${e.hiddenAnnotations.join(", ")}]`)}async function Ce(e,o,n=!1){console.log("üíæ Saving annotations...",e.annotations);try{const i=e.annotations.map(l=>{const a=l.id&&l.id.toString().startsWith("temp_"),c={annotation_type:l.type,parent_annotation_id:l.parentId||null,x:l.normalizedX,y:l.normalizedY,width:l.pdfWidth/e.pageDimensions.width,height:l.pdfHeight/e.pageDimensions.height,text:l.label,color:l.color,view_type:l.viewType||"plan",notes:l.notes||null,room_type:l.type};return a?l.type==="cabinet"&&e.activeCabinetId?(c.cabinet_specification_id=e.activeCabinetId,c.cabinet_run_id=e.activeCabinetRunId,c.room_location_id=e.activeLocationId,c.room_id=e.activeRoomId,console.log(`üîó Linking new annotation to existing cabinet ${e.activeCabinetId}`)):(c.room_id=l.roomId||e.activeRoomId||null,c.room_location_id=l.roomLocationId||e.activeLocationId||null,c.cabinet_run_id=l.cabinetRunId||e.activeCabinetRunId||null,c.cabinet_specification_id=l.cabinetSpecId||null,c.context={project_id:e.projectId,room_id:c.room_id,room_location_id:c.room_location_id,cabinet_run_id:c.cabinet_run_id,location_type:"wall",run_type:"base",position_in_run:0,product_variant_id:1},console.log("üÜï New annotation will create entity:",c.context)):(c.room_id=l.roomId||null,c.room_location_id=l.roomLocationId||null,c.cabinet_run_id=l.cabinetRunId||null,c.cabinet_specification_id=l.cabinetSpecId||null),c}),r=await fetch(`/api/pdf/page/${e.pdfPageId}/annotations`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":w()},body:JSON.stringify({annotations:i,create_entities:!0})});if(!r.ok){const l=r.headers.get("content-type");if(l&&l.includes("text/html")){const a=await r.text();throw console.error("Server returned HTML error page:",a.substring(0,500)),new Error(`Server error (${r.status}): Check console for details`)}throw new Error(`Server error: ${r.status} ${r.statusText}`)}const t=await r.json();if(t.success)console.log(`‚úì Saved ${t.count} annotations`),n||alert(`Successfully saved ${t.count} annotations!`),o&&await o();else throw new Error(t.error||"Failed to save annotations")}catch(i){throw console.error("Failed to save annotations:",i),alert(`Error saving annotations: ${i.message}`),i}}async function Pe(e,o,n){if(confirm(`Delete "${e.label}"?`)){if(console.log("üóëÔ∏è Deleting annotation:",e),e.id.toString().startsWith("temp_")){o.annotations=o.annotations.filter(i=>i.id!==e.id),console.log("‚úì Temporary annotation removed from local state");return}try{const r=await(await fetch(`/api/pdf/page/annotations/${e.id}`,{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":w()}})).json();if(r.success)o.annotations=o.annotations.filter(t=>t.id!==e.id),console.log("‚úì Annotation deleted successfully"),n&&await n();else throw new Error(r.error||"Failed to delete annotation")}catch(i){throw console.error("Failed to delete annotation:",i),alert(`Error deleting annotation: ${i.message}`),i}}}function Ee(e,o){console.log("‚úèÔ∏è Editing annotation:",e);const n={...e,pdfPageId:o.pdfPageId,projectId:o.projectId};window.Livewire.dispatch("edit-annotation",{annotation:n})}function U(e,o,n){if(!o||!n.annotations)return null;console.log(`üîç [findAnnotationByEntity] Looking for ${e} with ID ${o}`);for(const i of n.annotations){if(e==="room"&&i.roomId===o&&i.type==="room")return console.log("‚úÖ Found room annotation:",i),i;if(e==="room_location"&&i.roomLocationId===o&&i.type==="location")return console.log("‚úÖ Found location annotation:",i),i;if(e==="cabinet_run"&&i.cabinetRunId===o&&i.type==="cabinet_run")return console.log("‚úÖ Found cabinet run annotation:",i),i}return console.log(`‚ùå No annotation found for ${e} with ID ${o}`),null}function De(e,o){if(!o.annotations)return null;console.log(`üîç [checkForDuplicateEntity] Checking for duplicates - mode: ${e}`);let n=null,i=null;if(e==="room")n="room",i=o.activeRoomId;else if(e==="location")n="room_location",i=o.activeLocationId;else if(e==="cabinet_run")n="cabinet_run",i=o.activeLocationId;else if(e==="cabinet")return null;if(!i)return console.log("‚úÖ No entity selected - allowing new entity creation"),null;const r=U(n,i,o);return r?(console.log(`‚ö†Ô∏è Duplicate found! Entity ${i} already has annotation:`,r),r):(console.log("‚úÖ No duplicate found - safe to draw"),null)}function He(e,o){const n=e.color;e.color="#ff0000",setTimeout(()=>{e.color=n},2e3),console.log(`üéØ Highlighted annotation: ${e.label}`)}function ke(e,o){var n;return o.activeAnnotationId===e.id||((n=o.selectedAnnotation)==null?void 0:n.id)===e.id?100:10}function Oe(e,o){e.locked=!e.locked,console.log(`${e.locked?"üîí":"üîì"} ${e.locked?"Locked":"Unlocked"} annotation: ${e.label}`),e.locked&&o.activeAnnotationId===e.id&&(o.activeAnnotationId=null,o.selectedAnnotation=null)}const Cn=Object.freeze(Object.defineProperty({__proto__:null,checkForDuplicateEntity:De,deleteAnnotation:Pe,editAnnotation:Ee,findAnnotationByEntity:U,getAnnotationZIndex:ke,highlightAnnotation:He,loadAnnotations:xe,saveAnnotations:Ce,toggleLockAnnotation:Oe},Symbol.toStringTag,{value:"Module"})),Xe={room:0,room_location:1,cabinet_run:2,cabinet:3};function Fe(e,o){const n=[],i=!!o.activeRoomId,r=!!o.activeLocationId,t=!!o.activeCabinetRunId,l=Xe[e];return l===0||(l>=1&&!i&&n.push({type:"room",level:0,required:!0}),l>=2&&!r&&n.push({type:"room_location",level:1,required:!0}),l>=3&&!t&&n.push({type:"cabinet_run",level:2,required:!0}),console.log(`üîç [Hierarchy Detection] Drawing ${e}, missing levels:`,n)),n}function Ye(e,o,n){var u;if(!o.drawMode)return;K(o);const i=(u=n.pdfEmbed)==null?void 0:u.querySelector("canvas");if(!i)return;const r=i.getBoundingClientRect(),t=e.clientX-r.left,l=e.clientY-r.top,a=i.offsetWidth/r.width,c=i.offsetHeight/r.height,d=t*a,s=l*c;o.isDrawing=!0,o.drawStart={x:d,y:s},o.drawPreview={x:d,y:s,width:0,height:0},console.log("üñ±Ô∏è Drawing started at",{x:d,y:s},"(layout space)")}function Ve(e,o,n){var h;if(!o.isDrawing||!o.drawStart)return;const i=(h=n.pdfEmbed)==null?void 0:h.querySelector("canvas");if(!i)return;const r=i.getBoundingClientRect(),t=e.clientX-r.left,l=e.clientY-r.top,a=i.offsetWidth/r.width,c=i.offsetHeight/r.height,d=t*a,s=l*c,u=Math.min(o.drawStart.x,d),f=Math.min(o.drawStart.y,s),m=Math.abs(d-o.drawStart.x),y=Math.abs(s-o.drawStart.y);o.drawPreview={x:u,y:f,width:m,height:y}}function We(e,o,n){if(!o.isDrawing||!o.drawPreview||!n.annotationOverlay)return;C(o);const i=20;if(o.drawPreview.width<i||o.drawPreview.height<i){console.log("‚ö†Ô∏è Rectangle too small, ignoring draw"),A(o);return}console.log("‚úì Drawing finished, creating annotation..."),Qe(o,n),A(o)}function je(e){e.isDrawing&&(console.log("‚ùå Drawing cancelled (mouse left canvas)"),C(e),A(e))}function A(e){e.isDrawing=!1,e.drawStart=null,e.drawPreview=null}function Qe(e,o){const n=e.drawPreview,i=p(n.x,n.y,o,e),r=p(n.x+n.width,n.y+n.height,o,e),t={x:n.x,y:n.y,width:n.width,height:n.height};let l=null;if(e.isolationMode)l=e.isolationLevel==="room"?e.isolatedRoomId:e.isolationLevel==="location"?e.isolatedLocationId:e.isolationLevel==="cabinet_run"?e.isolatedCabinetRunId:null,console.log(`üéØ [createAnnotation] Isolation mode - parentId: ${l}`);else if(e.drawMode==="location"&&e.activeRoomId){const s=Y("room",e.activeRoomId,e);l=(s==null?void 0:s.id)||null,console.log(`üéØ [createAnnotation] Normal mode - drawing location under room ${e.activeRoomId}, found parent: ${l}`)}else if((e.drawMode==="cabinet_run"||e.drawMode==="cabinet")&&e.activeLocationId){const s=Y("room_location",e.activeLocationId,e);l=(s==null?void 0:s.id)||null,console.log(`üéØ [createAnnotation] Normal mode - drawing ${e.drawMode} under location ${e.activeLocationId}, found parent: ${l}`)}let a=null;if(e.drawMode==="location")a=e.activeLocationId;else if(e.drawMode==="cabinet_run"||e.drawMode==="cabinet")if(e.isolationMode&&e.isolationLevel==="location"){const s=e.annotations.find(u=>u.id===e.isolatedLocationId);a=(s==null?void 0:s.roomLocationId)||null}else a=e.activeLocationId;const c={id:Ne("temp"),type:e.drawMode,pdfX:i.x,pdfY:i.y,pdfWidth:Math.abs(r.x-i.x),pdfHeight:Math.abs(i.y-r.y),normalizedX:i.normalized.x,normalizedY:i.normalized.y,screenX:t.x,screenY:t.y,screenWidth:t.width,screenHeight:t.height,roomId:e.activeRoomId,roomName:e.activeRoomName,roomLocationId:a,cabinetRunId:e.drawMode==="cabinet_run"?e.activeLocationId:e.drawMode==="cabinet"&&e.isolationMode&&e.isolationLevel==="cabinet_run"?e.isolatedCabinetRunId:null,locationId:e.activeLocationId,locationName:e.activeLocationName,viewType:"plan",label:Ze(e),color:Be(e),createdAt:new Date,pdfPageId:e.pdfPageId,projectId:e.projectId,parentId:l};console.log("üìç [createAnnotation] roomLocationId set to:",a,"(activeLocationId:",e.activeLocationId,")"),e.annotations.push(c),console.log("‚úì Annotation created:",c);const d=Fe(e.drawMode,e);d.length>0?(console.log("üèóÔ∏è Missing hierarchy detected, opening builder modal:",d),window.Livewire.dispatch("open-hierarchy-builder",{annotation:c,missingLevels:d,context:{projectId:e.projectId,roomId:e.activeRoomId,locationId:e.activeLocationId,cabinetRunId:e.activeCabinetRunId}})):(console.log("‚úÖ Complete hierarchy, opening annotation editor"),window.Livewire.dispatch("edit-annotation",{annotation:c}))}function Ze(e){if(e.drawMode==="room")return e.activeRoomName||"Room";if(e.drawMode==="location")return`Location ${e.annotations.filter(n=>n.type==="location"&&n.roomId===e.activeRoomId).length+1}`;{const o=e.annotations.filter(n=>n.type===e.drawMode&&n.locationId===e.activeLocationId).length+1;return e.drawMode==="cabinet_run"?`Run ${o}`:`Cabinet ${o}`}}function Be(e){return x(e.drawMode)}function Ue(e,o,n,i){if(o.drawMode===e){o.drawMode=null;return}if(n){const r=n(e);if(r){window.FilamentNotification&&new window.FilamentNotification().title("Annotation Already Exists").warning().body(`${r.label} already has an annotation on this page. Highlighting it now.`).send(),i&&i(r);return}}o.drawMode=e}function Ke(e){return(e.isolationMode&&e.isolationLevel==="room"||e.activeRoomId)&&e.pdfReady}function qe(e){return(e.isolationMode&&e.isolationLevel==="location"||e.isolationMode&&e.isolationLevel==="cabinet_run"||e.activeRoomId&&e.activeLocationId)&&e.pdfReady}function Ge(e){e.activeRoomId=null,e.activeRoomName="",e.activeLocationId=null,e.activeLocationName="",e.roomSearchQuery="",e.locationSearchQuery="",e.drawMode=null}function Je(e){return e.activeRoomName?e.activeLocationName?`üè† ${e.activeRoomName} ‚Üí üìç ${e.activeLocationName}`:`üè† ${e.activeRoomName}`:"No context selected"}function Y(e,o,n){if(!o||!n.annotations)return null;for(const i of n.annotations){if(e==="room"&&i.roomId===o&&i.type==="room")return i;if(e==="room_location"&&i.roomLocationId===o&&i.type==="location")return i;if(e==="cabinet_run"&&i.cabinetRunId===o&&i.type==="cabinet_run")return i}return null}function K(e){e._drawingLockout===void 0&&(e._drawingLockout=!1,e._drawingLockoutTimer=null),e._drawingLockoutTimer&&(clearTimeout(e._drawingLockoutTimer),console.log("üîÑ Drawing lockout timer reset (micro-adjustment detected)")),e._drawingLockout=!0,e._drawingLockoutTimer=setTimeout(()=>{e._drawingLockout=!1,e._drawingLockoutTimer=null,console.log("‚úì Drawing lockout released (1s inactivity)")},1e3),console.log("üîí Drawing lockout activated")}function eo(e){return e._drawingLockout===!0}function C(e){e._drawingLockoutTimer&&(clearTimeout(e._drawingLockoutTimer),e._drawingLockoutTimer=null),e._drawingLockout=!1,console.log("üîì Drawing lockout cleared")}function oo(e,o){!e||!e.type||(console.log("üéØ Setting drawing context from:",e.type,e.label||e.id),e.type==="room"?(o.activeRoomId=e.roomId,o.activeRoomName=e.label,o.roomSearchQuery=e.label,o.activeLocationId=null,o.activeLocationName="",o.locationSearchQuery="",console.log(`‚úì Context set: üè† ${e.label} (can now draw Locations)`)):e.type==="location"?(o.activeRoomId=e.roomId,o.activeRoomName=v(e.roomId,o),o.roomSearchQuery=o.activeRoomName,o.activeLocationId=e.roomLocationId||e.id,o.activeLocationName=e.label,o.locationSearchQuery=e.label,console.log(`‚úì Context set: üè† ${o.activeRoomName} ‚Üí üìç ${e.label} (can now draw Cabinet Runs)`)):e.type==="cabinet_run"?(o.activeRoomId=e.roomId,o.activeRoomName=v(e.roomId,o),o.roomSearchQuery=o.activeRoomName,o.activeLocationId=e.locationId||e.roomLocationId,o.activeLocationName=_(o.activeLocationId,o),o.locationSearchQuery=o.activeLocationName,o.activeCabinetRunId=e.cabinetRunId||e.id,o.activeCabinetRunName=e.label,console.log(`‚úì Context set: üè† ${o.activeRoomName} ‚Üí üìç ${o.activeLocationName} ‚Üí üóÑÔ∏è ${e.label} (can now draw Cabinets)`)):e.type==="cabinet"&&(o.activeRoomId=e.roomId,o.activeRoomName=v(e.roomId,o),o.roomSearchQuery=o.activeRoomName,o.activeLocationId=e.locationId,o.activeLocationName=_(e.locationId,o),o.locationSearchQuery=o.activeLocationName,o.activeCabinetRunId=e.cabinetRunId,o.activeCabinetRunName=Ae(e.cabinetRunId,o),console.log(`‚úì Context set: üè† ${o.activeRoomName} ‚Üí üìç ${o.activeLocationName} ‚Üí üóÑÔ∏è ${o.activeCabinetRunName} ‚Üí üóÇÔ∏è ${e.label}`)))}const Pn=Object.freeze(Object.defineProperty({__proto__:null,activateDrawingLockout:K,canDraw:qe,canDrawLocation:Ke,cancelDrawing:je,clearContext:Ge,clearDrawingLockout:C,finishDrawing:We,getContextLabel:Je,isDrawingLocked:eo,setDrawMode:Ue,setDrawingContextFromNode:oo,startDrawing:Ye,updateDrawPreview:Ve},Symbol.toStringTag,{value:"Module"}));function no(e,o,n,i){e.stopPropagation(),P(i),i.isResizing=!0,i.activeAnnotationId=o.id,i.resizeHandle=n,i.resizeStart={mouseX:e.clientX,mouseY:e.clientY,annoX:o.screenX,annoY:o.screenY,annoWidth:o.screenWidth,annoHeight:o.screenHeight},console.log("üîÑ Resize started:",{annotation:o.label,handle:n}),i._resizeMoveHandler=r=>q(r,i),i._resizeEndHandler=r=>G(r,i,i._refs),document.addEventListener("mousemove",i._resizeMoveHandler),document.addEventListener("mouseup",i._resizeEndHandler),console.log("üìé Document resize listeners attached")}const q=Z(function(e,o){!o.isResizing||!o.resizeStart||io(e,o)},{},"resizeTicking");function io(e,o){console.log("üîÑ [RESIZE] updateResize called",{isResizing:o.isResizing,hasResizeStart:!!o.resizeStart,lockoutActive:o._resizeLockout,activeAnnotationId:o.activeAnnotationId});const n=e.clientX-o.resizeStart.mouseX,i=e.clientY-o.resizeStart.mouseY,r=o.annotations.find(u=>u.id===o.activeAnnotationId);if(!r){console.warn("‚ö†Ô∏è [RESIZE] No annotation found for ID:",o.activeAnnotationId);return}let t=o.resizeStart.annoX,l=o.resizeStart.annoY,a=o.resizeStart.annoWidth,c=o.resizeStart.annoHeight;const d=o.resizeHandle;d.includes("w")?(t=o.resizeStart.annoX+n,a=o.resizeStart.annoWidth-n):d.includes("e")&&(a=o.resizeStart.annoWidth+n),d.includes("n")?(l=o.resizeStart.annoY+i,c=o.resizeStart.annoHeight-i):d.includes("s")&&(c=o.resizeStart.annoHeight+i);const s=20;if(a<s||c<s){console.log("‚ö†Ô∏è [RESIZE] Size too small, skipping update");return}console.log("üìè [RESIZE] Updating annotation dimensions",{annotation:r.label,newWidth:a.toFixed(1),newHeight:c.toFixed(1)}),r.screenX=t,r.screenY=l,r.screenWidth=a,r.screenHeight=c}function G(e,o,n){if(!o.isResizing)return;const i=o.annotations.find(r=>r.id===o.activeAnnotationId);if(i&&o.resizeStart){const r=Math.abs(i.screenWidth-o.resizeStart.annoWidth),t=Math.abs(i.screenHeight-o.resizeStart.annoHeight);if(!(r>2||t>2)){console.log("‚è∏Ô∏è Resize cancelled - no significant size change detected"),i.screenX=o.resizeStart.annoX,i.screenY=o.resizeStart.annoY,i.screenWidth=o.resizeStart.annoWidth,i.screenHeight=o.resizeStart.annoHeight,o.isResizing=!1,o.resizeHandle=null,o.resizeStart=null,o.activeAnnotationId=null,N(o),o._resizeMoveHandler&&(document.removeEventListener("mousemove",o._resizeMoveHandler),document.removeEventListener("mouseup",o._resizeEndHandler),o._resizeMoveHandler=null,o._resizeEndHandler=null,console.log("üîå Document resize listeners removed (cancelled)"));return}console.log("‚úì Resize finished, saving..."),ro(i,o,n)}o.isResizing=!1,o.resizeHandle=null,o.resizeStart=null,o.activeAnnotationId=null,o._resizeMoveHandler&&(document.removeEventListener("mousemove",o._resizeMoveHandler),document.removeEventListener("mouseup",o._resizeEndHandler),o._resizeMoveHandler=null,o._resizeEndHandler=null,console.log("üîå Document resize listeners removed"))}function ro(e,o,n){const i=p(e.screenX,e.screenY,n,o),r=p(e.screenX+e.screenWidth,e.screenY+e.screenHeight,n,o);e.pdfX=i.x,e.pdfY=i.y,e.pdfWidth=Math.abs(r.x-i.x),e.pdfHeight=Math.abs(i.y-r.y),e.normalizedX=i.normalized.x,e.normalizedY=i.normalized.y,console.log("‚úì Resize completed:",e.label),oe(e,o)}function to(e,o,n){e.target.classList.contains("resize-handle")||(P(n),n.isMoving=!0,n.activeAnnotationId=o.id,n.moveStart={mouseX:e.clientX,mouseY:e.clientY,annoX:o.screenX,annoY:o.screenY},console.log("üñ±Ô∏è Move started:",o.label),n._moveMoveHandler=i=>J(i,n),n._moveEndHandler=i=>ee(i,n,n._refs),document.addEventListener("mousemove",n._moveMoveHandler),document.addEventListener("mouseup",n._moveEndHandler),console.log("üìé Document move listeners attached"))}const J=Z(function(e,o){!o.isMoving||!o.moveStart||lo(e,o)},{},"moveTicking");function lo(e,o){console.log("üñ±Ô∏è [MOVE] updateMove called",{isMoving:o.isMoving,hasMoveStart:!!o.moveStart,lockoutActive:o._resizeLockout,activeAnnotationId:o.activeAnnotationId});const n=e.clientX-o.moveStart.mouseX,i=e.clientY-o.moveStart.mouseY,r=o.annotations.find(t=>t.id===o.activeAnnotationId);if(!r){console.warn("‚ö†Ô∏è [MOVE] No annotation found for ID:",o.activeAnnotationId);return}console.log("üìç [MOVE] Updating annotation position",{annotation:r.label,deltaX:n.toFixed(1),deltaY:i.toFixed(1)}),r.screenX=o.moveStart.annoX+n,r.screenY=o.moveStart.annoY+i}function ee(e,o,n){if(!o.isMoving)return;const i=o.annotations.find(r=>r.id===o.activeAnnotationId);if(i&&o.moveStart){const r=Math.abs(i.screenX-o.moveStart.annoX),t=Math.abs(i.screenY-o.moveStart.annoY);if(!(r>2||t>2)){console.log("‚è∏Ô∏è Move cancelled - no significant movement detected"),i.screenX=o.moveStart.annoX,i.screenY=o.moveStart.annoY,o.isMoving=!1,o.moveStart=null,o.activeAnnotationId=null,N(o),o._moveMoveHandler&&(document.removeEventListener("mousemove",o._moveMoveHandler),document.removeEventListener("mouseup",o._moveEndHandler),o._moveMoveHandler=null,o._moveEndHandler=null,console.log("üîå Document move listeners removed (cancelled)"));return}console.log("‚úì Move finished, saving..."),ao(i,o,n)}o.isMoving=!1,o.moveStart=null,o.activeAnnotationId=null,o._moveMoveHandler&&(document.removeEventListener("mousemove",o._moveMoveHandler),document.removeEventListener("mouseup",o._moveEndHandler),o._moveMoveHandler=null,o._moveEndHandler=null,console.log("üîå Document move listeners removed"))}function ao(e,o,n){const i=p(e.screenX,e.screenY,n,o);e.pdfX=i.x,e.pdfY=i.y,e.normalizedX=i.normalized.x,e.normalizedY=i.normalized.y,console.log("‚úì Move completed:",e.label),oe(e,o)}function oe(e,o){console.log("üíæ [SAVE] debouncedSaveAnnotation called",{annotation:e.label,lockoutActive:o._resizeLockout,hasPendingTimeout:!!o.resizeSaveTimeout,isResizing:o.isResizing,isMoving:o.isMoving}),o._resizeLockout&&console.warn("‚ö†Ô∏è [SAVE] Resize lockout active - save requested during active resize/move!"),o.resizeSaveTimeout&&(console.log("üîÑ [SAVE] Clearing existing save timeout"),clearTimeout(o.resizeSaveTimeout)),o.pendingResizeChanges=e,o.resizeSaveTimeout=setTimeout(async()=>{var n;console.log("‚è∞ [SAVE] Save timeout fired",{annotation:(n=o.pendingResizeChanges)==null?void 0:n.label,lockoutActive:o._resizeLockout,isResizing:o.isResizing,isMoving:o.isMoving}),o.pendingResizeChanges&&(await co(o.pendingResizeChanges,o),o.pendingResizeChanges=null,N(o))},1e3),console.log("‚úì [SAVE] Save scheduled for 1s from now")}async function co(e,o){if(console.log("üåê [API] saveAnnotationToServer called",{annotation:e.label,annotationId:e.id,lockoutActive:o._resizeLockout,isResizing:o.isResizing,isMoving:o.isMoving}),e.id.toString().startsWith("temp_")){console.log("‚è≠Ô∏è [API] Skipping save for temporary annotation");return}console.log("üì§ [API] Sending PATCH request to server...");try{const i=await(await fetch(`/api/pdf/page/annotations/${e.id}`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":w()},body:JSON.stringify({x:e.normalizedX,y:e.normalizedY,width:e.pdfWidth/o.pageDimensions.width,height:e.pdfHeight/o.pageDimensions.height})})).json();if(i.success)console.log("‚úÖ [API] Annotation saved successfully:",e.label);else throw new Error(i.error||"Failed to save annotation")}catch(n){console.error("‚ùå [API] Failed to save annotation:",n)}}function so(e){return{n:"n-resize",ne:"ne-resize",e:"e-resize",se:"se-resize",s:"s-resize",sw:"sw-resize",w:"w-resize",nw:"nw-resize"}[e]||"default"}function uo(){return["n","ne","e","se","s","sw","w","nw"]}function fo(e,o=8){const n=o/2;return{n:{left:"50%",top:`-${n}px`,transform:"translateX(-50%)"},ne:{right:`-${n}px`,top:`-${n}px`},e:{right:`-${n}px`,top:"50%",transform:"translateY(-50%)"},se:{right:`-${n}px`,bottom:`-${n}px`},s:{left:"50%",bottom:`-${n}px`,transform:"translateX(-50%)"},sw:{left:`-${n}px`,bottom:`-${n}px`},w:{left:`-${n}px`,top:"50%",transform:"translateY(-50%)"},nw:{left:`-${n}px`,top:`-${n}px`}}[e]||{}}function P(e){e._resizeLockout===void 0&&(e._resizeLockout=!1),e._resizeLockout||(e._resizeLockout=!0,console.log("üîí Resize lockout activated (stays active until save completes)"))}function mo(e){return e._resizeLockout===!0}function N(e){e._resizeLockout&&(e._resizeLockout=!1,console.log("üîì Resize lockout cleared (save complete)"))}function go(e,o){if(!o.isResizing||!o.resizeStart)return;const n=e.clientX-o.resizeStart.mouseX,i=e.clientY-o.resizeStart.mouseY,r=o.annotations.find(u=>u.id===o.activeAnnotationId);if(!r)return;let t=o.resizeStart.annoX,l=o.resizeStart.annoY,a=o.resizeStart.annoWidth,c=o.resizeStart.annoHeight;const d=o.resizeHandle;d.includes("w")?(t=o.resizeStart.annoX+n,a=o.resizeStart.annoWidth-n):d.includes("e")&&(a=o.resizeStart.annoWidth+n),d.includes("n")?(l=o.resizeStart.annoY+i,c=o.resizeStart.annoHeight-i):d.includes("s")&&(c=o.resizeStart.annoHeight+i);const s=20;a<s||c<s||(r.screenX=t,r.screenY=l,r.screenWidth=a,r.screenHeight=c)}function po(e,o){if(!o.isMoving||!o.moveStart)return;const n=e.clientX-o.moveStart.mouseX,i=e.clientY-o.moveStart.mouseY,r=o.annotations.find(t=>t.id===o.activeAnnotationId);r&&(r.screenX=o.moveStart.annoX+n,r.screenY=o.moveStart.annoY+i)}function ho(e,o,n){if(o.isResizing){const i=o.annotations.find(r=>r.id===o.activeAnnotationId);if(i){const r=p(i.screenX,i.screenY,n,o),t=p(i.screenX+i.screenWidth,i.screenY+i.screenHeight,n,o);i.pdfX=r.x,i.pdfY=r.y,i.pdfWidth=Math.abs(t.x-r.x),i.pdfHeight=Math.abs(r.y-t.y),i.normalizedX=r.normalized.x,i.normalizedY=r.normalized.y}o.isResizing=!1,o.resizeHandle=null,o.resizeStart=null,o.activeAnnotationId=null}else if(o.isMoving){const i=o.annotations.find(r=>r.id===o.activeAnnotationId);if(i){const r=p(i.screenX,i.screenY,n,o);i.pdfX=r.x,i.pdfY=r.y,i.normalizedX=r.normalized.x,i.normalizedY=r.normalized.y}o.isMoving=!1,o.moveStart=null,o.activeAnnotationId=null}}const En=Object.freeze(Object.defineProperty({__proto__:null,activateResizeLockout:P,clearResizeLockout:N,finishResizeOrMove:ho,getHandlePosition:fo,getResizeCursor:so,getResizeHandles:uo,handleMove:po,handleMoveEnd:ee,handleMoveUpdate:J,handleResize:go,handleResizeEnd:G,handleResizeMove:q,isResizeLocked:mo,startMove:to,startResize:no},Symbol.toStringTag,{value:"Module"}));function vo(e,o){if(e.isUndoRedoAction)return;const n={annotations:b(e.annotations),timestamp:Date.now(),action:o};e.historyIndex<e.historyStack.length-1&&(e.historyStack=e.historyStack.slice(0,e.historyIndex+1)),e.historyStack.push(n),e.historyStack.length>e.maxHistorySize?e.historyStack.shift():e.historyIndex++,console.log(`üìö History: ${o} (${e.historyIndex+1}/${e.historyStack.length})`)}function ne(e){if(!E(e)){console.log("‚èÆÔ∏è Nothing to undo");return}e.historyIndex--;const o=e.historyStack[e.historyIndex];e.isUndoRedoAction=!0,e.annotations=b(o.annotations),e.isUndoRedoAction=!1,console.log(`‚èÆÔ∏è Undo: ${o.action} (${e.historyIndex+1}/${e.historyStack.length})`)}function ie(e){if(!D(e)){console.log("‚è≠Ô∏è Nothing to redo");return}e.historyIndex++;const o=e.historyStack[e.historyIndex];e.isUndoRedoAction=!0,e.annotations=b(o.annotations),e.isUndoRedoAction=!1,console.log(`‚è≠Ô∏è Redo: ${o.action} (${e.historyIndex+1}/${e.historyStack.length})`)}function E(e){return e.historyIndex>0}function D(e){return e.historyIndex<e.historyStack.length-1}function yo(e){e.historyStack=[],e.historyIndex=-1,console.log("üóëÔ∏è History cleared")}function wo(e){var o,n,i;return{size:e.historyStack.length,index:e.historyIndex,canUndo:E(e),canRedo:D(e),current:((o=e.historyStack[e.historyIndex])==null?void 0:o.action)||"none",next:((n=e.historyStack[e.historyIndex+1])==null?void 0:n.action)||"none",previous:((i=e.historyStack[e.historyIndex-1])==null?void 0:i.action)||"none"}}function Io(e){document.addEventListener("keydown",o=>{(o.ctrlKey||o.metaKey)&&o.key==="z"&&!o.shiftKey&&(o.preventDefault(),ne(e)),(o.ctrlKey||o.metaKey)&&(o.shiftKey&&o.key==="z"||o.key==="y")&&(o.preventDefault(),ie(e))}),console.log("‚å®Ô∏è Undo/Redo keyboard shortcuts registered")}const Dn=Object.freeze(Object.defineProperty({__proto__:null,canRedo:D,canUndo:E,clearHistory:yo,getHistoryInfo:wo,pushToHistory:vo,redo:ie,setupUndoRedoKeyboards:Io,undo:ne},Symbol.toStringTag,{value:"Module"}));async function Ro(e,o,n){if(console.log("üîí Entering isolation mode for:",e.type,e.label),o.isolationViewType=o.activeViewType,o.isolationOrientation=o.activeOrientation,console.log(`üìê Isolation view context: ${o.isolationViewType}${o.isolationOrientation?` (${o.isolationOrientation})`:""}`),e.type==="cabinet_run")o.isolationMode=!0,o.isolationLevel="cabinet_run",o.isolatedRoomId=e.roomId,o.isolatedRoomName=e.roomName||v(e.roomId,o),o.isolatedLocationId=e.locationId||e.roomLocationId,o.isolatedLocationName=e.locationName||_(e.locationId||e.roomLocationId,o),o.isolatedCabinetRunId=e.id,o.isolatedCabinetRunEntityId=e.cabinetRunId,o.isolatedCabinetRunName=e.label,o.activeRoomId=e.roomId,o.activeRoomName=o.isolatedRoomName,o.activeLocationId=e.locationId||e.roomLocationId,o.activeLocationName=o.isolatedLocationName,o.roomSearchQuery=o.isolatedRoomName,o.locationSearchQuery=o.isolatedLocationName,console.log(`‚úì Cabinet Run isolation: üè† ${o.isolatedRoomName} ‚Üí üìç ${o.isolatedLocationName} ‚Üí üóÑÔ∏è ${e.label}`);else if(e.type==="location")o.isolationMode=!0,o.isolationLevel="location",o.isolatedRoomId=e.roomId,o.isolatedRoomName=e.roomName||v(e.roomId,o),o.isolatedLocationId=e.id,o.isolatedLocationName=e.label,o.isolatedCabinetRunId=null,o.isolatedCabinetRunEntityId=null,o.isolatedCabinetRunName="",o.activeRoomId=e.roomId,o.activeRoomName=o.isolatedRoomName,o.activeLocationId=e.roomLocationId,o.activeLocationName=e.label,o.roomSearchQuery=o.isolatedRoomName,o.locationSearchQuery=e.label,console.log(`‚úì Location isolation: üè† ${o.isolatedRoomName} ‚Üí üìç ${e.label} (entity ID: ${e.roomLocationId})`);else{const i=e.type==="room"?e.id:e.roomId,r=e.roomId,t=e.type==="room"?e.label:e.roomName||v(e.roomId,o);o.isolationMode=!0,o.isolationLevel="room",o.isolatedRoomId=i,o.isolatedRoomEntityId=r,o.isolatedRoomName=t,o.isolatedLocationId=null,o.isolatedLocationName="",o.isolatedCabinetRunId=null,o.isolatedCabinetRunEntityId=null,o.isolatedCabinetRunName="",o.activeRoomId=r,o.activeRoomName=t,o.activeLocationId=null,o.activeLocationName="",o.locationSearchQuery="",o.roomSearchQuery=t,console.log(`‚úì Room isolation: üè† ${t} (annoId: ${i}, entityId: ${r})`)}o.expandedNodes.includes(o.isolatedRoomId)||o.expandedNodes.push(o.isolatedRoomId),o.isolatedLocationId&&!o.expandedNodes.includes(o.isolatedLocationId)&&o.expandedNodes.push(o.isolatedLocationId),o.isolatedCabinetRunId&&!o.expandedNodes.includes(o.isolatedCabinetRunId)&&o.expandedNodes.push(o.isolatedCabinetRunId),o.selectedNodeId=o.isolationLevel==="cabinet_run"?o.isolatedCabinetRunId:o.isolationLevel==="location"?o.isolatedLocationId:o.isolatedRoomId,So(o),n.zoomToFitAnnotation&&await n.zoomToFitAnnotation(e),n.$nextTick&&await n.$nextTick(),await new Promise(i=>setTimeout(i,100)),n.syncOverlayToCanvas&&n.syncOverlayToCanvas(),n.$nextTick&&await n.$nextTick(),await new Promise(i=>setTimeout(i,150)),H(o)}async function bo(e,o){console.log("üîì Exiting isolation mode"),e.isolationMode=!1,e.isolationLevel=null,e.isolatedRoomId=null,e.isolatedRoomName="",e.isolatedLocationId=null,e.isolatedLocationName="",e.isolatedCabinetRunId=null,e.isolatedCabinetRunEntityId=null,e.isolatedCabinetRunName="",e.isolationViewType=null,e.isolationOrientation=null,o.clearContext&&o.clearContext(),e.selectedNodeId=null,console.log(`üëÅÔ∏è [EXIT ISOLATION] Clearing hidden annotations (was: [${e.hiddenAnnotations.join(", ")}])`),e.hiddenAnnotations=[],o.resetZoom&&await o.resetZoom(),console.log("‚úì Returned to normal view with reset zoom"),H(e)}function So(e){e.hiddenAnnotations=[],e.annotations.forEach(o=>{re(o,e)||(console.log(`üëÅÔ∏è [ENTER ISOLATION] Hiding annotation ${o.id} (${o.label} - type: ${o.type})`),e.hiddenAnnotations.push(o.id))}),console.log(`üëÅÔ∏è [ENTER ISOLATION] Hidden annotations: [${e.hiddenAnnotations.join(", ")}]`)}function re(e,o){return o.isolationMode?Lo(e,o)?o.isolationLevel==="room"?e.id===o.isolatedRoomId||e.type==="location"&&e.roomId===o.isolatedRoomEntityId:o.isolationLevel==="location"?e.type==="cabinet_run"&&e.roomLocationId===o.activeLocationId:o.isolationLevel==="cabinet_run"?e.type==="cabinet"&&e.cabinetRunId===o.isolatedCabinetRunEntityId:!0:!1:e.type==="room"||e.type==="location"}function Lo(e,o){const n=o.isolationMode?o.isolationViewType:o.activeViewType,i=o.isolationMode?o.isolationOrientation:o.activeOrientation;return!n||!e.viewType?!0:!(e.viewType!==n||(n==="elevation"||n==="section")&&i&&e.orientation!==i)}function H(e){const o=document.getElementById("maskRects");if(!o)return;o.innerHTML="",console.log(`üìê [MASK UPDATE] Overlay dimensions: ${e.overlayWidth} √ó ${e.overlayHeight}`);const n=e.annotations.filter(r=>!e.hiddenAnnotations.includes(r.id));let i=null;if(e.isolationMode&&(e.isolationLevel==="room"?i=e.annotations.find(r=>r.type==="room"&&r.roomId===e.isolatedRoomId):e.isolationLevel==="location"?i=e.annotations.find(r=>r.type==="location"&&r.roomLocationId===e.isolatedLocationId):e.isolationLevel==="cabinet_run"&&(i=e.annotations.find(r=>r.type==="cabinet_run"&&r.cabinetRunId===e.isolatedCabinetRunId))),i&&i.screenX!==void 0){const r=V(i);o.appendChild(r),console.log(`‚úì Added isolated entity boundary to mask: ${i.label}`)}n.forEach(r=>{if(r.screenX!==void 0&&r.screenWidth>0&&r.screenHeight>0){const t=V(r);o.appendChild(t)}})}function V(e){const n=(e.screenX||0)-15,i=(e.screenY||0)-15,r=(e.screenWidth||0)+15*2,t=(e.screenHeight||0)+15*2;return $e("rect",{x:n,y:i,width:r,height:t,fill:"black",rx:"8",filter:"url(#feather)"})}function _o(e){if(!e.isolationMode)return[];const o=[];return e.isolatedRoomName&&o.push({label:e.isolatedRoomName,level:"room",icon:"üè†"}),e.isolatedLocationName&&o.push({label:e.isolatedLocationName,level:"location",icon:"üìç"}),e.isolatedCabinetRunName&&o.push({label:e.isolatedCabinetRunName,level:"cabinet_run",icon:"üóÑÔ∏è"}),o}const Hn=Object.freeze(Object.defineProperty({__proto__:null,enterIsolationMode:Ro,exitIsolationMode:bo,getIsolationBreadcrumbs:_o,isAnnotationVisibleInIsolation:re,updateIsolationMask:H},Symbol.toStringTag,{value:"Module"}));function zo(e){let o=[...e.annotations];if(e.filterScope==="page"&&(o=o.filter(n=>n.pageNumber===e.currentPage)),e.filters.types.length>0&&(o=o.filter(n=>e.filters.types.includes(n.type))),e.filters.rooms.length>0&&(o=o.filter(n=>e.filters.rooms.includes(n.roomId))),e.filters.locations.length>0&&(o=o.filter(n=>e.filters.locations.includes(n.locationId))),e.filters.viewTypes.length>0&&(o=o.filter(n=>e.filters.viewTypes.includes(n.viewType))),e.filters.verticalZones.length>0&&(o=o.filter(n=>e.filters.verticalZones.includes(n.verticalZone))),e.filters.myAnnotations){const n=window.currentUserId;o=o.filter(i=>i.createdBy===n)}if(e.filters.recent){const n=new Date;n.setDate(n.getDate()-1),o=o.filter(i=>new Date(i.createdAt)>n)}if(e.filters.unlinked&&(o=o.filter(n=>!n.roomId&&!n.locationId&&!n.cabinetRunId)),e.filters.pageRange.from||e.filters.pageRange.to){const n=e.filters.pageRange.from||1,i=e.filters.pageRange.to||e.totalPages;o=o.filter(r=>r.pageNumber>=n&&r.pageNumber<=i)}if(e.filters.dateRange.from||e.filters.dateRange.to){const n=e.filters.dateRange.from?new Date(e.filters.dateRange.from):new Date(0),i=e.filters.dateRange.to?new Date(e.filters.dateRange.to):new Date;o=o.filter(r=>{const t=new Date(r.createdAt);return t>=n&&t<=i})}return o}function te(e){let o=0;return e.filterScope==="all"&&o++,o+=e.filters.types.length,o+=e.filters.rooms.length,o+=e.filters.locations.length,o+=e.filters.viewTypes.length,o+=e.filters.verticalZones.length,e.filters.myAnnotations&&o++,e.filters.recent&&o++,e.filters.unlinked&&o++,(e.filters.pageRange.from||e.filters.pageRange.to)&&o++,(e.filters.dateRange.from||e.filters.dateRange.to)&&o++,o}function No(e){const o=[];if(e.filterScope==="all"&&o.push({type:"scope",label:"All Pages",key:"filterScope"}),e.filters.types.forEach(n=>{o.push({type:"array",arrayKey:"types",value:n,label:`Type: ${Co(n)}`})}),e.filters.rooms.forEach(n=>{const i=v(n,e);o.push({type:"array",arrayKey:"rooms",value:n,label:`Room: ${i}`})}),e.filters.locations.forEach(n=>{const i=_(n,e);o.push({type:"array",arrayKey:"locations",value:n,label:`Location: ${i}`})}),e.filters.viewTypes.forEach(n=>{o.push({type:"array",arrayKey:"viewTypes",value:n,label:`View: ${Po(n)}`})}),e.filters.verticalZones.forEach(n=>{o.push({type:"array",arrayKey:"verticalZones",value:n,label:`Zone: ${n}`})}),e.filters.myAnnotations&&o.push({type:"boolean",key:"myAnnotations",label:"My Work"}),e.filters.recent&&o.push({type:"boolean",key:"recent",label:"Recent (24h)"}),e.filters.unlinked&&o.push({type:"boolean",key:"unlinked",label:"Unlinked"}),e.filters.pageRange.from||e.filters.pageRange.to){const n=e.filters.pageRange.from||1,i=e.filters.pageRange.to||e.totalPages;o.push({type:"range",key:"pageRange",label:`Pages ${n}-${i}`})}if(e.filters.dateRange.from||e.filters.dateRange.to){const n=e.filters.dateRange.from||"start",i=e.filters.dateRange.to||"end";o.push({type:"range",key:"dateRange",label:`Date: ${n} to ${i}`})}return o}function $o(e){const o=new Set,n=new Map,i=new Map,r=new Set,t=new Set;return e.annotations.forEach(l=>{l.type&&o.add(l.type),l.roomId&&l.roomName&&n.set(l.roomId,l.roomName),l.locationId&&l.locationName&&i.set(l.locationId,l.locationName),l.viewType&&r.add(l.viewType),l.verticalZone&&t.add(l.verticalZone)}),{types:Array.from(o).sort(),rooms:Array.from(n.entries()).map(([l,a])=>({id:l,name:a})).sort((l,a)=>l.name.localeCompare(a.name)),locations:Array.from(i.entries()).map(([l,a])=>({id:l,name:a})).sort((l,a)=>l.name.localeCompare(a.name)),viewTypes:Array.from(r).sort(),verticalZones:Array.from(t).sort()}}function le(e){e.filterScope="page",e.filters.types=[],e.filters.rooms=[],e.filters.locations=[],e.filters.viewTypes=[],e.filters.verticalZones=[],e.filters.myAnnotations=!1,e.filters.recent=!1,e.filters.unlinked=!1,e.filters.pageRange.from=null,e.filters.pageRange.to=null,e.filters.dateRange.from=null,e.filters.dateRange.to=null,console.log("‚úì All filters cleared")}function Ao(e,o){if(e.type==="boolean")o.filters[e.key]=!1;else if(e.type==="array"){const n=o.filters[e.arrayKey].indexOf(e.value);n>-1&&o.filters[e.arrayKey].splice(n,1)}else e.type==="scope"?o.filterScope="page":e.type==="range"&&(e.key==="pageRange"?(o.filters.pageRange.from=null,o.filters.pageRange.to=null):e.key==="dateRange"&&(o.filters.dateRange.from=null,o.filters.dateRange.to=null));console.log("‚úì Filter removed:",e.label)}function xo(e,o){switch(le(o),e){case"myWork":o.filters.myAnnotations=!0;break;case"recent":o.filters.recent=!0;break;case"unlinked":o.filters.unlinked=!0;break}console.log("‚úì Preset applied:",e)}function Mo(e,o){const n=te(o);switch(e){case"myWork":return o.filters.myAnnotations&&n===1;case"recent":return o.filters.recent&&n===1;case"unlinked":return o.filters.unlinked&&n===1;case"all":return n===0;default:return!1}}function To(e){if(e.filters.viewTypes.length===0)return Array.from({length:e.totalPages},(n,i)=>i+1);const o=new Set;return Object.entries(e.pageMap).forEach(([n,i])=>{e.annotations.some(t=>t.pageNumber===parseInt(n)&&e.filters.viewTypes.includes(t.viewType))&&o.add(parseInt(n))}),Array.from(o).sort((n,i)=>n-i)}function Co(e){return{room:"Room",location:"Location",cabinet_run:"Cabinet Run",cabinet:"Cabinet"}[e]||e}function Po(e){return{plan:"Plan",elevation:"Elevation",section:"Section",detail:"Detail"}[e]||e}const kn=Object.freeze(Object.defineProperty({__proto__:null,applyFilterPreset:xo,clearAllFilters:le,countActiveFilters:te,getActiveFilterChips:No,getAvailableFilterOptions:$o,getFilteredAnnotations:zo,getFilteredPageNumbers:To,isPresetActive:Mo,removeFilterChip:Ao},Symbol.toStringTag,{value:"Module"}));async function ae(e){e.loading=!0;try{const n=await(await fetch(`/api/projects/${e.projectId}/tree`)).json();e.tree=de(n),e.treeReady=!0,console.log("‚úì Tree loaded:",e.tree)}catch(o){e.error="Failed to load project tree",console.error(o)}finally{e.loading=!1}}async function ce(e,o={}){if(e._resizeLockout||e.isResizing||e.isMoving){console.log("‚è≥ Tree refresh deferred - resize/move in progress"),setTimeout(()=>ce(e,o),100);return}console.log("üå≥ Refreshing project tree"),await ae(e),(o.$refs||null)&&(o.$nextTick&&await o.$nextTick(),o.syncOverlayToCanvas&&o.syncOverlayToCanvas(),console.log("‚úì Annotation positions recalculated after tree refresh"))}function de(e){return Array.isArray(e)?e.map(o=>{const n={...o};return n.children?Array.isArray(n.children)&&(n.children=de(n.children)):n.children=[],n}):[]}function Eo(e,o){const n=o.expandedNodes.indexOf(e);n>-1?o.expandedNodes.splice(n,1):o.expandedNodes.push(e)}function Do(e,o){return o.expandedNodes.includes(e)}async function Ho(e,o,n){var m,y,h,X,F;const{nodeId:i,type:r,name:t,parentRoomId:l=null,parentLocationId:a=null,parentCabinetRunId:c=null}=e;o.selectedNodeId=i;const d=[];let s=null,u=null,f=null;if(r==="room")d.push(i),o.activeRoomId=i,o.activeRoomName=t,o.roomSearchQuery=t,o.activeLocationId=null,o.activeLocationName="",o.locationSearchQuery="",s=o.tree.find(g=>g.id===i);else if(r==="room_location")l&&d.push(l),d.push(i),o.activeRoomId=l,o.activeLocationId=i,o.activeLocationName=t,o.locationSearchQuery=t,f=o.tree.find(g=>g.id===l),f&&(o.activeRoomName=f.name,o.roomSearchQuery=f.name,s=(m=f.children)==null?void 0:m.find(g=>g.id===i));else if(r==="cabinet_run")l&&d.push(l),a&&d.push(a),d.push(i),o.activeRoomId=l,o.activeLocationId=a,o.activeCabinetRunId=i,o.activeCabinetRunName=t,f=o.tree.find(g=>g.id===l),f&&(o.activeRoomName=f.name,o.roomSearchQuery=f.name,u=(y=f.children)==null?void 0:y.find(g=>g.id===a),u&&(o.activeLocationName=u.name,o.locationSearchQuery=u.name,s=(h=u.children)==null?void 0:h.find(g=>g.id===i)));else if(r==="cabinet"&&(l&&d.push(l),a&&d.push(a),c&&d.push(c),d.push(i),o.activeRoomId=l,o.activeLocationId=a,o.activeCabinetRunId=c,o.activeCabinetId=i,o.activeCabinetName=t,f=o.tree.find(g=>g.id===l),f&&(o.activeRoomName=f.name,o.roomSearchQuery=f.name,u=(X=f.children)==null?void 0:X.find(g=>g.id===a),u))){o.activeLocationName=u.name,o.locationSearchQuery=u.name;const g=(F=u.children)==null?void 0:F.find(fe=>fe.id===c);g&&(o.activeCabinetRunName=g.name)}o.selectedPath=d,n.navigateToNodePage&&await n.navigateToNodePage(s,u,f),console.log("üå≥ Selected node:",{nodeId:i,type:r,name:t,path:d})}async function se(e,o,n,i,r){const t=i.activeViewType;let l=null;if(e&&e.pages&&e.pages.length>0){const a=e.pages.find(c=>c.viewType===t);a&&(l=a.page,console.log(`üìç Found ${t} view on ${e.name} at page ${l}`))}if(!l&&o&&o.pages&&o.pages.length>0){const a=o.pages.find(c=>c.viewType===t);a&&(l=a.page,console.log(`üìç Found ${t} view on parent location ${o.name} at page ${l}`))}if(!l&&n&&n.pages&&n.pages.length>0){const a=n.pages.find(c=>c.viewType===t);a&&(l=a.page,console.log(`üìç Found ${t} view on parent room ${n.name} at page ${l}`))}!l&&e&&e.pages&&e.pages.length>0&&(l=e.pages[0].page,console.log(`üìç No ${t} view found, using first available page ${l}`)),l&&l!==i.currentPage&&r.goToPage&&await r.goToPage(l)}function ko(e,o,n){const{nodeId:i,nodeType:r,nodeName:t,parentRoomId:l=null,parentLocationId:a=null}=o;console.log("üñ±Ô∏è Right-click detected!",{nodeId:i,nodeType:r,nodeName:t}),n.contextMenu={show:!0,x:e.clientX,y:e.clientY,nodeId:i,nodeType:r,nodeName:t,parentRoomId:l,parentLocationId:a},console.log("‚úì Context menu state updated:",n.contextMenu)}async function Oo(e,o){const{nodeId:n,nodeType:i,nodeName:r}=e.contextMenu;if(!confirm(`Are you sure you want to delete "${r}"? This will also delete all associated annotations and data.`)){e.contextMenu.show=!1;return}console.log(`üóëÔ∏è Deleting ${i}:`,n);try{let t="";i==="room"?t=`/api/project/room/${n}`:i==="room_location"?t=`/api/project/location/${n}`:i==="cabinet_run"&&(t=`/api/project/cabinet-run/${n}`);const a=await(await fetch(t,{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":w()}})).json();if(a.success)console.log(`‚úì ${i} deleted successfully`),e.contextMenu.show=!1,o&&await o(),e.selectedNodeId===n&&(e.activeRoomId=null,e.activeRoomName="",e.activeLocationId=null,e.activeLocationName="",e.roomSearchQuery="",e.locationSearchQuery="",e.drawMode=null,e.selectedNodeId=null);else throw new Error(a.error||`Failed to delete ${i}`)}catch(t){console.error(`Failed to delete ${i}:`,t),alert(`Error deleting ${i}: ${t.message}`),e.contextMenu.show=!1}}async function Xo(e,o,n){var s,u,f;const{nodeId:i,nodeType:r,parentRoomId:t=null,parentLocationId:l=null}=e;let a=null,c=null,d=null;r==="room"?a=o.tree.find(m=>m.id===i):r==="room_location"?(d=o.tree.find(m=>m.id===t),d&&(a=(s=d.children)==null?void 0:s.find(m=>m.id===i))):r==="cabinet_run"&&(d=o.tree.find(m=>m.id===t),d&&(c=(u=d.children)==null?void 0:u.find(m=>m.id===l),c&&(a=(f=c.children)==null?void 0:f.find(m=>m.id===i)))),(a||c||d)&&await se(a,c,d,o,n)}function ue(e){const o=new Map;e.forEach(i=>{o.set(i.id,{...i,children:[]})});const n=[];return o.forEach(i=>{i.parentId&&o.has(i.parentId)?o.get(i.parentId).children.push(i):n.push(i)}),n}function Fo(e){const o=new Map;return Object.keys(e.pageMap).forEach(i=>{o.set(parseInt(i),{pageNumber:parseInt(i),annotations:[]})}),(e.filteredAnnotations||e.annotations).forEach(i=>{const r=i.pageNumber||e.currentPage;o.has(r)?o.get(r).annotations.push(i):o.set(r,{pageNumber:r,annotations:[i]})}),o.forEach((i,r)=>{i.annotations=ue(i.annotations)}),Array.from(o.values()).sort((i,r)=>i.pageNumber-r.pageNumber)}const On=Object.freeze(Object.defineProperty({__proto__:null,buildAnnotationTree:ue,deleteTreeNode:Oo,getPageGroupedAnnotations:Fo,isExpanded:Do,loadTree:ae,navigateOnDoubleClick:Xo,navigateToNodePage:se,refreshTree:ce,selectNode:Ho,showContextMenu:ko,toggleNode:Eo},Symbol.toStringTag,{value:"Module"}));async function Yo(e,o){if(e.navigating){console.log("‚è∏Ô∏è Navigation already in progress");return}const n=o.getFilteredPageNumbers?o.getFilteredPageNumbers():$(e);if(n.length===0){console.log("‚ö†Ô∏è No pages match the current filter criteria");return}const i=n.indexOf(e.currentPage);if(i<n.length-1){e.navigating=!0;try{const r=n[i+1];await k(r,e,o)}finally{e.navigating=!1}}else console.log("üìÑ Already at last page matching filters")}async function Vo(e,o){if(e.navigating){console.log("‚è∏Ô∏è Navigation already in progress");return}const n=o.getFilteredPageNumbers?o.getFilteredPageNumbers():$(e);if(n.length===0){console.log("‚ö†Ô∏è No pages match the current filter criteria");return}const i=n.indexOf(e.currentPage);if(i>0){e.navigating=!0;try{const r=n[i-1];await k(r,e,o)}finally{e.navigating=!1}}else console.log("üìÑ Already at first page matching filters")}async function Wo(e,o,n){if(o.navigating){console.log("‚è∏Ô∏è Navigation already in progress");return}if(e<1||e>o.totalPages){console.warn(`‚ö†Ô∏è Invalid page number: ${e}`);return}o.navigating=!0;try{await k(e,o,n)}finally{o.navigating=!1}}async function k(e,o,n){console.log(`üìÑ Navigating to page ${e}`),o.currentPage=e,jo(e,o),o.annotations=[],n.displayPdf&&await n.displayPdf(),n.loadAnnotations&&await n.loadAnnotations(),console.log(`‚úì Navigated to page ${e}`)}function jo(e,o){const n=o.pageMap[e];n?(o.pdfPageId=n,console.log(`‚úì Updated pdfPageId to ${o.pdfPageId} for page ${e}`)):console.warn(`‚ö†Ô∏è No pdfPageId found for page ${e} in pageMap`)}function $(e){return Array.from({length:e.totalPages},(o,n)=>n+1)}function Qo(e,o){const n=o?o():$(e);return n.indexOf(e.currentPage)<n.length-1}function Zo(e,o){return(o?o():$(e)).indexOf(e.currentPage)>0}const Xn=Object.freeze(Object.defineProperty({__proto__:null,canGoNext:Qo,canGoPrevious:Zo,goToPage:Wo,nextPage:Yo,previousPage:Vo},Symbol.toStringTag,{value:"Module"}));function Bo(e,o){console.log("üîç Searching rooms with query:",e);const n=o.tree?o.tree.map(i=>({id:i.id,name:i.name,isNew:!1})):[];if(!e||e.trim()==="")o.roomSuggestions=n,console.log(`‚úì Showing ${n.length} existing rooms`);else{const i=e.toLowerCase(),r=n.filter(t=>t.name.toLowerCase().includes(i));o.roomSuggestions=[{id:"new_"+Date.now(),name:e,isNew:!0},...r],console.log(`‚úì Found ${r.length} matching rooms, showing "Create ${e}" option`)}}async function Uo(e,o,n){if(console.log("üè† Selecting room:",e),e.isNew){console.log("üìù Creating new room:",e.name);try{const r=await(await fetch(`/api/project/${o.projectId}/rooms`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":w()},body:JSON.stringify({name:e.name,room_type:null})})).json();if(r.success&&r.room)console.log("‚úì Room created successfully:",r.room),o.activeRoomId=r.room.id,o.activeRoomName=r.room.name,o.roomSearchQuery=r.room.name,o.showRoomDropdown=!1,n&&await n(),console.log("‚úì Room added to project tree");else throw new Error(r.error||"Failed to create room")}catch(i){console.error("‚ùå Failed to create room:",i),alert(`Error creating room: ${i.message}`),o.showRoomDropdown=!1}}else o.activeRoomId=e.id,o.activeRoomName=e.name,o.roomSearchQuery=e.name,o.showRoomDropdown=!1,console.log("‚úì Selected existing room:",e.name)}function Ko(e,o){var r;if(!o.activeRoomId)return;console.log("üîç Searching locations with query:",e);const n=(r=o.tree)==null?void 0:r.find(t=>t.id===o.activeRoomId),i=n!=null&&n.children?n.children.map(t=>({id:t.id,name:t.name,isNew:!1})):[];if(!e||e.trim()==="")o.locationSuggestions=i,console.log(`‚úì Showing ${i.length} existing locations`);else{const t=e.toLowerCase(),l=i.filter(a=>a.name.toLowerCase().includes(t));o.locationSuggestions=[{id:"new_"+Date.now(),name:e,isNew:!0},...l],console.log(`‚úì Found ${l.length} matching locations, showing "Create ${e}" option`)}}async function qo(e,o,n){if(console.log("üìç Selecting location:",e),e.isNew){console.log("üìù Creating new location:",e.name);try{const r=await(await fetch(`/api/project/${o.projectId}/rooms/${o.activeRoomId}/locations`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":w()},body:JSON.stringify({name:e.name})})).json();if(r.success&&r.location)console.log("‚úì Location created successfully:",r.location),o.activeLocationId=r.location.id,o.activeLocationName=r.location.name,o.locationSearchQuery=r.location.name,o.showLocationDropdown=!1,n&&await n(),console.log("‚úì Location added to project tree");else throw new Error(r.error||"Failed to create location")}catch(i){console.error("‚ùå Failed to create location:",i),alert(`Error creating location: ${i.message}`),o.showLocationDropdown=!1}}else o.activeLocationId=e.id,o.activeLocationName=e.name,o.locationSearchQuery=e.name,o.showLocationDropdown=!1,console.log("‚úì Selected existing location:",e.name)}function Go(e){e.roomSearchQuery="",e.roomSuggestions=[],e.showRoomDropdown=!1}function Jo(e){e.locationSearchQuery="",e.locationSuggestions=[],e.showLocationDropdown=!1}const Fn=Object.freeze(Object.defineProperty({__proto__:null,clearLocationSearch:Jo,clearRoomSearch:Go,searchLocations:Ko,searchRooms:Bo,selectLocation:qo,selectRoom:Uo},Symbol.toStringTag,{value:"Module"}));async function en(e,o,n){const i=Math.min(e.zoomLevel+.25,e.zoomMax);await S(i,e,o,n)}async function on(e,o,n){const i=Math.max(e.zoomLevel-.25,e.zoomMin);await S(i,e,o,n)}async function nn(e,o,n){await S(1,e,o,n)}async function S(e,o,n,i){o.zoomLevel=e,o._overlayRect=null,M(o),i.displayPdf&&await i.displayPdf(),i.$nextTick&&await i.$nextTick(),await rn(n,50,500),I(n,o),o._overlayRect=null,i.$nextTick&&await i.$nextTick(),R(o,n),o.isolationMode&&i.updateIsolationMask&&i.updateIsolationMask(),console.log(`üîç Zoom set to ${Math.round(e*100)}%`)}async function rn(e,o=50,n=500){var c;const i=(c=e.pdfEmbed)==null?void 0:c.querySelector("canvas");if(!i){console.warn("‚ö†Ô∏è Canvas not found, skipping ready check");return}const r=Date.now();let t=i.offsetWidth,l=i.offsetHeight,a=0;for(;Date.now()-r<n;){await new Promise(u=>setTimeout(u,o));const d=i.offsetWidth,s=i.offsetHeight;if(d===t&&s===l&&d>0&&s>0){if(a++,a>=2){console.log(`‚úì Canvas stable at ${d} √ó ${s} (${Date.now()-r}ms)`);return}}else a=0;t=d,l=s}console.warn(`‚ö†Ô∏è Canvas not stable after ${n}ms, proceeding anyway`)}function tn(e){return Math.round(e.zoomLevel*100)}async function ln(e,o,n,i){console.log("üîç Zooming to fit annotation:",e.label);let r=null;if(e.screenWidth&&e.screenHeight?(r=e,console.log("   ‚úì Using annotation directly (has screen coordinates)")):(r=o.annotations.find(m=>m.id===e.id&&m.screenWidth&&m.screenHeight),r&&console.log("   ‚úì Found by annotation ID")),r||(r=o.annotations.find(m=>m.type!==e.type||!m.screenWidth||!m.screenHeight?!1:m.roomId===e.id||m.roomLocationId===e.id||m.cabinetRunId===e.id||m.cabinetId===e.id),r&&console.log(`   ‚úì Found by entity ID match for type: ${e.type}`)),!r){console.warn("‚ö†Ô∏è Annotation does not have valid screen coordinates yet, skipping zoom");return}const t=n.annotationOverlay;if(!t){console.warn("‚ö†Ô∏è Container not found for zoom calculation");return}const l=t.getBoundingClientRect(),a=l.width,c=l.height,d=.8,s=a*d/r.screenWidth,u=c*d/r.screenHeight;let f=Math.min(s,u);f=Math.max(o.zoomMin,Math.min(f,o.zoomMax)),await S(f,o,n,i),i.$nextTick&&await i.$nextTick(),await an(r,o,n),console.log(`‚úì Zoomed to ${Math.round(f*100)}% and centered annotation`)}async function an(e,o,n){var u;if(!((u=n.pdfEmbed)==null?void 0:u.querySelector("canvas"))){console.warn("‚ö†Ô∏è Canvas not found for centering");return}const r=n.annotationOverlay;if(!r)return;const t=r.getBoundingClientRect(),l=t.width,a=t.height;let c=W(r,"X"),d=W(r,"Y");const s={x:e.screenX+e.screenWidth/2,y:e.screenY+e.screenHeight/2};console.log("üìç Centering calculation:",{annoScreenPos:s,containerWidth:l,containerHeight:a,targetScrollLeft:s.x-l/2,targetScrollTop:s.y-a/2}),c.scrollLeft=s.x-l/2,d.scrollTop=s.y-a/2,console.log("üìç After scroll:",{actualScrollLeft:c.scrollLeft,actualScrollTop:d.scrollTop})}function W(e,o){let n=e.parentElement;for(;n&&n!==document.body;){const i=window.getComputedStyle(n),r=o==="X"?i.overflowX:i.overflowY,t=o==="X"?n.scrollWidth>n.clientWidth:n.scrollHeight>n.clientHeight;if((r==="auto"||r==="scroll")&&t)return n;n=n.parentElement}return document.documentElement||document.body}function cn(e){return e.zoomLevel<=e.zoomMin}function dn(e){return e.zoomLevel>=e.zoomMax}const Yn=Object.freeze(Object.defineProperty({__proto__:null,getZoomPercentage:tn,isAtMaxZoom:dn,isAtMinZoom:cn,resetZoom:nn,setZoom:S,zoomIn:en,zoomOut:on,zoomToFitAnnotation:ln},Symbol.toStringTag,{value:"Module"}));function sn(e,o=null,n,i){console.log(`üìê Switching to ${e} view${o?" ("+o+")":""}`),n.activeViewType=e,n.activeOrientation=o,e==="plan"&&(n.activeOrientation=null),i.updateAnnotationVisibility&&i.updateAnnotationVisibility(),console.log(`‚úì View switched to ${e}${o?" - "+o:""}`)}function un(e,o,n){console.log(`üß≠ Setting orientation to ${e}`),o.activeOrientation=e,n.updateAnnotationVisibility&&n.updateAnnotationVisibility()}function fn(e,o){const n=e.viewType||"plan";return o.activeViewType==="plan"?n==="plan":o.activeViewType===n?o.activeOrientation&&e.viewOrientation?e.viewOrientation===o.activeOrientation:!0:!1}function mn(e){console.log(`üîç Updating annotation visibility for ${e.activeViewType} view`)}function gn(e){return e.activeViewType==="plan"?"Plan View":e.activeViewType==="elevation"?`Elevation View${e.activeOrientation?` - ${e.activeOrientation.charAt(0).toUpperCase()+e.activeOrientation.slice(1)}`:""}`:e.activeViewType==="section"?`Section View${e.activeOrientation?` - ${e.activeOrientation}`:""}`:e.activeViewType==="detail"?`Detail View${e.activeOrientation?` - ${e.activeOrientation}`:""}`:"Unknown View"}function pn(e){return e.activeViewType==="plan"?"var(--primary-600)":e.activeViewType==="elevation"?"var(--warning-600)":e.activeViewType==="section"?"var(--info-600)":e.activeViewType==="detail"?"var(--success-600)":"var(--gray-600)"}const Vn=Object.freeze(Object.defineProperty({__proto__:null,getCurrentViewColor:pn,getCurrentViewLabel:gn,isAnnotationVisibleInView:fn,setOrientation:un,setViewType:sn,updateAnnotationVisibility:mn},Symbol.toStringTag,{value:"Module"}));function hn(e,o,n,i="primary",r){r.annotationReferences[e]||(r.annotationReferences[e]=[]),r.annotationReferences[e].some(l=>l.entity_type===o&&l.entity_id===n)||(r.annotationReferences[e].push({entity_type:o,entity_id:n,reference_type:i}),console.log(`‚úì Added ${i} reference: ${o} #${n} to annotation #${e}`))}function vn(e,o,n,i){i.annotationReferences[e]&&(i.annotationReferences[e]=i.annotationReferences[e].filter(r=>!(r.entity_type===o&&r.entity_id===n)),console.log(`‚úì Removed reference: ${o} #${n} from annotation #${e}`))}function O(e,o){return o.annotationReferences[e]||[]}function yn(e,o,n){return O(e,n).filter(r=>r.entity_type===o)}function wn(e,o,n,i){return O(e,i).some(t=>t.entity_type===o&&t.entity_id===n)}function In(e,o){if(o.annotationReferences[e]){const n=o.annotationReferences[e].length;delete o.annotationReferences[e],console.log(`‚úì Cleared ${n} references from annotation #${e}`)}}const Wn=Object.freeze(Object.defineProperty({__proto__:null,addEntityReference:hn,clearAnnotationReferences:In,getEntityReferences:O,getReferencesByType:yn,hasEntityReference:wn,removeEntityReference:vn},Symbol.toStringTag,{value:"Module"}));function jn(e,o,n){const i=T(o,n);if(!i)return"-top-10 left-0";const r=e.screenY,t=i.height-(e.screenY+e.screenHeight);e.screenX;const l=i.width-(e.screenX+e.screenWidth);return r>=40?"-top-10 left-0":t>=40?"-bottom-10 left-0":l>=100?"top-0 -right-2 translate-x-full":"top-0 -left-2 -translate-x-full"}function Qn(e,o,n){const i=T(o,n);if(!i)return"-top-7 right-0";const r=e.screenY;return i.width-(e.screenX+e.screenWidth),r>=30?"-top-7 right-0":"-bottom-7 right-0"}function Rn(e,o){const i=o.annotations.filter(t=>t.roomId===e).map(t=>t.id);i.some(t=>!o.hiddenAnnotations.includes(t))?i.forEach(t=>{o.hiddenAnnotations.includes(t)||o.hiddenAnnotations.push(t)}):o.hiddenAnnotations=o.hiddenAnnotations.filter(t=>!i.includes(t)),console.log(`üëÅÔ∏è Toggled room ${e} visibility`)}function bn(e,o){return o.annotations.filter(i=>i.roomId===e).some(i=>!o.hiddenAnnotations.includes(i.id))}function Sn(e,o){const i=o.annotations.filter(t=>t.type==="location"&&t.roomLocationId===e||t.locationId===e).map(t=>t.id);i.some(t=>!o.hiddenAnnotations.includes(t))?i.forEach(t=>{o.hiddenAnnotations.includes(t)||o.hiddenAnnotations.push(t)}):o.hiddenAnnotations=o.hiddenAnnotations.filter(t=>!i.includes(t)),console.log(`üëÅÔ∏è Toggled location ${e} visibility`)}function Ln(e,o){return o.annotations.filter(i=>i.type==="location"&&i.roomLocationId===e||i.locationId===e).some(i=>!o.hiddenAnnotations.includes(i.id))}function _n(e,o){const i=o.annotations.filter(t=>t.type==="cabinet_run"&&t.cabinetRunId===e||t.cabinetRunId===e).map(t=>t.id);i.some(t=>!o.hiddenAnnotations.includes(t))?i.forEach(t=>{o.hiddenAnnotations.includes(t)||o.hiddenAnnotations.push(t)}):o.hiddenAnnotations=o.hiddenAnnotations.filter(t=>!i.includes(t)),console.log(`üëÅÔ∏è Toggled cabinet run ${e} visibility`)}function zn(e,o){return o.annotations.filter(i=>i.type==="cabinet_run"&&i.cabinetRunId===e||i.cabinetRunId===e).some(i=>!o.hiddenAnnotations.includes(i.id))}function Nn(e,o){const n=o.hiddenAnnotations.indexOf(e);n>-1?(o.hiddenAnnotations.splice(n,1),console.log(`üëÅÔ∏è Showing annotation ${e}`)):(o.hiddenAnnotations.push(e),console.log(`üëÅÔ∏è Hiding annotation ${e}`))}function $n(e,o){return!o.hiddenAnnotations.includes(e)}function An(e,o,n){if(!n.annotations||n.annotations.length===0)return!1;let i;return o==="room"?i=n.annotations.filter(r=>r.roomId===e):o==="location"?i=n.annotations.filter(r=>r.type==="location"&&r.roomLocationId===e||r.locationId===e):o==="cabinet_run"&&(i=n.annotations.filter(r=>r.type==="cabinet_run"&&r.cabinetRunId===e||r.cabinetRunId===e)),i&&i.length>0}const Zn=Object.freeze(Object.defineProperty({__proto__:null,hasAnnotationsOnCurrentPage:An,isAnnotationVisible:$n,isCabinetRunVisible:zn,isLocationVisible:Ln,isRoomVisible:bn,toggleAnnotationVisibility:Nn,toggleCabinetRunVisibility:_n,toggleLocationVisibility:Sn,toggleRoomVisibility:Rn},Symbol.toStringTag,{value:"Module"}));export{ne as $,qo as A,Ko as B,Uo as C,Bo as D,Zo as E,Qo as F,Wo as G,Vo as H,Yo as I,Xo as J,Oo as K,ko as L,Ho as M,Do as N,Eo as O,ce as P,ae as Q,Mo as R,xo as S,Ao as T,le as U,H as V,re as W,bo as X,D as Y,E as Z,ie as _,jn as a,ho as a0,po as a1,go as a2,to as a3,no as a4,Je as a5,Ge as a6,qe as a7,Ke as a8,Ue as a9,Dn as aA,Xn as aB,kn as aC,Wn as aD,Vn as aE,Yn as aF,Zn as aG,Hn as aH,xn as aI,En as aJ,Pn as aK,Mn as aL,On as aM,Cn as aN,We as aa,Ve as ab,Ye as ac,Ee as ad,Pe as ae,Ce as af,xe as ag,T as ah,I as ai,p as aj,z as ak,we as al,ve as am,Tn as an,Io as ao,Se as ap,_o as aq,To as ar,$o as as,No as at,te as au,zo as av,se as aw,He as ax,De as ay,Fn as az,pn as b,me as c,_e as d,Ro as e,Fo as f,Qn as g,In as h,wn as i,yn as j,O as k,hn as l,gn as m,fn as n,un as o,sn as p,dn as q,vn as r,oo as s,cn as t,mn as u,tn as v,nn as w,on as x,en as y,ln as z};
