<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        // Main meeting transcripts table
        Schema::create('meeting_transcripts', function (Blueprint $table) {
            $table->id();
            $table->string('file_path');
            $table->string('title');
            $table->date('meeting_date')->nullable();
            $table->integer('duration_minutes')->nullable();
            $table->json('participants')->nullable();
            $table->enum('status', ['pending', 'processing', 'completed', 'failed'])->default('pending');
            $table->integer('total_sentences')->default(0);
            $table->text('summary')->nullable();
            $table->timestamps();

            $table->index('meeting_date');
            $table->index('status');
        });

        // Meeting segments (topic-based sections)
        Schema::create('meeting_segments', function (Blueprint $table) {
            $table->id();
            $table->foreignId('meeting_transcript_id')->constrained()->onDelete('cascade');
            $table->string('start_time'); // e.g., "00:04"
            $table->string('end_time'); // e.g., "05:30"
            $table->string('topic');
            $table->text('summary');
            $table->json('speakers');
            $table->integer('sentence_count')->default(0);
            $table->timestamps();

            $table->index('meeting_transcript_id');
            $table->index('topic');
        });

        // Meeting topics index
        Schema::create('meeting_topics', function (Blueprint $table) {
            $table->id();
            $table->foreignId('meeting_transcript_id')->constrained()->onDelete('cascade');
            $table->string('topic_name');
            $table->text('description')->nullable();
            $table->string('first_mention_time');
            $table->json('keywords')->nullable();
            $table->integer('mention_count')->default(1);
            $table->timestamps();

            $table->index('meeting_transcript_id');
            $table->index('topic_name');
        });

        // Action items extracted from meetings
        Schema::create('meeting_action_items', function (Blueprint $table) {
            $table->id();
            $table->foreignId('meeting_transcript_id')->constrained()->onDelete('cascade');
            $table->string('assignee')->nullable();
            $table->text('task');
            $table->date('due_date')->nullable();
            $table->enum('priority', ['low', 'medium', 'high'])->default('medium');
            $table->enum('status', ['pending', 'in_progress', 'completed', 'cancelled'])->default('pending');
            $table->string('mentioned_at_time');
            $table->text('context')->nullable();
            $table->timestamps();

            $table->index('meeting_transcript_id');
            $table->index('assignee');
            $table->index('status');
        });

        // Entities mentioned (people, projects, processes)
        Schema::create('meeting_entities', function (Blueprint $table) {
            $table->id();
            $table->foreignId('meeting_transcript_id')->constrained()->onDelete('cascade');
            $table->enum('entity_type', ['person', 'project', 'process', 'tool', 'location', 'other']);
            $table->string('entity_name');
            $table->integer('mentions_count')->default(1);
            $table->json('context_snippets')->nullable(); // Array of contexts where mentioned
            $table->timestamps();

            $table->index('meeting_transcript_id');
            $table->index('entity_type');
            $table->index('entity_name');
        });

        // Full-text searchable sentences
        Schema::create('meeting_sentences', function (Blueprint $table) {
            $table->id();
            $table->foreignId('meeting_transcript_id')->constrained()->onDelete('cascade');
            $table->foreignId('meeting_segment_id')->nullable()->constrained()->onDelete('cascade');
            $table->string('speaker_name');
            $table->integer('speaker_id');
            $table->string('start_time');
            $table->string('end_time');
            $table->text('sentence');
            $table->integer('sequence_number'); // Order in transcript
            $table->timestamps();

            $table->index('meeting_transcript_id');
            $table->index('meeting_segment_id');
            $table->index('speaker_name');
            $table->fullText('sentence'); // Full-text search index
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('meeting_sentences');
        Schema::dropIfExists('meeting_entities');
        Schema::dropIfExists('meeting_action_items');
        Schema::dropIfExists('meeting_topics');
        Schema::dropIfExists('meeting_segments');
        Schema::dropIfExists('meeting_transcripts');
    }
};
